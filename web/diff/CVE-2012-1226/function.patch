commit 8f9b9987ffb42cfbe907fe31ded3001bfc1b3417
Author: Regis Houssin <regis@dolibarr.fr>
Date:   Mon Feb 27 17:02:56 2012 +0100

    Fix: Multiple directory traversal vulnerabilities with document.php

diff --git a/htdocs/comm/action/document.php b/htdocs/comm/action/document.php
index da79ff4..88fa0f4 100755
--- a/htdocs/comm/action/document.php
+++ b/htdocs/comm/action/document.php
@@ -1,27 +1,27 @@
 <?php
 /* Copyright (C) 2003-2004 Rodolphe Quiedeville  <rodolphe@quiedeville.org>
  * Copyright (C) 2004-2010 Laurent Destailleur   <eldy@users.sourceforge.net>
  * Copyright (C) 2005      Marc Barilley / Ocebo <marc@ocebo.com>
- * Copyright (C) 2005-2009 Regis Houssin         <regis@dolibarr.fr>
+ * Copyright (C) 2005-2012 Regis Houssin         <regis@dolibarr.fr>
  * Copyright (C) 2005      Simon TOSSER          <simon@kornog-computing.com>
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation; either version 2 of the License, or
  * (at your option) any later version.
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
  *
  * You should have received a copy of the GNU General Public License
  * along with this program. If not, see <http://www.gnu.org/licenses/>.
  */
 
 /**
  *       \file       htdocs/comm/action/document.php
  *       \ingroup    agenda
  *       \brief      Page of documents linked to actions
  */
 
diff --git a/htdocs/comm/action/fiche.php b/htdocs/comm/action/fiche.php
index 85bb929..2951f70 100644
--- a/htdocs/comm/action/fiche.php
+++ b/htdocs/comm/action/fiche.php
@@ -1,27 +1,27 @@
 <?php
 /* Copyright (C) 2001-2005 Rodolphe Quiedeville <rodolphe@quiedeville.org>
  * Copyright (C) 2004-2012 Laurent Destailleur  <eldy@users.sourceforge.net>
  * Copyright (C) 2005      Simon TOSSER         <simon@kornog-computing.com>
- * Copyright (C) 2005-2011 Regis Houssin        <regis@dolibarr.fr>
+ * Copyright (C) 2005-2012 Regis Houssin        <regis@dolibarr.fr>
  * Copyright (C) 2010      Juanjo Menent        <jmenent@2byte.es>
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation; either version 2 of the License, or
  * (at your option) any later version.
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
  *
  * You should have received a copy of the GNU General Public License
  * along with this program. If not, see <http://www.gnu.org/licenses/>.
  */
 
 /**
  *       \file       htdocs/comm/action/fiche.php
  *       \ingroup    agenda
  *       \brief      Page for event card
  */
 
@@ -43,11 +43,12 @@ $langs->load("bills");
 $langs->load("orders");
 $langs->load("agenda");
 
-$action=GETPOST("action");
+$action=GETPOST('action','alpha');
+$backtopage=GETPOST('backtopage','alpha');
 
 // Security check
-$socid = GETPOST('socid');
-$id = GETPOST('id');
+$socid = GETPOST('socid','int');
+$id = GETPOST('id','int');
 if ($user->societe_id) $socid=$user->societe_id;
 //$result = restrictedArea($user, 'agenda', $id, 'actioncomm', 'actions', '', 'id');
 
@@ -65,173 +66,171 @@ $contact = new Contact($db);
 if ($action == 'add_action')
 {
 	$error=0;
 
-    $backtopage='';
-    if (! empty($_POST["backtopage"])) $backtopage=$_POST["backtopage"];
-    if (! $backtopage)
+    if (empty($backtopage))
     {
         if ($socid > 0) $backtopage = DOL_URL_ROOT.'/societe/agenda.php?socid='.$socid;
         else $backtopage=DOL_URL_ROOT.'/comm/action/index.php';
     }
 
     if ($_POST["contactid"])
 	{
 		$result=$contact->fetch($_POST["contactid"]);
 	}
 
 	if ($_POST['cancel'])
 	{
 		header("Location: ".$backtopage);
 		exit;
 	}
 
     $fulldayevent=$_POST["fullday"];
 
     // Clean parameters
 	$datep=dol_mktime($fulldayevent?'00':$_POST["aphour"], $fulldayevent?'00':$_POST["apmin"], 0, $_POST["apmonth"], $_POST["apday"], $_POST["apyear"]);
 	$datef=dol_mktime($fulldayevent?'23':$_POST["p2hour"], $fulldayevent?'59':$_POST["p2min"], $fulldayevent?'59':'0', $_POST["p2month"], $_POST["p2day"], $_POST["p2year"]);
 
 	// Check parameters
 	if (! $datef && $_POST["percentage"] == 100)
 	{
 		$error++;
 		$action = 'create';
 		$mesg='<div class="error">'.$langs->trans("ErrorFieldRequired",$langs->trans("DateEnd")).'</div>';
 	}
 
 	// Initialisation objet cactioncomm
 	if (! $_POST["actioncode"])
 	{
 		$error++;
 		$action = 'create';
 		$mesg='<div class="error">'.$langs->trans("ErrorFieldRequired",$langs->trans("Type")).'</div>';
 	}
 	else
 	{
 		$result=$cactioncomm->fetch($_POST["actioncode"]);
 	}
 
 	// Initialisation objet actioncomm
 	$actioncomm->type_id = $cactioncomm->id;
 	$actioncomm->type_code = $cactioncomm->code;
 	$actioncomm->priority = isset($_POST["priority"])?$_POST["priority"]:0;
 	$actioncomm->fulldayevent = $_POST["fullday"]?1:0;
 	$actioncomm->location = isset($_POST["location"])?$_POST["location"]:'';
 	$actioncomm->label = trim($_POST["label"]);
 	if (! $_POST["label"])
 	{
 		if ($_POST["actioncode"] == 'AC_RDV' && $contact->getFullName($langs))
 		{
 			$actioncomm->label = $langs->transnoentitiesnoconv("TaskRDVWith",$contact->getFullName($langs));
 		}
 		else
 		{
 			if ($langs->trans("Action".$actioncomm->type_code) != "Action".$actioncomm->type_code)
 			{
 				$actioncomm->label = $langs->transnoentitiesnoconv("Action".$actioncomm->type_code)."\n";
 			}
 			else $actioncomm->label = $cactioncomm->libelle;
 		}
 	}
 	$actioncomm->fk_project = isset($_POST["projectid"])?$_POST["projectid"]:0;
 	$actioncomm->datep = $datep;
 	$actioncomm->datef = $datef;
 	$actioncomm->percentage = isset($_POST["percentage"])?$_POST["percentage"]:0;
 	$actioncomm->duree=(($_POST["dureehour"] * 60) + $_POST["dureemin"]) * 60;
 
 	$usertodo=new User($db);
 	if ($_POST["affectedto"] > 0)
 	{
 		$usertodo->fetch($_POST["affectedto"]);
 	}
 	$actioncomm->usertodo = $usertodo;
 	$userdone=new User($db);
 	if ($_POST["doneby"] > 0)
 	{
 		$userdone->fetch($_POST["doneby"]);
 	}
 	$actioncomm->userdone = $userdone;
 
 	$actioncomm->note = trim($_POST["note"]);
 	if (isset($_POST["contactid"])) $actioncomm->contact = $contact;
 	if (GETPOST("socid") > 0)
 	{
 		$societe = new Societe($db);
 		$societe->fetch(GETPOST("socid"));
 		$actioncomm->societe = $societe;
 	}
 
 	// Special for module webcal and phenix
 	if ($_POST["add_webcal"] == 'on' && $conf->webcalendar->enabled) $actioncomm->use_webcal=1;
 	if ($_POST["add_phenix"] == 'on' && $conf->phenix->enabled) $actioncomm->use_phenix=1;
 
 	// Check parameters
 	if ($actioncomm->type_code == 'AC_RDV' && ($datep == '' || $datef == ''))
 	{
 		$error++;
 		$action = 'create';
 		$mesg='<div class="error">'.$langs->trans("ErrorFieldRequired",$langs->transnoentitiesnoconv("DateEnd")).'</div>';
 	}
 	if ($datea && $_POST["percentage"] == 0)
 	{
 		$error++;
 		$action = 'create';
 		$mesg='<div class="error">'.$langs->trans("ErrorStatusCantBeZeroIfStarted").'</div>';
 	}
 
 	if (! $_POST["apyear"] && ! $_POST["adyear"])
 	{
 		$error++;
 		$action = 'create';
 		$mesg='<div class="error">'.$langs->trans("ErrorFieldRequired",$langs->transnoentitiesnoconv("Date")).'</div>';
 	}
 
 	if (! $error)
 	{
 		$db->begin();
 
 		// On cree l'action
 		$idaction=$actioncomm->add($user);
 
 		if ($idaction > 0)
 		{
 			if (! $actioncomm->error)
 			{
 				$db->commit();
 				if (! empty($backtopage))
 				{
 					dol_syslog("Back to ".$backtopage);
 					Header("Location: ".$backtopage);
 				}
 				elseif($idaction)
 				{
 					Header("Location: ".DOL_URL_ROOT.'/comm/action/fiche.php?id='.$idaction);
 				}
 				else
 				{
 					Header("Location: ".DOL_URL_ROOT.'/comm/action/index.php');
 				}
 				exit;
 			}
 			else
 			{
 				// Si erreur
 				$db->rollback();
 				$id=$idaction;
 				$langs->load("errors");
 				$error=$langs->trans($actioncomm->error);
 			}
 		}
 		else
 		{
 			$db->rollback();
 			$id=$idaction;
 			$langs->load("errors");
 			$error=$langs->trans($actioncomm->error);
 		}
 	}
 }
 
 /*
  * Action suppression de l'action
  */
@@ -263,97 +262,92 @@ if ($action == 'confirm_delete' && GETPOST("confirm") == 'yes')
 if ($action == 'update')
 {
 	if (! $_POST["cancel"])
 	{
         $fulldayevent=$_POST["fullday"];
 
 	    // Clean parameters
 		if ($_POST["aphour"] == -1) $_POST["aphour"]='0';
 		if ($_POST["apmin"] == -1) $_POST["apmin"]='0';
 		if ($_POST["p2hour"] == -1) $_POST["p2hour"]='0';
 		if ($_POST["p2min"] == -1) $_POST["p2min"]='0';
 		//if ($_POST["adhour"] == -1) $_POST["adhour"]='0';
 		//if ($_POST["admin"] == -1) $_POST["admin"]='0';
 
 		$actioncomm = new Actioncomm($db);
 		$actioncomm->fetch($id);
 
 		$datep=dol_mktime($fulldayevent?'00':$_POST["aphour"], $fulldayevent?'00':$_POST["apmin"], 0, $_POST["apmonth"], $_POST["apday"], $_POST["apyear"]);
 		$datef=dol_mktime($fulldayevent?'23':$_POST["p2hour"], $fulldayevent?'59':$_POST["p2min"], $fulldayevent?'59':'0', $_POST["p2month"], $_POST["p2day"], $_POST["p2year"]);
 
 		$actioncomm->label       = $_POST["label"];
 		$actioncomm->datep       = $datep;
 		$actioncomm->datef       = $datef;
 		//$actioncomm->date        = $datea;
 		//$actioncomm->dateend     = $datea2;
 		$actioncomm->percentage  = $_POST["percentage"];
 		$actioncomm->priority    = $_POST["priority"];
         $actioncomm->fulldayevent= $_POST["fullday"]?1:0;
 		$actioncomm->location    = isset($_POST["location"])?$_POST["location"]:'';
 		$actioncomm->societe->id = $_POST["socid"];
 		$actioncomm->contact->id = $_POST["contactid"];
 		$actioncomm->fk_project  = $_POST["projectid"];
 		$actioncomm->note        = $_POST["note"];
 		$actioncomm->pnote       = $_POST["note"];
 
 		if (! $datef && $_POST["percentage"] == 100)
 		{
 			$error=$langs->trans("ErrorFieldRequired",$langs->trans("DateEnd"));
 			$action = 'edit';
 		}
 
 		// Users
 		$usertodo=new User($db);
 		if ($_POST["affectedto"])
 		{
 			$usertodo->fetch($_POST["affectedto"]);
 		}
 		$actioncomm->usertodo = $usertodo;
 		$userdone=new User($db);
 		if ($_POST["doneby"])
 		{
 			$userdone->fetch($_POST["doneby"]);
 		}
 		$actioncomm->userdone = $userdone;
 
 		if (! $error)
 		{
 			$db->begin();
 
 			$result=$actioncomm->update($user);
 
 			if ($result > 0)
 			{
 				$db->commit();
 			}
 			else
 			{
 				$db->rollback();
 			}
 		}
 	}
 
 	if ($result < 0)
 	{
 		$langs->load("errors");
 		$mesg='<div class="error">'.$langs->trans($actioncomm->error).'</div>';
 	}
 	else
 	{
-		if (! empty($_POST["from"]))  // deprecated. Use backtopage instead
-		{
-			header("Location: ".$_POST["from"]);
-			exit;
-		}
-        if (! empty($_POST["backtopage"]))
+        if (! empty($backtopage))
         {
-            header("Location: ".$_POST["backtopage"]);
+            header("Location: ".$backtopage);
             exit;
         }
 	}
 }
 
 
 /*
  * View
  */
 
@@ -367,620 +361,620 @@ $htmlactions = new FormActions($db);
 if ($action == 'create')
 {
 	$contact = new Contact($db);
 
 	if (GETPOST("contactid"))
 	{
 		$result=$contact->fetch(GETPOST("contactid"));
 		if ($result < 0) dol_print_error($db,$contact->error);
 	}
 
     if ($conf->use_javascript_ajax)
     {
         print "\n".'<script type="text/javascript" language="javascript">';
         print 'jQuery(document).ready(function () {
                      function setdatefields()
                      {
                             if (jQuery("#fullday:checked").val() == null)
                             {
                                 jQuery(".fulldaystarthour").attr(\'disabled\', false);
                                 jQuery(".fulldaystartmin").attr(\'disabled\', false);
                                 jQuery(".fulldayendhour").attr(\'disabled\', false);
                                 jQuery(".fulldayendmin").attr(\'disabled\', false);
                             }
                             else
                             {
                                 jQuery(".fulldaystarthour").attr(\'disabled\', true);
                                 jQuery(".fulldaystartmin").attr(\'disabled\', true);
                                 jQuery(".fulldayendhour").attr(\'disabled\', true);
                                 jQuery(".fulldayendmin").attr(\'disabled\', true);
                                 jQuery(".fulldaystarthour").val("00");
                                 jQuery(".fulldaystartmin").val("00");
                                 //jQuery(".fulldayendhour").val("00");
                                 //jQuery(".fulldayendmin").val("00");
                                 jQuery(".fulldayendhour").val("23");
                                 jQuery(".fulldayendmin").val("59");
                         }
                     }
                     setdatefields();
                     jQuery("#fullday").change(function() {
                         setdatefields();
                     });
                     jQuery("#selectcomplete").change(function() {
                         if (jQuery("#selectcomplete").val() == 100)
                         {
                             if (jQuery("#doneby").val() <= 0) jQuery("#doneby").val(\''.$user->id.'\');
                         }
                         if (jQuery("#selectcomplete").val() == 0)
                         {
                             jQuery("#doneby").val(-1);
                         }
                    });
                    jQuery("#actioncode").change(function() {
                         if (jQuery("#actioncode").val() == \'AC_RDV\') jQuery("#dateend").addClass("fieldrequired");
                         else jQuery("#dateend").removeClass("fieldrequired");
                    });
                })';
         print '</script>'."\n";
     }
 
 	print '<form name="formaction" action="'.DOL_URL_ROOT.'/comm/action/fiche.php" method="POST">';
 	print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
 	print '<input type="hidden" name="action" value="add_action">';
-	if (GETPOST("backtopage")) print '<input type="hidden" name="backtopage" value="'.(GETPOST("backtopage") != 1 ? GETPOST("backtopage") : $_SERVER["HTTP_REFERER"]).'">';
+	print '<input type="hidden" name="backtopage" value="'.(! empty($backtopage) ? $backtopage : $_SERVER["HTTP_REFERER"]).'">';
 
 	if (GETPOST("actioncode") == 'AC_RDV') print_fiche_titre($langs->trans("AddActionRendezVous"));
 	else print_fiche_titre($langs->trans("AddAnAction"));
 
 	dol_htmloutput_mesg($mesg);
 
 	print '<table class="border" width="100%">';
 
 	// Type d'action actifs
 	print '<tr><td width="30%"><span class="fieldrequired">'.$langs->trans("Type").'</span></b></td><td>';
 	if (GETPOST("actioncode"))
 	{
 		print '<input type="hidden" name="actioncode" value="'.GETPOST("actioncode").'">'."\n";
 		$cactioncomm->fetch(GETPOST("actioncode"));
 		print $cactioncomm->getNomUrl();
 	}
 	else
 	{
 		$htmlactions->select_type_actions($actioncomm->type_code, "actioncode");
 	}
 	print '</td></tr>';
 
 	// Title
 	print '<tr><td>'.$langs->trans("Title").'</td><td><input type="text" name="label" size="60" value="'.GETPOST('label').'"></td></tr>';
 
     // Full day
     print '<tr><td>'.$langs->trans("EventOnFullDay").'</td><td><input type="checkbox" id="fullday" name="fullday" '.(GETPOST('fullday')?' checked="checked"':'').'></td></tr>';
 
 	// Date start
 	$datep=$actioncomm->datep;
 	if (GETPOST('datep','int',1)) $datep=dol_stringtotime(GETPOST('datep','int',1),0);
 	print '<tr><td width="30%" nowrap="nowrap"><span class="fieldrequired">'.$langs->trans("DateActionStart").'</span></td><td>';
 	if (GETPOST("afaire") == 1) $form->select_date($datep,'ap',1,1,0,"action",1,1,0,0,'fulldayend');
 	else if (GETPOST("afaire") == 2) $form->select_date($datep,'ap',1,1,1,"action",1,1,0,0,'fulldayend');
 	else $form->select_date($datep,'ap',1,1,1,"action",1,1,0,0,'fulldaystart');
 	print '</td></tr>';
 	// Date end
 	$datef=$actioncomm->datef;
     if (GETPOST('datef','int',1)) $datef=dol_stringtotime(GETPOST('datef','int',1),0);
 	print '<tr><td><span id="dateend"'.(GETPOST("actioncode") == 'AC_RDV'?' class="fieldrequired"':'').'>'.$langs->trans("DateActionEnd").'</span></td><td>';
 	if (GETPOST("afaire") == 1) $form->select_date($datef,'p2',1,1,1,"action",1,1,0,0,'fulldayend');
 	else if (GETPOST("afaire") == 2) $form->select_date($datef,'p2',1,1,1,"action",1,1,0,0,'fulldayend');
 	else $form->select_date($datef,'p2',1,1,1,"action",1,1,0,0,'fulldayend');
 	print '</td></tr>';
 
 	// Status
 	print '<tr><td width="10%">'.$langs->trans("Status").' / '.$langs->trans("Percentage").'</td>';
 	print '<td>';
 	$percent=-1;
 	if (isset($_GET['percentage']) || isset($_POST['percentage']))
 	{
 		$percent=GETPOST('percentage');
 	}
 	else
 	{
 		if (GETPOST("afaire") == 1) $percent=0;
 		if (GETPOST("afaire") == 2) $percent=100;
 	}
 	print $htmlactions->form_select_status_action('formaction',$percent,1,'complete');
 	print '</td></tr>';
 
     // Location
     print '<tr><td>'.$langs->trans("Location").'</td><td colspan="3"><input type="text" name="location" size="50" value="'.$act->location.'"></td></tr>';
 
 	print '</table>';
 
 	print '<br><br>';
 
 	print '<table class="border" width="100%">';
 
 	// Affected by
 	$var=false;
 	print '<tr><td width="30%" nowrap="nowrap">'.$langs->trans("ActionAffectedTo").'</td><td>';
 	$form->select_users(GETPOST("affectedto")?GETPOST("affectedto"):($actioncomm->usertodo->id > 0 ? $actioncomm->usertodo : $user),'affectedto',1);
 	print '</td></tr>';
 
 	// Realised by
 	print '<tr><td nowrap>'.$langs->trans("ActionDoneBy").'</td><td>';
 	$form->select_users(GETPOST("doneby")?GETPOST("doneby"):($percent==100?$actioncomm->userdone:0),'doneby',1);
 	print '</td></tr>';
 
 	print '</table>';
 	print '<br><br>';
 	print '<table class="border" width="100%">';
 
 	// Societe, contact
 	print '<tr><td width="30%" nowrap="nowrap">'.$langs->trans("ActionOnCompany").'</td><td>';
 	if (GETPOST("socid") > 0)
 	{
 		$societe = new Societe($db);
 		$societe->fetch(GETPOST("socid"));
 		print $societe->getNomUrl(1);
 		print '<input type="hidden" name="socid" value="'.GETPOST("socid").'">';
 	}
 	else
 	{
 		print $form->select_company('','socid','',1,1);
 	}
 	print '</td></tr>';
 
 	// If company is forced, we propose contacts (may be contact is also forced)
 	if (GETPOST("contactid") > 0 || GETPOST("socid") > 0)
 	{
 		print '<tr><td nowrap>'.$langs->trans("ActionOnContact").'</td><td>';
 		$form->select_contacts(GETPOST("socid"),GETPOST('contactid'),'contactid',1);
 		print '</td></tr>';
 	}
 
 	// Project
 	if ($conf->projet->enabled)
 	{
 		// Projet associe
 		$langs->load("project");
 
 		print '<tr><td valign="top">'.$langs->trans("Project").'</td><td>';
 		$numproject=select_projects($societe->id,GETPOST("projectid")?GETPOST("projectid"):$projectid,'projectid');
 		if ($numproject==0)
 		{
 			print ' &nbsp; <a href="../../projet/fiche.php?socid='.$societe->id.'&action=create">'.$langs->trans("AddProject").'</a>';
 		}
 		print '</td></tr>';
 	}
 
 	if (GETPOST("datep") && preg_match('/^([0-9][0-9][0-9][0-9])([0-9][0-9])([0-9][0-9])$/',GETPOST("datep"),$reg))
 	{
 		$actioncomm->datep=dol_mktime(0,0,0,$reg[2],$reg[3],$reg[1]);
 	}
 
 	// Priority
 	print '<tr><td nowrap>'.$langs->trans("Priority").'</td><td colspan="3">';
 	print '<input type="text" name="priority" value="'.($_POST["priority"]?$_POST["priority"]:($actioncomm->priority?$actioncomm->priority:'')).'" size="5">';
 	print '</td></tr>';
 
 	add_row_for_calendar_link();
 
     // Description
     print '<tr><td valign="top">'.$langs->trans("Description").'</td><td>';
     require_once(DOL_DOCUMENT_ROOT."/core/class/doleditor.class.php");
     $doleditor=new DolEditor('note',($_POST["note"]?$_POST["note"]:$actioncomm->note),'',280,'dolibarr_notes','In',true,true,$conf->fckeditor->enabled,ROWS_7,90);
     $doleditor->Create();
     print '</td></tr>';
 
 	print '</table>';
 
 	print '<center><br>';
 	print '<input type="submit" class="button" value="'.$langs->trans("Add").'">';
 	print ' &nbsp; &nbsp; ';
 	print '<input type="submit" class="button" name="cancel" value="'.$langs->trans("Cancel").'">';
 	print '</center>';
 
 	print "</form>";
 }
 
 // View or edit
 if ($id)
 {
 	if ($error)
 	{
 		dol_htmloutput_errors($error);
 	}
 	if ($mesg)
 	{
 		dol_htmloutput_mesg($mesg);
 	}
 
 	$act = new ActionComm($db);
 	$result=$act->fetch($id);
 	if ($result < 0)
 	{
 		dol_print_error($db,$act->error);
 		exit;
 	}
 
 	$societe = new Societe($db);
 	if ($act->societe->id)
 	{
 		$result=$societe->fetch($act->societe->id);
 	}
 	$act->societe = $societe;
 
 	if ($act->author->id > 0)   { $tmpuser=new User($db); $res=$tmpuser->fetch($act->author->id); $act->author=$tmpuser; }
 	if ($act->usermod->id > 0)  { $tmpuser=new User($db); $res=$tmpuser->fetch($act->usermod->id); $act->usermod=$tmpuser; }
 	if ($act->usertodo->id > 0) { $tmpuser=new User($db); $res=$tmpuser->fetch($act->usertodo->id); $act->usertodo=$tmpuser; }
 	if ($act->userdone->id > 0) { $tmpuser=new User($db); $res=$tmpuser->fetch($act->userdone->id); $act->userdone=$tmpuser; }
 
 	$contact = new Contact($db);
 	if ($act->contact->id)
 	{
 		$result=$contact->fetch($act->contact->id,$user);
 	}
 	$act->contact = $contact;
 
 	/*
 	 * Affichage onglets
 	 */
 
 	$head=actions_prepare_head($act);
 	dol_fiche_head($head, 'card', $langs->trans("Action"),0,'action');
 
 	$now=dol_now();
 	$delay_warning=$conf->global->MAIN_DELAY_ACTIONS_TODO*24*60*60;
 
 	// Confirmation suppression action
 	if ($action == 'delete')
 	{
 		$ret=$form->form_confirm("fiche.php?id=".$id,$langs->trans("DeleteAction"),$langs->trans("ConfirmDeleteAction"),"confirm_delete",'','',1);
 		if ($ret == 'html') print '<br>';
 	}
 
 	if ($action == 'edit')
 	{
 	    if ($conf->use_javascript_ajax)
         {
             print "\n".'<script type="text/javascript" language="javascript">';
             print 'jQuery(document).ready(function () {
                          function setdatefields()
                          {
                                 if (jQuery("#fullday:checked").val() == null)
                                 {
                                     jQuery(".fulldaystarthour").attr(\'disabled\', false);
                                     jQuery(".fulldaystartmin").attr(\'disabled\', false);
                                     jQuery(".fulldayendhour").attr(\'disabled\', false);
                                     jQuery(".fulldayendmin").attr(\'disabled\', false);
                                 }
                                 else
                                 {
                                     jQuery(".fulldaystarthour").attr(\'disabled\', true);
                                     jQuery(".fulldaystartmin").attr(\'disabled\', true);
                                     jQuery(".fulldayendhour").attr(\'disabled\', true);
                                     jQuery(".fulldayendmin").attr(\'disabled\', true);
                                     jQuery(".fulldaystarthour").val("00");
                                     jQuery(".fulldaystartmin").val("00");
                                     //jQuery(".fulldayendhour").val("00");
                                     //jQuery(".fulldayendmin").val("00");
                                     jQuery(".fulldayendhour").val("23");
                                     jQuery(".fulldayendmin").val("59");
                             }
                         }
                         setdatefields();
                         jQuery("#fullday").change(function() {
                             setdatefields();
                         });
                    })';
             print '</script>'."\n";
         }
 
         // Fiche action en mode edition
 		print '<form name="formaction" action="'.DOL_URL_ROOT.'/comm/action/fiche.php" method="post">';
 		print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
 		print '<input type="hidden" name="action" value="update">';
 		print '<input type="hidden" name="id" value="'.$id.'">';
 		print '<input type="hidden" name="ref_ext" value="'.$act->ref_ext.'">';
-		if (GETPOST("backtopage")) print '<input type="hidden" name="backtopage" value="'.(GETPOST("backtopage") ? GETPOST("backtopage") : $_SERVER["HTTP_REFERER"]).'">';
+		print '<input type="hidden" name="backtopage" value="'.(! empty($backtopage) ? $backtopage : $_SERVER["HTTP_REFERER"]).'">';
 
 		print '<table class="border" width="100%">';
 
 		// Ref
 		print '<tr><td width="30%">'.$langs->trans("Ref").'</td><td colspan="3">'.$act->id.'</td></tr>';
 
 		// Type
 		print '<tr><td class="fieldrequired">'.$langs->trans("Type").'</td><td colspan="3">'.$act->type.'</td></tr>';
 
 		// Title
 		print '<tr><td>'.$langs->trans("Title").'</td><td colspan="3"><input type="text" name="label" size="50" value="'.$act->label.'"></td></tr>';
 
         // Full day event
         print '<tr><td>'.$langs->trans("EventOnFullDay").'</td><td colspan="3"><input type="checkbox" id="fullday" name="fullday" '.($act->fulldayevent?' checked="checked"':'').'></td></tr>';
 
 		// Date start
 		print '<tr><td nowrap="nowrap" class="fieldrequired">'.$langs->trans("DateActionStart").'</td><td colspan="3">';
 		if (GETPOST("afaire") == 1) $form->select_date($act->datep,'ap',1,1,0,"action",1,1,0,0,'fulldaystart');
 		else if (GETPOST("afaire") == 2) $form->select_date($act->datep,'ap',1,1,1,"action",1,1,0,0,'fulldaystart');
 		else $form->select_date($act->datep,'ap',1,1,1,"action",1,1,0,0,'fulldaystart');
 		print '</td></tr>';
 		// Date end
 		print '<tr><td>'.$langs->trans("DateActionEnd").'</td><td colspan="3">';
 		if (GETPOST("afaire") == 1) $form->select_date($act->datef,'p2',1,1,1,"action",1,1,0,0,'fulldayend');
 		else if (GETPOST("afaire") == 2) $form->select_date($act->datef,'p2',1,1,1,"action",1,1,0,0,'fulldayend');
 		else $form->select_date($act->datef,'p2',1,1,1,"action",1,1,0,0,'fulldayend');
 		print '</td></tr>';
 
 		// Status
 		print '<tr><td nowrap>'.$langs->trans("Status").' / '.$langs->trans("Percentage").'</td><td colspan="3">';
 		$percent=GETPOST("percentage")?GETPOST("percentage"):$act->percentage;
 		print $htmlactions->form_select_status_action('formaction',$percent,1);
 		print '</td></tr>';
 
         // Location
         print '<tr><td>'.$langs->trans("Location").'</td><td colspan="3"><input type="text" name="location" size="50" value="'.$act->location.'"></td></tr>';
 
 		print '</table><br><br><table class="border" width="100%">';
 
 		// Input by
 		$var=false;
 		print '<tr><td width="30%" nowrap="nowrap">'.$langs->trans("ActionAskedBy").'</td><td colspan="3">';
 		print $act->author->getNomUrl(1);
 		print '</td></tr>';
 
 		// Affected to
 		print '<tr><td nowrap="nowrap">'.$langs->trans("ActionAffectedTo").'</td><td colspan="3">';
 		print $form->select_dolusers($act->usertodo->id>0?$act->usertodo->id:-1,'affectedto',1);
 		print '</td></tr>';
 
 		// Realised by
 		print '<tr><td nowrap="nowrap">'.$langs->trans("ActionDoneBy").'</td><td colspan="3">';
 		print $form->select_dolusers($act->userdone->id> 0?$act->userdone->id:-1,'doneby',1);
 		print '</td></tr>';
 
 		print '</table><br><br>';
 
 		print '<table class="border" width="100%">';
 
 		// Company
 		print '<tr><td width="30%">'.$langs->trans("ActionOnCompany").'</td>';
 		print '<td>';
 		print $form->select_company($act->societe->id,'socid','',1,1);
 		print '</td>';
 
 		// Contact
 		print '<td>'.$langs->trans("Contact").'</td><td width="30%">';
 		print $form->selectarray("contactid",  $act->societe->contact_array(), $act->contact->id, 1);
 		print '</td></tr>';
 
 		// Project
 		if ($conf->projet->enabled)
 		{
 			// Projet associe
 			$langs->load("project");
 
 			print '<tr><td valign="top">'.$langs->trans("Project").'</td><td colspan="3">';
 			$numprojet=select_projects($act->societe->id,$act->fk_project,'projectid');
 			if ($numprojet==0)
 			{
 				print ' &nbsp; <a href="../../projet/fiche.php?socid='.$societe->id.'&action=create">'.$langs->trans("AddProject").'</a>';
 			}
 			print '</td></tr>';
 		}
 
 		// Priority
 		print '<tr><td nowrap>'.$langs->trans("Priority").'</td><td colspan="3">';
 		print '<input type="text" name="priority" value="'.($act->priority?$act->priority:'').'" size="5">';
 		print '</td></tr>';
 
 		// Object linked
 		if (! empty($act->fk_element) && ! empty($act->elementtype))
 		{
 			print '<tr><td>'.$langs->trans("LinkedObject").'</td>';
 			print '<td colspan="3">'.$act->getElementUrl($act->fk_element,$act->elementtype,1).'</td></tr>';
 		}
 
         // Description
         print '<tr><td valign="top">'.$langs->trans("Description").'</td><td colspan="3">';
         // Editeur wysiwyg
         require_once(DOL_DOCUMENT_ROOT."/core/class/doleditor.class.php");
         $doleditor=new DolEditor('note',$act->note,'',240,'dolibarr_notes','In',true,true,$conf->fckeditor->enabled,ROWS_5,90);
         $doleditor->Create();
         print '</td></tr>';
 
 		print '</table>';
 
 		print '<center><br><input type="submit" class="button" name="edit" value="'.$langs->trans("Save").'">';
 		print ' &nbsp; &nbsp; <input type="submit" class="button" name="cancel" value="'.$langs->trans("Cancel").'">';
 		print '</center>';
 
 		print '</form>';
 	}
 	else
 	{
 		// Affichage fiche action en mode visu
 		print '<table class="border" width="100%">';
 
 		// Ref
 		print '<tr><td width="30%">'.$langs->trans("Ref").'</td><td colspan="3">';
 		print $form->showrefnav($act,'id','',($user->societe_id?0:1),'id','ref','');
 		print '</td></tr>';
 
 		// Type
 		print '<tr><td>'.$langs->trans("Type").'</td><td colspan="3">'.$act->type.'</td></tr>';
 
 		// Title
 		print '<tr><td>'.$langs->trans("Title").'</td><td colspan="3">'.$act->label.'</td></tr>';
 
         // Full day event
         print '<tr><td>'.$langs->trans("EventOnFullDay").'</td><td colspan="3">'.yn($act->fulldayevent).'</td></tr>';
 
 		// Date start
 		print '<tr><td width="30%">'.$langs->trans("DateActionStart").'</td><td colspan="2">';
 		if (! $act->fulldayevent) print dol_print_date($act->datep,'dayhour');
 		else print dol_print_date($act->datep,'day');
 		if ($act->percentage == 0 && $act->datep && $act->datep < ($now - $delay_warning)) print img_warning($langs->trans("Late"));
 		print '</td>';
 		print '<td rowspan="3" align="center" valign="middle" width="180">'."\n";
         print '<form name="listactionsfiltermonth" action="'.DOL_URL_ROOT.'/comm/action/index.php" method="POST">';
         print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
         print '<input type="hidden" name="action" value="show_month">';
         print '<input type="hidden" name="year" value="'.dol_print_date($act->datep,'%Y').'">';
         print '<input type="hidden" name="month" value="'.dol_print_date($act->datep,'%m').'">';
         print '<input type="hidden" name="day" value="'.dol_print_date($act->datep,'%d').'">';
         //print '<input type="hidden" name="day" value="'.dol_print_date($act->datep,'%d').'">';
         print img_picto($langs->trans("ViewCal"),'object_calendar').' <input type="submit" style="width: 120px" class="button" name="viewcal" value="'.$langs->trans("ViewCal").'">';
         print '</form>'."\n";
         print '<form name="listactionsfilterweek" action="'.DOL_URL_ROOT.'/comm/action/index.php" method="POST">';
         print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
         print '<input type="hidden" name="action" value="show_week">';
         print '<input type="hidden" name="year" value="'.dol_print_date($act->datep,'%Y').'">';
         print '<input type="hidden" name="month" value="'.dol_print_date($act->datep,'%m').'">';
         print '<input type="hidden" name="day" value="'.dol_print_date($act->datep,'%d').'">';
         //print '<input type="hidden" name="day" value="'.dol_print_date($act->datep,'%d').'">';
         print img_picto($langs->trans("ViewCal"),'object_calendarweek').' <input type="submit" style="width: 120px" class="button" name="viewweek" value="'.$langs->trans("ViewWeek").'">';
         print '</form>'."\n";
         print '<form name="listactionsfilterday" action="'.DOL_URL_ROOT.'/comm/action/index.php" method="POST">';
         print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
         print '<input type="hidden" name="action" value="show_day">';
         print '<input type="hidden" name="year" value="'.dol_print_date($act->datep,'%Y').'">';
         print '<input type="hidden" name="month" value="'.dol_print_date($act->datep,'%m').'">';
         print '<input type="hidden" name="day" value="'.dol_print_date($act->datep,'%d').'">';
         //print '<input type="hidden" name="day" value="'.dol_print_date($act->datep,'%d').'">';
         print img_picto($langs->trans("ViewCal"),'object_calendarday').' <input type="submit" style="width: 120px" class="button" name="viewday" value="'.$langs->trans("ViewDay").'">';
         print '</form>'."\n";
         print '</td>';
 		print '</tr>';
 
 		// Date end
 		print '<tr><td>'.$langs->trans("DateActionEnd").'</td><td colspan="2">';
         if (! $act->fulldayevent) print dol_print_date($act->datef,'dayhour');
 		else print dol_print_date($act->datef,'day');
 		if ($act->percentage > 0 && $act->percentage < 100 && $act->datef && $act->datef < ($now- $delay_warning)) print img_warning($langs->trans("Late"));
 		print '</td></tr>';
 
 		// Status
 		print '<tr><td nowrap>'.$langs->trans("Status").' / '.$langs->trans("Percentage").'</td><td colspan="2">';
 		print $act->getLibStatut(4);
 		print '</td></tr>';
 
         // Location
         print '<tr><td>'.$langs->trans("Location").'</td><td colspan="3">'.$act->location.'</td></tr>';
 
 		print '</table><br><br><table class="border" width="100%">';
 
 		// Input by
 		$var=false;
 		print '<tr><td width="30%" nowrap="nowrap">'.$langs->trans("ActionAskedBy").'</td><td colspan="3">';
 		if ($act->author->id > 0) print $act->author->getNomUrl(1);
 		else print '&nbsp;';
 		print '</td></tr>';
 
 		// Affecte a
 		print '<tr><td nowrap="nowrap">'.$langs->trans("ActionAffectedTo").'</td><td colspan="3">';
 		if ($act->usertodo->id > 0) print $act->usertodo->getNomUrl(1);
 		print '</td></tr>';
 
 		// Done by
 		print '<tr><td nowrap="nowrap">'.$langs->trans("ActionDoneBy").'</td><td colspan="3">';
 		if ($act->userdone->id > 0) print $act->userdone->getNomUrl(1);
 		print '</td></tr>';
 
 		print '</table><br><br><table class="border" width="100%">';
 
 		// Third party - Contact
 		print '<tr><td width="30%">'.$langs->trans("ActionOnCompany").'</td><td>'.($act->societe->id?$act->societe->getNomUrl(1):$langs->trans("None"));
 		if ($act->societe->id && $act->type_code == 'AC_TEL')
 		{
 			if ($act->societe->fetch($act->societe->id))
 			{
 				print "<br>".dol_print_phone($act->societe->tel);
 			}
 		}
 		print '</td>';
 		print '<td>'.$langs->trans("Contact").'</td>';
 		print '<td>';
 		if ($act->contact->id > 0)
 		{
 			print $act->contact->getNomUrl(1);
 			if ($act->contact->id && $act->type_code == 'AC_TEL')
 			{
 				if ($act->contact->fetch($act->contact->id))
 				{
 					print "<br>".dol_print_phone($act->contact->phone_pro);
 				}
 			}
 		}
 		else
 		{
 			print $langs->trans("None");
 		}
 
 		print '</td></tr>';
 
 		// Project
 		if ($conf->projet->enabled)
 		{
 			print '<tr><td valign="top">'.$langs->trans("Project").'</td><td colspan="3">';
 			if ($act->fk_project)
 			{
 				$project=new Project($db);
 				$project->fetch($act->fk_project);
 				print $project->getNomUrl(1);
 			}
 			print '</td></tr>';
 		}
 
 		// Priority
 		print '<tr><td nowrap>'.$langs->trans("Priority").'</td><td colspan="3">';
 		print ($act->priority?$act->priority:'');
 		print '</td></tr>';
 
 		// Object linked
 		if (! empty($act->fk_element) && ! empty($act->elementtype))
 		{
 			print '<tr><td>'.$langs->trans("LinkedObject").'</td>';
 			print '<td colspan="3">'.$act->getElementUrl($act->fk_element,$act->elementtype,1).'</td></tr>';
 		}
 
 		// Description
 		print '<tr><td valign="top">'.$langs->trans("Description").'</td><td colspan="3">';
 		print dol_htmlentitiesbr($act->note);
 		print '</td></tr>';
 
 		print '</table>';
 	}
 
 	print "</div>\n";
 
 
 	/*
 	 * Barre d'actions
 	 *
 	 */
 
 	print '<div class="tabsAction">';
 
 	if ($action != 'edit')
 	{
 		if ($user->rights->agenda->allactions->create ||
 		   (($act->author->id == $user->id || $act->usertodo->id == $user->id) && $user->rights->agenda->myactions->create))
 		{
 			print '<a class="butAction" href="fiche.php?action=edit&id='.$act->id.'">'.$langs->trans("Modify").'</a>';
 		}
 		else
 		{
 			print '<a class="butActionRefused" href="#" title="'.$langs->trans("NotAllowed").'">'.$langs->trans("Modify").'</a>';
 		}
 
 		if ($user->rights->agenda->allactions->delete ||
 		   (($act->author->id == $user->id || $act->usertodo->id == $user->id) && $user->rights->agenda->myactions->delete))
 		{
 			print '<a class="butActionDelete" href="fiche.php?action=delete&id='.$act->id.'">'.$langs->trans("Delete").'</a>';
 		}
 		else
 		{
 			print '<a class="butActionRefused" href="#" title="'.$langs->trans("NotAllowed").'">'.$langs->trans("Delete").'</a>';
 		}
 	}
 
 	print '</div>';
 }
 
diff --git a/htdocs/comm/remise.php b/htdocs/comm/remise.php
index abfb500..b124a83 100644
--- a/htdocs/comm/remise.php
+++ b/htdocs/comm/remise.php
@@ -30,51 +30,53 @@ $langs->load("companies");
 $langs->load("orders");
 $langs->load("bills");
 
-$socid = GETPOST("id");
+$socid = GETPOST('id','int');
 // Security check
 if ($user->societe_id > 0)
 {
 	$socid = $user->societe_id;
 }
 
+$backtopage = GETPOST('backtopage','alpha');
+
 
 /*
  * Actions
  */
 
-if (GETPOST('cancel') && GETPOST('backtopage'))
+if (GETPOST('cancel') && ! empty($backtopage))
 {
-     Header("Location: ".GETPOST("backtopage"));
+     Header("Location: ".$backtopage);
      exit;
 }
 
 if (GETPOST("action") == 'setremise')
 {
 	$soc = New Societe($db);
 	$soc->fetch($_GET["id"]);
 	$result=$soc->set_remise_client($_POST["remise"],$_POST["note"],$user);
 
 	if ($result > 0)
 	{
-	    if (GETPOST('backtopage'))
+	    if (! empty($backtopage))
 	    {
-    		Header("Location: ".GETPOST('backtopage'));
+    		Header("Location: ".$backtopage);
     		exit;
 	    }
 	    else
 	    {
     		Header("Location: remise.php?id=".$_GET["id"]);
     		exit;
 	    }
 	}
 	else
 	{
 		$errmesg=$soc->error;
 	}
 }
 
 
 /*
  * View
  */
 
@@ -91,110 +93,110 @@ llxHeader();
 if ($socid > 0)
 {
 	// On recupere les donnees societes par l'objet
 	$objsoc = new Societe($db);
 	$objsoc->id=$socid;
 	$objsoc->fetch($socid);
 
 	dol_htmloutput_errors($errmesg);
 
 	$head = societe_prepare_head($objsoc);
 
 	dol_fiche_head($head, 'relativediscount', $langs->trans("ThirdParty"),0,'company');
 
 
 	print '<table class="border" width="100%">';
 
     // Name
 	print '<tr><td colspan="2" width="25%">'.$langs->trans('Name').'</td>';
 	print '<td colspan="2">';
 	print $form->showrefnav($objsoc,'id','',1,'rowid','nom');
 	print '</td></tr>';
 
 	// Remise
 	print '<tr><td colspan="2" width="25%">';
 	print $langs->trans("CustomerRelativeDiscount").'</td><td colspan="2">'.$objsoc->remise_client."%</td></tr>";
 
 	print '</table>';
 	print '<br>';
 
 	print_fiche_titre($langs->trans("NewRelativeDiscount"),'','');
 
 	print '<form method="POST" action="remise.php?id='.$objsoc->id.'">';
 	print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
 	print '<input type="hidden" name="action" value="setremise">';
-    print '<input type="hidden" name="backtopage" value="'.GETPOST('backtopage').'">';
+    print '<input type="hidden" name="backtopage" value="'.$backtopage.'">';
 
 	print '<table class="border" width="100%">';
 
 	// Nouvelle valeur
 	print '<tr><td colspan="2">';
 	print $langs->trans("NewValue").'</td><td colspan="2"><input type="text" size="5" name="remise" value="'.($_POST["remise"]?$_POST["remise"]:$objsoc->remise_client).'">%</td></tr>';
 
 	// Motif/Note
 	print '<tr><td colspan="2" width="25%">';
 	print $langs->trans("NoteReason").'</td><td colspan="2"><input type="text" size="60" name="note" value="'.$_POST["note"].'"></td></tr>';
 
 	print "</table>";
 
 	print '<center>';
 	print '<input type="submit" class="button" value="'.$langs->trans("Modify").'">';
-    if (GETPOST("backtopage"))
+    if (! empty($backtopage))
     {
         print '&nbsp; &nbsp; ';
 	    print '<input type="submit" class="button" name="cancel" value="'.$langs->trans("Cancel").'">';
     }
 	print '</center>';
 
 	print "</form>";
 
 	dol_fiche_end();
 
 	print '<br>';
 
 
 	/*
 	 * Liste de l'historique des avoirs
 	 */
 	$sql  = "SELECT rc.rowid,rc.remise_client,rc.note, rc.datec as dc,";
 	$sql.= " u.login, u.rowid as user_id";
 	$sql.= " FROM ".MAIN_DB_PREFIX."societe_remise as rc, ".MAIN_DB_PREFIX."user as u";
 	$sql.= " WHERE rc.fk_soc =". $objsoc->id;
 	$sql.= " AND u.rowid = rc.fk_user_author";
 	$sql.= " ORDER BY rc.datec DESC";
 
 	$resql=$db->query($sql);
 	if ($resql)
 	{
 		print '<table class="noborder" width="100%">';
 		$tag = !$tag;
 		print '<tr class="liste_titre">';
 		print '<td width="160">'.$langs->trans("Date").'</td>';
 		print '<td width="160" align="center">'.$langs->trans("CustomerRelativeDiscountShort").'</td>';
 		print '<td align="left">'.$langs->trans("NoteReason").'</td>';
 		print '<td align="center">'.$langs->trans("User").'</td>';
 		print '</tr>';
 		$i = 0 ;
 		$num = $db->num_rows($resql);
 
 		while ($i < $num )
 		{
 			$obj = $db->fetch_object($resql);
 			$tag = !$tag;
 			print '<tr '.$bc[$tag].'>';
 			print '<td>'.dol_print_date($db->jdate($obj->dc),"dayhour").'</td>';
 			print '<td align="center">'.$obj->remise_client.' %</td>';
 			print '<td align="left">'.$obj->note.'</td>';
 			print '<td align="center"><a href="'.DOL_URL_ROOT.'/user/fiche.php?id='.$obj->user_id.'">'.img_object($langs->trans("ShowUser"),'user').' '.$obj->login.'</a></td>';
 			print '</tr>';
 			$i++;
 		}
 		$db->free($resql);
 		print "</table>";
 	}
 	else
 	{
 		dol_print_error($db);
 	}
 
 }
 
diff --git a/htdocs/comm/remx.php b/htdocs/comm/remx.php
index 8f26a58..42bac50 100644
--- a/htdocs/comm/remx.php
+++ b/htdocs/comm/remx.php
@@ -32,7 +32,8 @@ $langs->load("orders");
 $langs->load("bills");
 $langs->load("companies");
 
-$action=GETPOST('action');
+$action=GETPOST('action','alpha');
+$backtopage=GETPOST('backtopage','alpha');
 
 // Security check
 $socid = GETPOST("id");
@@ -46,9 +47,9 @@ if ($user->societe_id > 0)
  * Actions
  */
 
-if (GETPOST('cancel') && GETPOST('backtopage'))
+if (GETPOST('cancel') && ! empty($backtopage))
 {
-     Header("Location: ".GETPOST("backtopage"));
+     Header("Location: ".$backtopage);
      exit;
 }
 
@@ -132,46 +133,46 @@ if ($action == 'confirm_split' && GETPOST("confirm") == 'yes')
 if ($action == 'setremise')
 {
 	//if ($user->rights->societe->creer)
 	//if ($user->rights->facture->creer)
 
 	if (price2num($_POST["amount_ht"]) > 0)
 	{
 		$error=0;
 		if (empty($_POST["desc"]))
 		{
 			$mesg='<div class="error">'.$langs->trans("ErrorFieldRequired",$langs->trans("ReasonDiscount")).'</div>';
 			$error++;
 		}
 
 		if (! $error)
 		{
 			$soc = new Societe($db);
 			$soc->fetch($_GET["id"]);
 			$discountid=$soc->set_remise_except($_POST["amount_ht"],$user,$_POST["desc"],$_POST["tva_tx"]);
 
 			if ($discountid > 0)
 			{
-			    if (GETPOST("backtopage"))
+			    if (! empty($backtopage))
 			    {
-			        Header("Location: ".GETPOST("backtopage").'&discountid='.$discountid);
+			        Header("Location: ".$backtopage.'&discountid='.$discountid);
 			        exit;
 			    }
 				else
 				{
 				    Header("Location: remx.php?id=".$_GET["id"]);
 				    exit;
 				}
 			}
 			else
 			{
 				$error++;
 				$mesg='<div class="error">'.$soc->error.'</div>';
 			}
 		}
 	}
 	else
 	{
 		$mesg='<div class="error">'.$langs->trans("ErrorFieldFormat",$langs->trans("NewGlobalDiscount")).'</div>';
 	}
 }
 
@@ -211,331 +212,331 @@ llxHeader('',$langs->trans("GlobalDiscount"));
 if ($socid > 0)
 {
 	dol_htmloutput_mesg($mesg);
 
 	// On recupere les donnees societes par l'objet
 	$objsoc = new Societe($db);
 	$objsoc->id=$socid;
 	$objsoc->fetch($socid);
 
 	/*
 	 * Affichage onglets
 	 */
 	$head = societe_prepare_head($objsoc);
 
 	dol_fiche_head($head, 'absolutediscount', $langs->trans("ThirdParty"),0,'company');
 
 
 	print '<form method="POST" action="'.$_SERVER["PHP_SELF"].'?id='.$objsoc->id.'">';
 	print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
 	print '<input type="hidden" name="action" value="setremise">';
-    print '<input type="hidden" name="backtopage" value="'.GETPOST('backtopage').'">';
+    print '<input type="hidden" name="backtopage" value="'.$backtopage.'">';
 
 	print '<table class="border" width="100%">';
 
 	// Name
 	print '<tr><td width="38%">'.$langs->trans('Name').'</td>';
 	print '<td>';
 	print $form->showrefnav($objsoc,'id','',1,'rowid','nom');
 	print '</td></tr>';
 
 	// Calcul avoirs en cours
 	$remise_all=$remise_user=0;
 	$sql = "SELECT SUM(rc.amount_ht) as amount, rc.fk_user";
 	$sql.= " FROM ".MAIN_DB_PREFIX."societe_remise_except as rc";
 	$sql.= " WHERE rc.fk_soc =". $objsoc->id;
 	$sql.= " AND (fk_facture_line IS NULL AND fk_facture IS NULL)";
 	$sql.= " GROUP BY rc.fk_user";
 	$resql=$db->query($sql);
 	if ($resql)
 	{
 		$obj = $db->fetch_object($resql);
 		$remise_all+=$obj->amount;
 		if ($obj->fk_user == $user->id) $remise_user+=$obj->amount;
 	}
 	else
 	{
 		dol_print_error($db);
 	}
 
 	print '<tr><td width="38%">'.$langs->trans("CustomerAbsoluteDiscountAllUsers").'</td>';
 	print '<td>'.$remise_all.'&nbsp;'.$langs->trans("Currency".$conf->currency).' '.$langs->trans("HT").'</td></tr>';
 
 	print '<tr><td>'.$langs->trans("CustomerAbsoluteDiscountMy").'</td>';
 	print '<td>'.$remise_user.'&nbsp;'.$langs->trans("Currency".$conf->currency).' '.$langs->trans("HT").'</td></tr>';
 	print '</table>';
 	print '<br>';
 
 	print_fiche_titre($langs->trans("NewGlobalDiscount"),'','');
 	print '<table class="border" width="100%">';
 	print '<tr><td width="38%">'.$langs->trans("AmountHT").'</td>';
 	print '<td><input type="text" size="5" name="amount_ht" value="'.$_POST["amount_ht"].'">&nbsp;'.$langs->trans("Currency".$conf->currency).'</td></tr>';
 	print '<tr><td width="38%">'.$langs->trans("VAT").'</td>';
 	print '<td>';
 	print $form->load_tva('tva_tx',GETPOST('tva_tx'),'',$mysoc,'');
 	print '</td></tr>';
 	print '<tr><td>'.$langs->trans("NoteReason").'</td>';
 	print '<td><input type="text" size="60" name="desc" value="'.$_POST["desc"].'"></td></tr>';
 
 	print "</table>";
 
 	print '<center>';
 	print '<input type="submit" class="button" name="submit" value="'.$langs->trans("AddGlobalDiscount").'">';
-    if (GETPOST("backtopage"))
+    if (! empty($backtopage))
     {
         print '&nbsp; &nbsp; ';
 	    print '<input type="submit" class="button" name="cancel" value="'.$langs->trans("Cancel").'">';
     }
 	print '</center>';
 
 	print '</form>';
 
 	dol_fiche_end();
 
 	print '<br>';
 
 	if ($_GET['action'] == 'remove')
 	{
 		$ret=$form->form_confirm($_SERVER["PHP_SELF"].'?id='.$objsoc->id.'&remid='.$_GET["remid"], $langs->trans('RemoveDiscount'), $langs->trans('ConfirmRemoveDiscount'), 'confirm_remove', '', 0, 1);
 	}
 
 	/*
 	 * Liste remises fixes restant en cours (= liees a acune facture ni ligne de facture)
 	 */
 	$sql = "SELECT rc.rowid, rc.amount_ht, rc.amount_tva, rc.amount_ttc, rc.tva_tx,";
 	$sql.= " rc.datec as dc, rc.description,";
 	$sql.= " rc.fk_facture_source,";
 	$sql.= " u.login, u.rowid as user_id,";
 	$sql.= " fa.facnumber as ref, fa.type as type";
 	$sql.= " FROM  ".MAIN_DB_PREFIX."user as u, ".MAIN_DB_PREFIX."societe_remise_except as rc";
 	$sql.= " LEFT JOIN ".MAIN_DB_PREFIX."facture as fa ON rc.fk_facture_source = fa.rowid";
 	$sql.= " WHERE rc.fk_soc =". $objsoc->id;
 	$sql.= " AND u.rowid = rc.fk_user";
 	$sql.= " AND (rc.fk_facture_line IS NULL AND rc.fk_facture IS NULL)";
 	$sql.= " ORDER BY rc.datec DESC";
 
 	$resql=$db->query($sql);
 	if ($resql)
 	{
 		print_titre($langs->trans("DiscountStillRemaining"));
 		print '<table width="100%" class="noborder">';
 		print '<tr class="liste_titre">';
 		print '<td width="120" align="left">'.$langs->trans("Date").'</td>';	// Need 120+ for format with AM/PM
 		print '<td align="left">'.$langs->trans("ReasonDiscount").'</td>';
 		print '<td width="150" nowrap="nowrap">'.$langs->trans("ConsumedBy").'</td>';
 		print '<td width="120" align="right">'.$langs->trans("AmountHT").'</td>';
 		print '<td width="80" align="right">'.$langs->trans("VATRate").'</td>';
 		print '<td width="120" align="right">'.$langs->trans("AmountTTC").'</td>';
 		print '<td width="100" align="center">'.$langs->trans("DiscountOfferedBy").'</td>';
 		print '<td width="50">&nbsp;</td>';
 		print '</tr>';
 
 		$var = true;
 		$i = 0 ;
 		$num = $db->num_rows($resql);
 		while ($i < $num)
 		{
 			$obj = $db->fetch_object($resql);
 			$var = !$var;
 			print "<tr $bc[$var]>";
 			print '<td>'.dol_print_date($db->jdate($obj->dc),'dayhour').'</td>';
 			if ($obj->description == '(CREDIT_NOTE)')
 			{
 				print '<td nowrap="nowrap">';
 				$facturestatic->id=$obj->fk_facture_source;
 				$facturestatic->ref=$obj->ref;
 				$facturestatic->type=$obj->type;
 				print $langs->trans("CreditNote").' '.$facturestatic->getNomURl(1);
 				print '</td>';
 			}
 			elseif ($obj->description == '(DEPOSIT)')
 			{
 				print '<td nowrap="nowrap">';
 				$facturestatic->id=$obj->fk_facture_source;
 				$facturestatic->ref=$obj->ref;
 				$facturestatic->type=$obj->type;
 				print $langs->trans("InvoiceDeposit").' '.$facturestatic->getNomURl(1);
 				print '</td>';
 			}
 			else
 			{
 				print '<td>';
 				print $obj->description;
 				print '</td>';
 			}
 			print '<td nowrap="nowrap">'.$langs->trans("NotConsumed").'</td>';
 			print '<td align="right">'.price($obj->amount_ht).'</td>';
 			print '<td align="right">'.price2num($obj->tva_tx,'MU').'%</td>';
 			print '<td align="right">'.price($obj->amount_ttc).'</td>';
 			print '<td align="center">';
 			print '<a href="'.DOL_URL_ROOT.'/user/fiche.php?id='.$obj->user_id.'">'.img_object($langs->trans("ShowUser"),'user').' '.$obj->login.'</a>';
 			print '</td>';
 			if ($user->rights->societe->creer || $user->rights->facture->creer)
 			{
 				print '<td nowrap="nowrap">';
 				print '<a href="'.$_SERVER["PHP_SELF"].'?id='.$objsoc->id.'&amp;action=split&amp;remid='.$obj->rowid.'">'.img_picto($langs->trans("SplitDiscount"),'split').'</a>';
 				print ' &nbsp; ';
 				print '<a href="'.$_SERVER["PHP_SELF"].'?id='.$objsoc->id.'&amp;action=remove&amp;remid='.$obj->rowid.'">'.img_delete($langs->trans("RemoveDiscount")).'</a>';
 				print '</td>';
 			}
 			else print '<td>&nbsp;</td>';
 			print '</tr>';
 
 			if ($_GET["action"]=='split' && $_GET['remid'] == $obj->rowid)
 			{
 				print "<tr $bc[$var]>";
 				print '<td colspan="8">';
 				$amount1=price2num($obj->amount_ttc/2,'MT');
 				$amount2=($obj->amount_ttc-$amount1);
 				$formquestion=array(
 				'text' => $langs->trans('TypeAmountOfEachNewDiscount'),
 				array('type' => 'text', 'name' => 'amount_ttc_1', 'label' => $langs->trans("AmountTTC").' 1', 'value' => $amount1, 'size' => '5'),
 				array('type' => 'text', 'name' => 'amount_ttc_2', 'label' => $langs->trans("AmountTTC").' 2', 'value' => $amount2, 'size' => '5')
 				);
 				$langs->load("dict");
 				$ret=$form->form_confirm($_SERVER["PHP_SELF"].'?id='.$objsoc->id.'&remid='.$obj->rowid, $langs->trans('SplitDiscount'), $langs->trans('ConfirmSplitDiscount',price($obj->amount_ttc),$langs->transnoentities("Currency".$conf->currency)), 'confirm_split', $formquestion, 0, 0);
 				print '</td>';
 				print '</tr>';
 			}
 			$i++;
 		}
 		$db->free($resql);
 		print "</table>";
 	}
 	else
 	{
 		dol_print_error($db);
 	}
 
 	print '<br>';
 
 	/*
 	 * Liste ristournes appliquees (=liees a une ligne de facture ou facture)
 	 */
 
 	// Remises liees a lignes de factures
 	$sql = "SELECT rc.rowid, rc.amount_ht, rc.amount_tva, rc.amount_ttc, rc.tva_tx,";
 	$sql.= " rc.datec as dc, rc.description, rc.fk_facture_line, rc.fk_facture,";
 	$sql.= " rc.fk_facture_source,";
 	$sql.= " u.login, u.rowid as user_id,";
 	$sql.= " f.rowid, f.facnumber,";
 	$sql.= " fa.facnumber as ref, fa.type as type";
 	$sql.= " FROM ".MAIN_DB_PREFIX."facture as f";
 	$sql.= " , ".MAIN_DB_PREFIX."user as u";
 	$sql.= " , ".MAIN_DB_PREFIX."facturedet as fc";
 	$sql.= " , ".MAIN_DB_PREFIX."societe_remise_except as rc";
 	$sql.= " LEFT JOIN ".MAIN_DB_PREFIX."facture as fa ON rc.fk_facture_source = fa.rowid";
 	$sql.= " WHERE rc.fk_soc =". $objsoc->id;
 	$sql.= " AND rc.fk_facture_line = fc.rowid";
 	$sql.= " AND fc.fk_facture = f.rowid";
 	$sql.= " AND rc.fk_user = u.rowid";
 	$sql.= " ORDER BY dc DESC";
 	//$sql.= " UNION ";
 	// Remises liees a factures
 	$sql2 = "SELECT rc.rowid, rc.amount_ht, rc.amount_tva, rc.amount_ttc, rc.tva_tx,";
 	$sql2.= " rc.datec as dc, rc.description, rc.fk_facture_line, rc.fk_facture,";
 	$sql2.= " rc.fk_facture_source,";
 	$sql2.= " u.login, u.rowid as user_id,";
 	$sql2.= " f.rowid, f.facnumber,";
 	$sql2.= " fa.facnumber as ref, fa.type as type";
 	$sql2.= " FROM ".MAIN_DB_PREFIX."facture as f";
 	$sql2.= " , ".MAIN_DB_PREFIX."user as u";
 	$sql2.= " , ".MAIN_DB_PREFIX."societe_remise_except as rc";
 	$sql2.= " LEFT JOIN ".MAIN_DB_PREFIX."facture as fa ON rc.fk_facture_source = fa.rowid";
 	$sql2.= " WHERE rc.fk_soc =". $objsoc->id;
 	$sql2.= " AND rc.fk_facture = f.rowid";
 	$sql2.= " AND rc.fk_user = u.rowid";
 
 	$sql2.= " ORDER BY dc DESC";
 
 	$resql=$db->query($sql);
 	$resql2=null;
 	if ($resql) $resql2=$db->query($sql2);
 	if ($resql2)
 	{
 		print_titre($langs->trans("DiscountAlreadyCounted"));
 		print '<table class="noborder" width="100%">';
 		print '<tr class="liste_titre">';
 		print '<td width="120" align="left">'.$langs->trans("Date").'</td>';	// Need 120+ for format with AM/PM
 		print '<td align="left">'.$langs->trans("ReasonDiscount").'</td>';
 		print '<td width="150" nowrap="nowrap">'.$langs->trans("ConsumedBy").'</td>';
 		print '<td width="120" align="right">'.$langs->trans("AmountHT").'</td>';
 		print '<td width="80" align="right">'.$langs->trans("VATRate").'</td>';
 		print '<td width="120" align="right">'.$langs->trans("AmountTTC").'</td>';
 		print '<td width="100" align="center">'.$langs->trans("Author").'</td>';
 		print '<td width="50">&nbsp;</td>';
 		print '</tr>';
 
 		$var = true;
 		$tab_sqlobj=array();
 		$tab_sqlobjOrder=array();
 		$num = $db->num_rows($resql);
 		for ($i = 0;$i < $num;$i++)
 		{
 			$sqlobj = $db->fetch_object($resql);
 			$tab_sqlobj[] = $sqlobj;
 			$tab_sqlobjOrder[]=$db->jdate($sqlobj->dc);
 		}
 		$db->free($resql);
 
 		$num = $db->num_rows($resql2);
 		for ($i = 0;$i < $num;$i++)
 		{
 			$sqlobj = $db->fetch_object($resql2);
 			$tab_sqlobj[] = $sqlobj;
 			$tab_sqlobjOrder[]= $db->jdate($sqlobj->dc);
 		}
 		$db->free($resql2);
 		array_multisort($tab_sqlobjOrder,SORT_DESC,$tab_sqlobj);
 
 		$num = count($tab_sqlobj);
 		$i = 0 ;
 		while ($i < $num )
 		{
 			$obj = array_shift($tab_sqlobj);
 			$var = !$var;
 			print "<tr $bc[$var]>";
 			print '<td>'.dol_print_date($db->jdate($obj->dc),'dayhour').'</td>';
 			if ($obj->description == '(CREDIT_NOTE)')
 			{
 				print '<td nowrap="nowrap">';
 				$facturestatic->id=$obj->fk_facture_source;
 				$facturestatic->ref=$obj->ref;
 				$facturestatic->type=$obj->type;
 				print $langs->trans("CreditNote").' '.$facturestatic->getNomURl(1);
 				print '</td>';
 			}
 			elseif ($obj->description == '(DEPOSIT)')
 			{
 				print '<td nowrap="nowrap">';
 				$facturestatic->id=$obj->fk_facture_source;
 				$facturestatic->ref=$obj->ref;
 				$facturestatic->type=$obj->type;
 				print $langs->trans("InvoiceDeposit").' '.$facturestatic->getNomURl(1);
 				print '</td>';
 			}
 			else
 			{
 				print '<td>';
 				print $obj->description;
 				print '</td>';
 			}
 			print '<td align="left" nowrap="nowrap"><a href="'.DOL_URL_ROOT.'/compta/facture.php?facid='.$obj->rowid.'">'.img_object($langs->trans("ShowBill"),'bill').' '.$obj->facnumber.'</a></td>';
 			print '<td align="right">'.price($obj->amount_ht).'</td>';
 			print '<td align="right">'.price2num($obj->tva_tx,'MU').'%</td>';
 			print '<td align="right">'.price($obj->amount_ttc).'</td>';
 			print '<td align="center">';
 			print '<a href="'.DOL_URL_ROOT.'/user/fiche.php?id='.$obj->user_id.'">'.img_object($langs->trans("ShowUser"),'user').' '.$obj->login.'</a>';
 			print '</td>';
 			print '<td>&nbsp;</td>';
 			print '</tr>';
 			$i++;
 		}
 		print "</table>";
 	}
 	else
 	{
 		print dol_print_error($db);
 	}
 
 }
 
diff --git a/htdocs/contact/fiche.php b/htdocs/contact/fiche.php
index 213980d..bb6ff79 100644
--- a/htdocs/contact/fiche.php
+++ b/htdocs/contact/fiche.php
@@ -39,10 +39,11 @@ $langs->load("commercial");
 
 $mesg=''; $error=0; $errors=array();
 
-$action		= (GETPOST('action') ? GETPOST('action') : 'view');
-$confirm	= GETPOST('confirm');
-$id			= GETPOST("id");
-$socid		= GETPOST("socid");
+$action		= (GETPOST('action','alpha') ? GETPOST('action','alpha') : 'view');
+$confirm	= GETPOST('confirm','alpha');
+$backtopage = GETPOST('backtopage','alpha');
+$id			= GETPOST('id','int');
+$socid		= GETPOST('socid','int');
 if ($user->societe_id) $socid=$user->societe_id;
 
 $object = new Contact($db);
@@ -76,189 +77,189 @@ $reshook=$hookmanager->executeHooks('doActions',$parameters,$object,$action);
 if (empty($reshook))
 {
     // Cancel
-    if (GETPOST("cancel") && GETPOST('backtopage'))
+    if (GETPOST("cancel") && ! empty($backtopage))
     {
-        header("Location: ".GETPOST('backtopage'));
+        header("Location: ".$backtopage);
         exit;
     }
 
 	// Creation utilisateur depuis contact
     if ($action == 'confirm_create_user' && $confirm == 'yes' && $user->rights->user->user->creer)
     {
         // Recuperation contact actuel
-        $result = $object->fetch($_GET["id"]);
+        $result = $object->fetch($id);
 
         if ($result > 0)
         {
             $db->begin();
 
             // Creation user
             $nuser = new User($db);
             $result=$nuser->create_from_contact($object,$_POST["login"]);
 
             if ($result > 0)
             {
                 $result2=$nuser->setPassword($user,$_POST["password"],0,0,1);
                 if ($result2)
                 {
                     $db->commit();
                 }
                 else
                 {
                     $error=$nuser->error; $errors=$nuser->errors;
                     $db->rollback();
                 }
             }
             else
             {
                 $error=$nuser->error; $errors=$nuser->errors;
                 $db->rollback();
             }
         }
         else
         {
             $error=$object->error; $errors=$object->errors;
         }
     }
 
     // Add contact
     if ($action == 'add' && $user->rights->societe->contact->creer)
     {
         $db->begin();
 
         if ($canvas) $object->canvas=$canvas;
 
         $object->socid			= $_POST["socid"];
         $object->name			= $_POST["name"];
         $object->firstname		= $_POST["firstname"];
         $object->civilite_id	= $_POST["civilite_id"];
         $object->poste			= $_POST["poste"];
         $object->address		= $_POST["address"];
         $object->zip			= $_POST["zipcode"];
         $object->town			= $_POST["town"];
         $object->fk_pays		= $_POST["country_id"];
         $object->fk_departement = $_POST["departement_id"];
         $object->country_id		= $_POST["country_id"];
         $object->state_id       = $_POST["departement_id"];
         $object->email			= $_POST["email"];
         $object->phone_pro		= $_POST["phone_pro"];
         $object->phone_perso	= $_POST["phone_perso"];
         $object->phone_mobile	= $_POST["phone_mobile"];
         $object->fax			= $_POST["fax"];
         $object->jabberid		= $_POST["jabberid"];
         $object->priv			= $_POST["priv"];
         $object->note			= $_POST["note"];
 
         // Note: Correct date should be completed with location to have exact GM time of birth.
         $object->birthday = dol_mktime(0,0,0,$_POST["birthdaymonth"],$_POST["birthdayday"],$_POST["birthdayyear"]);
         $object->birthday_alert = $_POST["birthday_alert"];
 
         if (! $_POST["name"])
         {
             $error++; $errors[]=$langs->trans("ErrorFieldRequired",$langs->transnoentities("Lastname").' / '.$langs->transnoentities("Label"));
             $action = 'create';
         }
 
         if ($_POST["name"])
         {
             $id =  $object->create($user);
             if ($id <= 0)
             {
                 $error++; $errors[]=($object->error?array($object->error):$object->errors);
                 $action = 'create';
             }
         }
 
         if (! $error && $id > 0)
         {
             $db->commit();
-            if (GETPOST('backtopage')) $url=GETPOST('backtopage');
+            if (! empty($backtopage)) $url=$backtopage;
             else $url='fiche.php?id='.$id;
             Header("Location: ".$url);
             exit;
         }
         else
         {
             $db->rollback();
         }
     }
 
     if ($action == 'confirm_delete' && $confirm == 'yes' && $user->rights->societe->contact->supprimer)
     {
         $result=$object->fetch($_GET["id"]);
 
         $object->old_name      = $_POST["old_name"];
         $object->old_firstname = $_POST["old_firstname"];
 
         $result = $object->delete();
         if ($result > 0)
         {
             Header("Location: ".DOL_URL_ROOT.'/contact/list.php');
             exit;
         }
         else
         {
             $error=$object->error; $errors[]=$object->errors;
         }
     }
 
     if ($action == 'update' && ! $_POST["cancel"] && $user->rights->societe->contact->creer)
     {
         if (empty($_POST["name"]))
         {
             $error++; $errors=array($langs->trans("ErrorFieldRequired",$langs->transnoentities("Name").' / '.$langs->transnoentities("Label")));
             $action = 'edit';
         }
 
         if (! count($errors))
         {
             $object->fetch($_POST["contactid"]);
 
             $object->oldcopy=dol_clone($object);
 
             $object->old_name		= $_POST["old_name"];
             $object->old_firstname	= $_POST["old_firstname"];
 
             $object->socid			= $_POST["socid"];
             $object->name			= $_POST["name"];
             $object->firstname		= $_POST["firstname"];
             $object->civilite_id	= $_POST["civilite_id"];
             $object->poste			= $_POST["poste"];
 
             $object->address		= $_POST["address"];
             $object->zip			= $_POST["zipcode"];
             $object->town			= $_POST["town"];
             $object->fk_departement	= $_POST["departement_id"];
             $object->fk_pays		= $_POST["country_id"];
             $object->state_id   	= $_POST["departement_id"];
             $object->country_id		= $_POST["country_id"];
 
             $object->email			= $_POST["email"];
             $object->phone_pro		= $_POST["phone_pro"];
             $object->phone_perso	= $_POST["phone_perso"];
             $object->phone_mobile	= $_POST["phone_mobile"];
             $object->fax			= $_POST["fax"];
             $object->jabberid		= $_POST["jabberid"];
             $object->priv			= $_POST["priv"];
             $object->note			= $_POST["note"];
 
             $result = $object->update($_POST["contactid"], $user);
 
             if ($result > 0)
             {
                 $object->old_name='';
                 $object->old_firstname='';
             }
             else
             {
                 $error=$object->error; $errors=$object->errors;
             }
         }
     }
 }
 
 
 /*
  *	View
  */
 
@@ -292,602 +293,602 @@ if (is_object($objcanvas) && $objcanvas->displayCanvasExists())
 else
 {
     // -----------------------------------------
     // When used in standard mode
     // -----------------------------------------
 
     // Confirm deleting contact
     if ($user->rights->societe->contact->supprimer)
     {
         if ($action == 'delete')
         {
             $ret=$form->form_confirm($_SERVER["PHP_SELF"]."?id=".$_GET["id"],$langs->trans("DeleteContact"),$langs->trans("ConfirmDeleteContact"),"confirm_delete",'',0,1);
             if ($ret == 'html') print '<br>';
         }
     }
 
     /*
      * Onglets
      */
     if ($id > 0)
     {
         // Si edition contact deja existant
         $object = new Contact($db);
         $return=$object->fetch($id, $user);
         if ($return <= 0)
         {
             dol_print_error('',$object->error);
             $id=0;
         }
 
         // Show tabs
         $head = contact_prepare_head($object);
 
         dol_fiche_head($head, 'card', $langs->trans("ContactsAddresses"), 0, 'contact');
     }
 
     if ($user->rights->societe->contact->creer)
     {
         if ($action == 'create')
         {
             /*
              * Fiche en mode creation
              */
             $object->canvas=$canvas;
 
             $object->fk_departement = $_POST["departement_id"];
 
             // We set country_id, country_code and label for the selected country
             $object->country_id=$_POST["country_id"]?$_POST["country_id"]:$mysoc->country_id;
             if ($object->country_id)
             {
             	$tmparray=getCountry($object->country_id,'all');
                 $object->pays_code    = $tmparray['code'];
                 $object->pays         = $tmparray['label'];
                 $object->country_code = $tmparray['code'];
                 $object->country      = $tmparray['label'];
             }
 
             print_fiche_titre($langs->trans("AddContact"));
 
             // Affiche les erreurs
             dol_htmloutput_errors($error,$errors);
 
             if ($conf->use_javascript_ajax)
             {
                 print "\n".'<script type="text/javascript" language="javascript">';
                 print 'jQuery(document).ready(function () {
 							jQuery("#selectcountry_id").change(function() {
 								document.formsoc.action.value="create";
 								document.formsoc.submit();
                         	});
 						})';
                 print '</script>'."\n";
             }
 
             print '<br>';
             print '<form method="post" name="formsoc" action="'.$_SERVER["PHP_SELF"].'">';
             print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
             print '<input type="hidden" name="action" value="add">';
-            print '<input type="hidden" name="backtopage" value="'.GETPOST('backtopage').'">';
+            print '<input type="hidden" name="backtopage" value="'.$backtopage.'">';
             print '<table class="border" width="100%">';
 
             // Name
             print '<tr><td width="20%" class="fieldrequired">'.$langs->trans("Lastname").' / '.$langs->trans("Label").'</td><td width="30%"><input name="name" type="text" size="30" maxlength="80" value="'.(isset($_POST["name"])?$_POST["name"]:$object->name).'"></td>';
             print '<td width="20%">'.$langs->trans("Firstname").'</td><td width="30%"><input name="firstname" type="text" size="30" maxlength="80" value="'.(isset($_POST["firstname"])?$_POST["firstname"]:$object->firstname).'"></td></tr>';
 
             // Company
             if (empty($conf->global->SOCIETE_DISABLE_CONTACTS))
             {
                 if ($socid > 0)
                 {
                     print '<tr><td>'.$langs->trans("Company").'</td>';
                     print '<td colspan="3">';
                     print $objsoc->getNomUrl(1);
                     print '</td>';
                     print '<input type="hidden" name="socid" value="'.$objsoc->id.'">';
                     print '</td></tr>';
                 }
                 else {
                     print '<tr><td>'.$langs->trans("Company").'</td><td colspan="3">';
                     print $form->select_company(GETPOST("socid"),'socid','',1);
                     print '</td></tr>';
                 }
             }
 
             // Civility
             print '<tr><td width="15%">'.$langs->trans("UserTitle").'</td><td colspan="3">';
             print $formcompany->select_civility(isset($_POST["civilite_id"])?$_POST["civilite_id"]:$object->civilite_id);
             print '</td></tr>';
 
             print '<tr><td>'.$langs->trans("PostOrFunction").'</td><td colspan="3"><input name="poste" type="text" size="50" maxlength="80" value="'.(isset($_POST["poste"])?$_POST["poste"]:$object->poste).'"></td>';
 
             // Address
             if (($objsoc->typent_code == 'TE_PRIVATE' || ! empty($conf->global->CONTACT_USE_COMPANY_ADDRESS)) && dol_strlen(trim($object->address)) == 0) $object->address = $objsoc->address;	// Predefined with third party
             print '<tr><td>'.$langs->trans("Address").'</td><td colspan="3"><textarea class="flat" name="address" cols="70">'.(isset($_POST["address"])?$_POST["address"]:$object->address).'</textarea></td>';
 
             // Zip / Town
             if (($objsoc->typent_code == 'TE_PRIVATE' || ! empty($conf->global->CONTACT_USE_COMPANY_ADDRESS)) && dol_strlen(trim($object->zip)) == 0) $object->zip = $objsoc->zip;			// Predefined with third party
             if (($objsoc->typent_code == 'TE_PRIVATE' || ! empty($conf->global->CONTACT_USE_COMPANY_ADDRESS)) && dol_strlen(trim($object->town)) == 0) $object->town = $objsoc->town;	// Predefined with third party
             print '<tr><td>'.$langs->trans("Zip").' / '.$langs->trans("Town").'</td><td colspan="3">';
             print $formcompany->select_ziptown((isset($_POST["zipcode"])?$_POST["zipcode"]:$object->zip),'zipcode',array('town','selectcountry_id','departement_id'),6).'&nbsp;';
             print $formcompany->select_ziptown((isset($_POST["town"])?$_POST["town"]:$object->town),'town',array('zipcode','selectcountry_id','departement_id'));
             print '</td></tr>';
 
             // Country
             if (dol_strlen(trim($object->fk_pays)) == 0) $object->fk_pays = $objsoc->country_id;	// Predefined with third party
             print '<tr><td>'.$langs->trans("Country").'</td><td colspan="3">';
             print $form->select_country((isset($_POST["country_id"])?$_POST["country_id"]:$object->country_id),'country_id');
             if ($user->admin) print info_admin($langs->trans("YouCanChangeValuesForThisListFromDictionnarySetup"),1);
             print '</td></tr>';
 
             // State
             if (empty($conf->global->SOCIETE_DISABLE_STATE))
             {
                 print '<tr><td>'.$langs->trans('State').'</td><td colspan="3">';
                 if ($object->country_id)
                 {
                     print $formcompany->select_state(isset($_POST["departement_id"])?$_POST["departement_id"]:$object->fk_departement,$object->country_code);
                 }
                 else
                 {
                     print $countrynotdefined;
                 }
                 print '</td></tr>';
             }
 
             // Phone / Fax
             if (($objsoc->typent_code == 'TE_PRIVATE' || ! empty($conf->global->CONTACT_USE_COMPANY_ADDRESS)) && dol_strlen(trim($object->phone_pro)) == 0) $object->phone_pro = $objsoc->tel;	// Predefined with third party
             print '<tr><td>'.$langs->trans("PhonePro").'</td><td><input name="phone_pro" type="text" size="18" maxlength="80" value="'.(isset($_POST["phone_pro"])?$_POST["phone_pro"]:$object->phone_pro).'"></td>';
             print '<td>'.$langs->trans("PhonePerso").'</td><td><input name="phone_perso" type="text" size="18" maxlength="80" value="'.(isset($_POST["phone_perso"])?$_POST["phone_perso"]:$object->phone_perso).'"></td></tr>';
 
             if (($objsoc->typent_code == 'TE_PRIVATE' || ! empty($conf->global->CONTACT_USE_COMPANY_ADDRESS)) && dol_strlen(trim($object->fax)) == 0) $object->fax = $objsoc->fax;	// Predefined with third party
             print '<tr><td>'.$langs->trans("PhoneMobile").'</td><td><input name="phone_mobile" type="text" size="18" maxlength="80" value="'.(isset($_POST["phone_mobile"])?$_POST["phone_mobile"]:$object->phone_mobile).'"></td>';
             print '<td>'.$langs->trans("Fax").'</td><td><input name="fax" type="text" size="18" maxlength="80" value="'.(isset($_POST["fax"])?$_POST["fax"]:$object->fax).'"></td></tr>';
 
             // EMail
             if (($objsoc->typent_code == 'TE_PRIVATE' || ! empty($conf->global->CONTACT_USE_COMPANY_ADDRESS)) && dol_strlen(trim($object->email)) == 0) $object->email = $objsoc->email;	// Predefined with third party
             print '<tr><td>'.$langs->trans("Email").'</td><td colspan="3"><input name="email" type="text" size="50" maxlength="80" value="'.(isset($_POST["email"])?$_POST["email"]:$object->email).'"></td></tr>';
 
             // Instant message
             print '<tr><td>'.$langs->trans("IM").'</td><td colspan="3"><input name="jabberid" type="text" size="50" maxlength="80" value="'.(isset($_POST["jabberid"])?$_POST["jabberid"]:$object->jabberid).'"></td></tr>';
 
             // Visibility
             print '<tr><td>'.$langs->trans("ContactVisibility").'</td><td colspan="3">';
             $selectarray=array('0'=>$langs->trans("ContactPublic"),'1'=>$langs->trans("ContactPrivate"));
             print $form->selectarray('priv',$selectarray,(isset($_POST["priv"])?$_POST["priv"]:$object->priv),0);
             print '</td></tr>';
 
             // Note
             print '<tr><td valign="top">'.$langs->trans("Note").'</td><td colspan="3" valign="top"><textarea name="note" cols="70" rows="'.ROWS_3.'">'.(isset($_POST["note"])?$_POST["note"]:$object->note).'</textarea></td></tr>';
 
             print "</table><br>";
 
 
             // Add personnal information
             print_fiche_titre('<div class="comboperso">'.$langs->trans("PersonalInformations").'</div>','','');
 
             print '<table class="border" width="100%">';
 
             // Date To Birth
             print '<tr><td width="20%">'.$langs->trans("DateToBirth").'</td><td width="30%">';
             $form=new Form($db);
             if ($object->birthday)
             {
                 print $form->select_date($object->birthday,'birthday',0,0,0,"perso");
             }
             else
             {
                 print $form->select_date('','birthday',0,0,1,"perso");
             }
             print '</td>';
 
             print '<td colspan="2">'.$langs->trans("Alert").': ';
             if ($object->birthday_alert)
             {
                 print '<input type="checkbox" name="birthday_alert" checked></td>';
             }
             else
             {
                 print '<input type="checkbox" name="birthday_alert"></td>';
             }
             print '</tr>';
 
             print "</table><br><br>";
 
 
             print '<center>';
             print '<input type="submit" class="button" name="add" value="'.$langs->trans("Add").'">';
-            if (GETPOST('backtopage'))
+            if (! empty($backtopage))
             {
                 print ' &nbsp; &nbsp; ';
                 print '<input type="submit" class="button" name="cancel" value="'.$langs->trans("Cancel").'">';
             }
             print '</center>';
 
             print "</form>";
         }
         elseif ($action == 'edit' && ! empty($id))
         {
             /*
              * Fiche en mode edition
              */
 
             // We set country_id, and country_code label of the chosen country
             if (isset($_POST["country_id"]) || $object->country_id)
             {
 	            $tmparray=getCountry($object->country_id,'all');
 	            $object->pays_code    =	$tmparray['code'];
 	            $object->pays         =	$tmparray['label'];
 	            $object->country_code =	$tmparray['code'];
 	            $object->country      =	$tmparray['label'];
             }
 
             // Affiche les erreurs
             dol_htmloutput_errors($error,$errors);
 
             if ($conf->use_javascript_ajax)
             {
                 print '<script type="text/javascript" language="javascript">';
                 print 'jQuery(document).ready(function () {
 							jQuery("#selectcountry_id").change(function() {
 								document.formsoc.action.value="edit";
 								document.formsoc.submit();
 							});
 						})';
                 print '</script>';
             }
 
-            print '<form method="post" action="'.$_SERVER["PHP_SELF"].'?id='.GETPOST("id").'" name="formsoc">';
+            print '<form method="post" action="'.$_SERVER["PHP_SELF"].'?id='.$id.'" name="formsoc">';
             print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
-            print '<input type="hidden" name="id" value="'.GETPOST("id").'">';
+            print '<input type="hidden" name="id" value="'.$id.'">';
             print '<input type="hidden" name="action" value="update">';
-            print '<input type="hidden" name="backtopage" value="'.GETPOST('backtopage').'">';
+            print '<input type="hidden" name="backtopage" value="'.$backtopage.'">';
             print '<input type="hidden" name="contactid" value="'.$object->id.'">';
             print '<input type="hidden" name="old_name" value="'.$object->name.'">';
             print '<input type="hidden" name="old_firstname" value="'.$object->firstname.'">';
             print '<table class="border" width="100%">';
 
             // Ref
             print '<tr><td>'.$langs->trans("Ref").'</td><td colspan="3">';
             print $object->ref;
             print '</td></tr>';
 
             // Name
             print '<tr><td width="20%" class="fieldrequired">'.$langs->trans("Lastname").' / '.$langs->trans("Label").'</td><td width="30%"><input name="name" type="text" size="20" maxlength="80" value="'.(isset($_POST["name"])?$_POST["name"]:$object->name).'"></td>';
             print '<td width="20%">'.$langs->trans("Firstname").'</td><td width="30%"><input name="firstname" type="text" size="20" maxlength="80" value="'.(isset($_POST["firstname"])?$_POST["firstname"]:$object->firstname).'"></td></tr>';
 
             // Company
             if (empty($conf->global->SOCIETE_DISABLE_CONTACTS))
             {
                 print '<tr><td>'.$langs->trans("Company").'</td>';
                 print '<td colspan="3">';
                 print $form->select_company(GETPOST("socid")?GETPOST("socid"):($object->socid?$object->socid:-1),'socid','',1);
                 print '</td>';
                 print '</tr>';
             }
 
             // Civility
             print '<tr><td>'.$langs->trans("UserTitle").'</td><td colspan="3">';
             print $formcompany->select_civility(isset($_POST["civilite_id"])?$_POST["civilite_id"]:$object->civilite_id);
             print '</td></tr>';
 
             print '<tr><td>'.$langs->trans("PostOrFunction" ).'</td><td colspan="3"><input name="poste" type="text" size="50" maxlength="80" value="'.(isset($_POST["poste"])?$_POST["poste"]:$object->poste).'"></td></tr>';
 
             // Address
             print '<tr><td>'.$langs->trans("Address").'</td><td colspan="3"><textarea class="flat" name="address" cols="70">'.(isset($_POST["address"])?$_POST["address"]:$object->address).'</textarea></td>';
 
             // Zip / Town
             print '<tr><td>'.$langs->trans("Zip").' / '.$langs->trans("Town").'</td><td colspan="3">';
             print $formcompany->select_ziptown((isset($_POST["zipcode"])?$_POST["zipcode"]:$object->zip),'zipcode',array('town','selectcountry_id','departement_id'),6).'&nbsp;';
             print $formcompany->select_ziptown((isset($_POST["town"])?$_POST["town"]:$object->town),'town',array('zipcode','selectcountry_id','departement_id'));
             print '</td></tr>';
 
             // Country
             print '<tr><td>'.$langs->trans("Country").'</td><td colspan="3">';
             print $form->select_country(isset($_POST["country_id"])?$_POST["country_id"]:$object->country_id,'country_id');
             if ($user->admin) print info_admin($langs->trans("YouCanChangeValuesForThisListFromDictionnarySetup"),1);
             print '</td></tr>';
 
             // State
             if (empty($conf->global->SOCIETE_DISABLE_STATE))
             {
                 print '<tr><td>'.$langs->trans('State').'</td><td colspan="3">';
                 print $formcompany->select_state($object->fk_departement,isset($_POST["country_id"])?$_POST["country_id"]:$object->country_id);
                 print '</td></tr>';
             }
 
             // Phone
             print '<tr><td>'.$langs->trans("PhonePro").'</td><td><input name="phone_pro" type="text" size="18" maxlength="80" value="'.(isset($_POST["phone_pro"])?$_POST["phone_pro"]:$object->phone_pro).'"></td>';
             print '<td>'.$langs->trans("PhonePerso").'</td><td><input name="phone_perso" type="text" size="18" maxlength="80" value="'.(isset($_POST["phone_perso"])?$_POST["phone_perso"]:$object->phone_perso).'"></td></tr>';
 
             print '<tr><td>'.$langs->trans("PhoneMobile").'</td><td><input name="phone_mobile" type="text" size="18" maxlength="80" value="'.(isset($_POST["phone_mobile"])?$_POST["phone_mobile"]:$object->phone_mobile).'"></td>';
             print '<td>'.$langs->trans("Fax").'</td><td><input name="fax" type="text" size="18" maxlength="80" value="'.(isset($_POST["fax"])?$_POST["fax"]:$object->fax).'"></td></tr>';
 
             // EMail
             print '<tr><td>'.$langs->trans("EMail").'</td><td><input name="email" type="text" size="40" maxlength="80" value="'.(isset($_POST["email"])?$_POST["email"]:$object->email).'"></td>';
             if ($conf->mailing->enabled)
             {
                 $langs->load("mails");
                 print '<td nowrap>'.$langs->trans("NbOfEMailingsReceived").'</td>';
                 print '<td>'.$object->getNbOfEMailings().'</td>';
             }
             else
             {
                 print '<td colspan="2">&nbsp;</td>';
             }
             print '</tr>';
 
             // Jabberid
             print '<tr><td>Jabberid</td><td colspan="3"><input name="jabberid" type="text" size="40" maxlength="80" value="'.(isset($_POST["jabberid"])?$_POST["jabberid"]:$object->jabberid).'"></td></tr>';
 
             // Visibility
             print '<tr><td>'.$langs->trans("ContactVisibility").'</td><td colspan="3">';
             $selectarray=array('0'=>$langs->trans("ContactPublic"),'1'=>$langs->trans("ContactPrivate"));
             print $form->selectarray('priv',$selectarray,$object->priv,0);
             print '</td></tr>';
 
             print '<tr><td valign="top">'.$langs->trans("Note").'</td><td colspan="3">';
             print '<textarea name="note" cols="70" rows="'.ROWS_3.'">';
             print isset($_POST["note"])?$_POST["note"]:$object->note;
             print '</textarea></td></tr>';
 
             $object->load_ref_elements();
 
             if ($conf->commande->enabled)
             {
                 print '<tr><td>'.$langs->trans("ContactForOrders").'</td><td colspan="3">';
                 print $object->ref_commande?$object->ref_commande:$langs->trans("NoContactForAnyOrder");
                 print '</td></tr>';
             }
 
             if ($conf->propal->enabled)
             {
                 print '<tr><td>'.$langs->trans("ContactForProposals").'</td><td colspan="3">';
                 print $object->ref_propal?$object->ref_propal:$langs->trans("NoContactForAnyProposal");
                 print '</td></tr>';
             }
 
             if ($conf->contrat->enabled)
             {
                 print '<tr><td>'.$langs->trans("ContactForContracts").'</td><td colspan="3">';
                 print $object->ref_contrat?$object->ref_contrat:$langs->trans("NoContactForAnyContract");
                 print '</td></tr>';
             }
 
             if ($conf->facture->enabled)
             {
                 print '<tr><td>'.$langs->trans("ContactForInvoices").'</td><td colspan="3">';
                 print $object->ref_facturation?$object->ref_facturation:$langs->trans("NoContactForAnyInvoice");
                 print '</td></tr>';
             }
 
             // Login Dolibarr
             print '<tr><td>'.$langs->trans("DolibarrLogin").'</td><td colspan="3">';
             if ($object->user_id)
             {
                 $dolibarr_user=new User($db);
                 $result=$dolibarr_user->fetch($object->user_id);
                 print $dolibarr_user->getLoginUrl(1);
             }
             else print $langs->trans("NoDolibarrAccess");
             print '</td></tr>';
 
             print '</table><br>';
 
             print '<center>';
             print '<input type="submit" class="button" name="save" value="'.$langs->trans("Save").'">';
             print ' &nbsp; ';
             print '<input type="submit" class="button" name="cancel" value="'.$langs->trans("Cancel").'">';
             print '</center>';
 
             print "</form>";
         }
     }
 
     if (! empty($id) && $action != 'edit')
     {
         $objsoc = new Societe($db);
 
         /*
          * Fiche en mode visualisation
          */
 
         dol_htmloutput_errors($error,$errors);
 
         if ($action == 'create_user')
         {
             // Full firstname and name separated with a dot : firstname.name
             include_once(DOL_DOCUMENT_ROOT.'/core/lib/functions2.lib.php');
             $login=dol_buildlogin($object->nom,$object->prenom);
 
             $generated_password='';
             if (! $ldap_sid) // TODO ldap_sid ?
             {
                 require_once(DOL_DOCUMENT_ROOT."/core/lib/security2.lib.php");
                 $generated_password=getRandomPassword('');
             }
             $password=$generated_password;
 
             // Create a form array
             $formquestion=array(
             array('label' => $langs->trans("LoginToCreate"), 'type' => 'text', 'name' => 'login', 'value' => $login),
             array('label' => $langs->trans("Password"), 'type' => 'text', 'name' => 'password', 'value' => $password),
             //array('label' => $form->textwithpicto($langs->trans("Type"),$langs->trans("InternalExternalDesc")), 'type' => 'select', 'name' => 'intern', 'default' => 1, 'values' => array(0=>$langs->trans('Internal'),1=>$langs->trans('External')))
             );
             $text=$langs->trans("ConfirmCreateContact").'<br>';
             if ($conf->societe->enabled)
             {
                 if ($object->socid > 0) $text.=$langs->trans("UserWillBeExternalUser");
                 else $text.=$langs->trans("UserWillBeInternalUser");
             }
             $ret=$form->form_confirm($_SERVER["PHP_SELF"]."?id=".$object->id,$langs->trans("CreateDolibarrLogin"),$text,"confirm_create_user",$formquestion,'yes');
             if ($ret == 'html') print '<br>';
         }
 
         print '<table class="border" width="100%">';
 
         // Ref
         print '<tr><td width="20%">'.$langs->trans("Ref").'</td><td colspan="3">';
         print $form->showrefnav($object,'id');
         print '</td></tr>';
 
         // Name
         print '<tr><td width="20%">'.$langs->trans("Lastname").' / '.$langs->trans("Label").'</td><td width="30%">'.$object->name.'</td>';
         print '<td width="20%">'.$langs->trans("Firstname").'</td><td width="30%">'.$object->firstname.'</td></tr>';
 
         // Company
         if (empty($conf->global->SOCIETE_DISABLE_CONTACTS))
         {
             print '<tr><td>'.$langs->trans("Company").'</td><td colspan="3">';
             if ($object->socid > 0)
             {
                 $objsoc->fetch($object->socid);
                 print $objsoc->getNomUrl(1);
             }
             else
             {
                 print $langs->trans("ContactNotLinkedToCompany");
             }
             print '</td></tr>';
         }
 
         // Civility
         print '<tr><td width="15%">'.$langs->trans("UserTitle").'</td><td colspan="3">';
         print $object->getCivilityLabel();
         print '</td></tr>';
 
         // Role
         print '<tr><td>'.$langs->trans("PostOrFunction" ).'</td><td colspan="3">'.$object->poste.'</td>';
 
         // Address
         print '<tr><td>'.$langs->trans("Address").'</td><td colspan="3">';
         dol_print_address($object->address,'gmap','contact',$object->id);
         print '</td></tr>';
 
         // Zip Town
         print '<tr><td>'.$langs->trans("Zip").' / '.$langs->trans("Town").'</td><td colspan="3">';
         print $object->cp;
         if ($object->cp) print '&nbsp;';
         print $object->ville.'</td></tr>';
 
         // Country
         print '<tr><td>'.$langs->trans("Country").'</td><td colspan="3">';
         $img=picto_from_langcode($object->country_code);
         if ($img) print $img.' ';
         print $object->pays;
         print '</td></tr>';
 
         // State
         if (empty($conf->global->SOCIETE_DISABLE_STATE))
         {
             print '<tr><td>'.$langs->trans('State').'</td><td colspan="3">'.$object->departement.'</td>';
         }
 
         // Phone
         print '<tr><td>'.$langs->trans("PhonePro").'</td><td>'.dol_print_phone($object->phone_pro,$object->country_code,$object->id,$object->socid,'AC_TEL').'</td>';
         print '<td>'.$langs->trans("PhonePerso").'</td><td>'.dol_print_phone($object->phone_perso,$object->country_code,$object->id,$object->socid,'AC_TEL').'</td></tr>';
 
         print '<tr><td>'.$langs->trans("PhoneMobile").'</td><td>'.dol_print_phone($object->phone_mobile,$object->country_code,$object->id,$object->socid,'AC_TEL').'</td>';
         print '<td>'.$langs->trans("Fax").'</td><td>'.dol_print_phone($object->fax,$object->country_code,$object->id,$object->socid,'AC_FAX').'</td></tr>';
 
         // Email
         print '<tr><td>'.$langs->trans("EMail").'</td><td>'.dol_print_email($object->email,$object->id,$object->socid,'AC_EMAIL').'</td>';
         if ($conf->mailing->enabled)
         {
             $langs->load("mails");
             print '<td nowrap>'.$langs->trans("NbOfEMailingsReceived").'</td>';
             print '<td><a href="'.DOL_URL_ROOT.'/comm/mailing/liste.php?filteremail='.urlencode($object->email).'">'.$object->getNbOfEMailings().'</a></td>';
         }
         else
         {
             print '<td colspan="2">&nbsp;</td>';
         }
         print '</tr>';
 
         // Instant message
         print '<tr><td>'.$langs->trans("IM").'</td><td colspan="3">'.$object->jabberid.'</td></tr>';
 
         print '<tr><td>'.$langs->trans("ContactVisibility").'</td><td colspan="3">';
         print $object->LibPubPriv($object->priv);
         print '</td></tr>';
 
         print '<tr><td valign="top">'.$langs->trans("Note").'</td><td colspan="3">';
         print nl2br($object->note);
         print '</td></tr>';
 
         $object->load_ref_elements();
 
         if ($conf->commande->enabled)
         {
             print '<tr><td>'.$langs->trans("ContactForOrders").'</td><td colspan="3">';
             print $object->ref_commande?$object->ref_commande:$langs->trans("NoContactForAnyOrder");
             print '</td></tr>';
         }
 
         if ($conf->propal->enabled)
         {
             print '<tr><td>'.$langs->trans("ContactForProposals").'</td><td colspan="3">';
             print $object->ref_propal?$object->ref_propal:$langs->trans("NoContactForAnyProposal");
             print '</td></tr>';
         }
 
         if ($conf->contrat->enabled)
         {
             print '<tr><td>'.$langs->trans("ContactForContracts").'</td><td colspan="3">';
             print $object->ref_contrat?$object->ref_contrat:$langs->trans("NoContactForAnyContract");
             print '</td></tr>';
         }
 
         if ($conf->facture->enabled)
         {
             print '<tr><td>'.$langs->trans("ContactForInvoices").'</td><td colspan="3">';
             print $object->ref_facturation?$object->ref_facturation:$langs->trans("NoContactForAnyInvoice");
             print '</td></tr>';
         }
 
         print '<tr><td>'.$langs->trans("DolibarrLogin").'</td><td colspan="3">';
         if ($object->user_id)
         {
             $dolibarr_user=new User($db);
             $result=$dolibarr_user->fetch($object->user_id);
             print $dolibarr_user->getLoginUrl(1);
         }
         else print $langs->trans("NoDolibarrAccess");
         print '</td></tr>';
 
         print "</table>";
 
         print "</div>";
 
         // Barre d'actions
         if (! $user->societe_id)
         {
             print '<div class="tabsAction">';
 
             if ($user->rights->societe->contact->creer)
             {
                 print '<a class="butAction" href="fiche.php?id='.$object->id.'&amp;action=edit">'.$langs->trans('Modify').'</a>';
             }
 
             if (! $object->user_id && $user->rights->user->user->creer)
             {
                 print '<a class="butAction" href="fiche.php?id='.$object->id.'&amp;action=create_user">'.$langs->trans("CreateDolibarrLogin").'</a>';
             }
 
             if ($user->rights->societe->contact->supprimer)
             {
                 print '<a class="butActionDelete" href="fiche.php?id='.$object->id.'&amp;action=delete">'.$langs->trans('Delete').'</a>';
             }
 
             print "</div><br>";
         }
 
         print load_fiche_titre($langs->trans("TasksHistoryForThisContact"),'','');
 
         print show_actions_todo($conf,$langs,$db,$objsoc,$object);
 
         print show_actions_done($conf,$langs,$db,$objsoc,$object);
     }
 }
 
 
diff --git a/htdocs/core/lib/functions.lib.php b/htdocs/core/lib/functions.lib.php
index f9836b4..5dfcda5 100644
--- a/htdocs/core/lib/functions.lib.php
+++ b/htdocs/core/lib/functions.lib.php
@@ -246,28 +246,32 @@ function dol_shutdown()
 function GETPOST($paramname,$check='',$method=0)
 {
 	if (empty($method)) $out = isset($_GET[$paramname])?$_GET[$paramname]:(isset($_POST[$paramname])?$_POST[$paramname]:'');
 	elseif ($method==1) $out = isset($_GET[$paramname])?$_GET[$paramname]:'';
 	elseif ($method==2) $out = isset($_POST[$paramname])?$_POST[$paramname]:'';
 	elseif ($method==3) $out = isset($_POST[$paramname])?$_POST[$paramname]:(isset($_GET[$paramname])?$_GET[$paramname]:'');
 
 	if (! empty($check))
 	{
 		// Check if numeric
 		if ($check == 'int' && ! preg_match('/^[-\.,0-9]+$/i',trim($out))) $out='';
 		// Check if alpha
 		//if ($check == 'alpha' && ! preg_match('/^[ =:@#\/\\\(\)\-\._a-z0-9]+$/i',trim($out))) $out='';
 		// '"' is dangerous because param in url can close the href= or src= and add javascript functions.
-		if ($check == 'alpha' && preg_match('/"/',trim($out))) $out='';
+		if ($check == 'alpha')
+		{
+			if (preg_match('/"/',trim($out))) $out='';
+			else if (preg_match('/(\.\.\/)+/',trim($out))) $out='';
+		}
 	}
 
 	return $out;
 }
 
 
 /**
  *  Return a prefix to use for this Dolibarr instance for session or cookie names.
  *  This prefix is unique for instance and avoid conflict between multi-instances,
  *  even when having two instances with one root dir or two instances in virtual servers
  *
  *  @return	string      		A calculated prefix
  */
diff --git a/htdocs/document.php b/htdocs/document.php
index 9c59f1d..8836ebd 100644
--- a/htdocs/document.php
+++ b/htdocs/document.php
@@ -1,30 +1,30 @@
 <?php
 /* Copyright (C) 2004-2007 Rodolphe Quiedeville <rodolphe@quiedeville.org>
  * Copyright (C) 2004-2012 Laurent Destailleur  <eldy@users.sourceforge.net>
  * Copyright (C) 2005      Simon Tosser         <simon@kornog-computing.com>
- * Copyright (C) 2005-2011 Regis Houssin        <regis@dolibarr.fr>
+ * Copyright (C) 2005-2012 Regis Houssin        <regis@dolibarr.fr>
  * Copyright (C) 2010	   Pierre Morin         <pierre.morin@auguria.net>
  * Copyright (C) 2010	   Juanjo Menent        <jmenent@2byte.es>
  *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation; either version 2 of the License, or
  * (at your option) any later version.
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
  *
  * You should have received a copy of the GNU General Public License
  * along with this program. If not, see <http://www.gnu.org/licenses/>.
  * or see http://www.gnu.org/
  */
 
 /**
  *	\file       htdocs/document.php
  *  \brief      Wrapper to download data files
  *  \remarks    Call of this wrapper is made with URL:
  * 				document.php?modulepart=repfichierconcerne&file=pathrelatifdufichier
  */
 
@@ -50,10 +50,10 @@ require("./main.inc.php");	// Load $user and permissions
 require_once(DOL_DOCUMENT_ROOT.'/core/lib/files.lib.php');
 
 $encoding = '';
-$action = GETPOST("action");
-$original_file = GETPOST("file");	// Do not use urldecode here ($_GET are already decoded by PHP).
-$modulepart = GETPOST("modulepart");
-$urlsource = GETPOST("urlsource");
+$action = GETPOST('action','alpha');
+$original_file = GETPOST('file','alpha');	// Do not use urldecode here ($_GET are already decoded by PHP).
+$modulepart = GETPOST('modulepart','alpha');
+$urlsource = GETPOST('urlsource','alpha');
 
 // Security check
 if (empty($modulepart)) accessforbidden('Bad value for parameter modulepart');
@@ -72,7 +72,7 @@ if (empty($modulepart)) accessforbidden('Bad value for parameter modulepart');
 
 // Define mime type
 $type = 'application/octet-stream';
-if (GETPOST('type')) $type=GETPOST('type');
+if (GETPOST('type','alpha')) $type=GETPOST('type','alpha');
 else $type=dol_mimetype($original_file);
 //print 'X'.$type.'-'.$original_file;exit;
 
diff --git a/htdocs/projet/fiche.php b/htdocs/projet/fiche.php
index 95aba87..371028f 100644
--- a/htdocs/projet/fiche.php
+++ b/htdocs/projet/fiche.php
@@ -34,8 +34,9 @@ $langs->load("projects");
 $langs->load('companies');
 
 $id=GETPOST('id','int');
-$ref = GETPOST('ref');
-$action=GETPOST('action');
+$ref = GETPOST('ref','alpha');
+$action=GETPOST('action','alpha');
+$backtopage=GETPOST('backtopage','alpha');
 
 if ($id == '' && $ref == '' && ($action != "create" && $action != "add" && $action != "update" && ! $_POST["cancel"])) accessforbidden();
 
@@ -55,9 +56,9 @@ $result = restrictedArea($user, 'projet', $id);
  */
 
 // Cancel
-if (GETPOST("cancel") && GETPOST('backtopage'))
+if (GETPOST("cancel") && ! empty($backtopage))
 {
-    header("Location: ".GETPOST('backtopage'));
+    header("Location: ".$backtopage);
     exit;
 }
 
@@ -267,77 +268,77 @@ llxHeader("",$langs->trans("Projects"),$help_url);
 if ($action == 'create' && $user->rights->projet->creer)
 {
     /*
      * Create
      */
     print_fiche_titre($langs->trans("NewProject"));
 
     dol_htmloutput_mesg($mesg);
 
     print '<form action="'.$_SERVER["PHP_SELF"].'" method="POST">';
     print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
     print '<input type="hidden" name="action" value="add">';
-    print '<input type="hidden" name="backtopage" value="'.GETPOST('backtopage').'">';
+    print '<input type="hidden" name="backtopage" value="'.$backtopage.'">';
 
     print '<table class="border" width="100%">';
 
     $project = new Project($db);
 
     $defaultref='';
     $obj = empty($conf->global->PROJECT_ADDON)?'mod_project_simple':$conf->global->PROJECT_ADDON;
     if (! empty($conf->global->PROJECT_ADDON) && is_readable(DOL_DOCUMENT_ROOT ."/core/modules/project/".$conf->global->PROJECT_ADDON.".php"))
     {
         require_once(DOL_DOCUMENT_ROOT ."/core/modules/project/".$conf->global->PROJECT_ADDON.".php");
         $modProject = new $obj;
         $defaultref = $modProject->getNextValue($soc,$project);
     }
 
     if (is_numeric($defaultref) && $defaultref <= 0) $defaultref='';
 
     // Ref
     print '<tr><td><span class="fieldrequired">'.$langs->trans("Ref").'</span></td><td><input size="12" type="text" name="ref" value="'.($_POST["ref"]?$_POST["ref"]:$defaultref).'"></td></tr>';
 
     // Label
     print '<tr><td><span class="fieldrequired">'.$langs->trans("Label").'</span></td><td><input size="30" type="text" name="title" value="'.$_POST["title"].'"></td></tr>';
 
     // Customer
     print '<tr><td>'.$langs->trans("ThirdParty").'</td><td>';
     $text=$form->select_company(GETPOST("socid"),'socid','',1,1);
     $texthelp=$langs->trans("IfNeedToUseOhterObjectKeepEmpty");
     print $form->textwithtooltip($text.' '.img_help(),$texthelp,1);
     print '</td></tr>';
 
     // Public
     print '<tr><td>'.$langs->trans("Visibility").'</td><td>';
     $array=array(0 => $langs->trans("PrivateProject"),1 => $langs->trans("SharedProject"));
     print $form->selectarray('public',$array,$project->public);
     print '</td></tr>';
 
     // Date start
     print '<tr><td>'.$langs->trans("DateStart").'</td><td>';
     print $form->select_date('','project');
     print '</td></tr>';
 
     // Date end
     print '<tr><td>'.$langs->trans("DateEnd").'</td><td>';
     print $form->select_date(-1,'projectend');
     print '</td></tr>';
 
     // Description
     print '<tr><td valign="top">'.$langs->trans("Description").'</td>';
     print '<td>';
     print '<textarea name="description" wrap="soft" cols="80" rows="'.ROWS_3.'">'.$_POST["description"].'</textarea>';
     print '</td></tr>';
 
     print '</table>';
 
     print '<br><center>';
     print '<input type="submit" class="button" value="'.$langs->trans("Create").'">';
-    if (GETPOST('backtopage'))
+    if (! empty($backtopage))
     {
         print ' &nbsp; &nbsp; ';
 	    print '<input type="submit" class="button" name="cancel" value="'.$langs->trans("Cancel").'">';
     }
     print '</center>';
     print '</form>';
 
 }
diff --git a/htdocs/projet/tasks.php b/htdocs/projet/tasks.php
index c05bac9..6c4ccb7 100644
--- a/htdocs/projet/tasks.php
+++ b/htdocs/projet/tasks.php
@@ -36,6 +36,7 @@ $langs->load("projects");
 $action = GETPOST('action', 'alpha');
 $id = GETPOST('id', 'int');
 $ref = GETPOST('ref', 'alpha');
+$backtopage=GETPOST('backtopage','alpha');
 
 $mode = GETPOST('mode', 'alpha');
 $mine = ($mode == 'mine' ? 1 : 0);
@@ -63,83 +64,83 @@ $object = new Project($db);
 if ($action == 'createtask' && $user->rights->projet->creer)
 {
 	$error=0;
 
 	$date_start = dol_mktime(12,0,0,$_POST['dateomonth'],$_POST['dateoday'],$_POST['dateoyear']);
     $date_end = dol_mktime(12,0,0,$_POST['dateemonth'],$_POST['dateeday'],$_POST['dateeyear']);
 
 	if (empty($_POST["cancel"]))
 	{
 		if (empty($label))
 		{
 			$mesg=$langs->trans("ErrorFieldRequired",$langs->transnoentities("Label"));
 			$action='create';
 			$error++;
 		}
 		else if (empty($_POST['task_parent']))
 		{
 			$mesg=$langs->trans("ErrorFieldRequired",$langs->transnoentities("ChildOfTask"));
 			$action='create';
 			$error++;
 		}
 
 		if (! $error)
 		{
 			$tmparray=explode('_',$_POST['task_parent']);
 			$projectid=$tmparray[0];
 			if (empty($projectid)) $projectid = $id; // If projectid is ''
 			$task_parent=$tmparray[1];
 			if (empty($task_parent)) $task_parent = 0;	// If task_parent is ''
 
 			$task = new Task($db);
 
 			$task->fk_project = $projectid;
 			$task->label = $label;
 			$task->description = $description;
 			$task->fk_task_parent = $task_parent;
 			$task->date_c = dol_now();
 			$task->date_start = $date_start;
 			$task->date_end = $date_end;
 			$task->progress = $progress;
 
 			$taskid = $task->create($user);
 
 			if ($taskid > 0)
 			{
 				$result = $task->add_contact($_POST["userid"], 'TASKEXECUTIVE', 'internal');
 			}
 		}
 
 		if (! $error)
 		{
-		    if (GETPOST('backtopage'))
+		    if (! empty($backtopage))
 			{
-				Header("Location: ".GETPOST('backtopage'));
+				Header("Location: ".$backtopage);
 				exit;
 			}
 			else if (empty($projectid))
 			{
 				Header("Location: ".DOL_URL_ROOT.'/projet/tasks/index.php'.(empty($mode)?'':'?mode='.$mode));
 				exit;
 			}
 		}
 	}
 	else
 	{
-		if (GETPOST('backtopage'))
+		if (! empty($backtopage))
 		{
-			Header("Location: ".GETPOST('backtopage'));
+			Header("Location: ".$backtopage);
 			exit;
 		}
 	    else if (empty($id))
         {
             // We go back on task list
             Header("Location: ".DOL_URL_ROOT.'/projet/tasks/index.php'.(empty($mode)?'':'?mode='.$mode));
             exit;
         }
 	}
 }
 
 /*
  * View
  */
 
@@ -211,62 +212,62 @@ if ($id > 0 || ! empty($ref))
 if ($action == 'create' && $user->rights->projet->creer && (empty($object->societe->id) || $userWrite > 0))
 {
     if ($id > 0 || ! empty($ref)) print '<br>';
 
 	print_fiche_titre($langs->trans("NewTask"));
 
 	dol_htmloutput_errors($mesg);
 
 	print '<form action="'.$_SERVER['PHP_SELF'].'" method="POST">';
 	print '<input type="hidden" name="token" value="'.$_SESSION['newtoken'].'">';
 	print '<input type="hidden" name="action" value="createtask">';
-	print '<input type="hidden" name="backtopage" value="'.GETPOST('backtopage').'">';
+	print '<input type="hidden" name="backtopage" value="'.$backtopage.'">';
 	if (! empty($object->id)) print '<input type="hidden" name="id" value="'.$object->id.'">';
 	if (! empty($mode)) print '<input type="hidden" name="mode" value="'.$mode.'">';
 
 	print '<table class="border" width="100%">';
 
 	print '<tr><td class="fieldrequired">'.$langs->trans("Label").'</td><td>';
 	print '<input type="text" size="25" name="label" class="flat" value="'.$label.'">';
 	print '</td></tr>';
 
 	// List of projects
 	print '<tr><td class="fieldrequired">'.$langs->trans("ChildOfTask").'</td><td>';
 	print $formother->selectProjectTasks('',$projectid?$projectid:$object->id, 'task_parent', 0, 0, 1, 1);
 	print '</td></tr>';
 
 	print '<tr><td>'.$langs->trans("AffectedTo").'</td><td>';
 	print $form->select_users($user->id,'userid',1);
 	print '</td></tr>';
 
 	// Date start
 	print '<tr><td>'.$langs->trans("DateStart").'</td><td>';
 	print $form->select_date(($date_start?$date_start:''),'dateo',0,0,0,'',1,1);
 	print '</td></tr>';
 
 	// Date end
 	print '<tr><td>'.$langs->trans("DateEnd").'</td><td>';
 	print $form->select_date(($date_end?$date_end:-1),'datee',0,0,0,'',1,1);
 	print '</td></tr>';
 
 	// Progress
 	print '<tr><td>'.$langs->trans("Progress").'</td><td colspan="3">';
 	print $formother->select_percent($progress,'progress');
 	print '</td></tr>';
 
 	// Description
 	print '<tr><td valign="top">'.$langs->trans("Description").'</td>';
 	print '<td>';
 	print '<textarea name="description" wrap="soft" cols="80" rows="'.ROWS_3.'">'.$description.'</textarea>';
 	print '</td></tr>';
 
 	print '</table>';
 
 	print '<div align="center"><br>';
 	print '<input type="submit" class="button" name="add" value="'.$langs->trans("Add").'">';
 	print ' &nbsp; &nbsp; ';
 	print '<input type="submit" class="button" name="cancel" value="'.$langs->trans("Cancel").'">';
 	print '</div>';
 
 	print '</form>';
 
 }
diff --git a/htdocs/public/members/new.php b/htdocs/public/members/new.php
index fc7feed..d1d63d0 100644
--- a/htdocs/public/members/new.php
+++ b/htdocs/public/members/new.php
@@ -47,8 +47,8 @@ require_once(DOL_DOCUMENT_ROOT."/core/lib/company.lib.php");
 $errmsg='';
 $num=0;
 $error=0;
-$backtopage=GETPOST('backtopage');
-$action=GETPOST('action');
+$backtopage=GETPOST('backtopage','alpha');
+$action=GETPOST('action','alpha');
 
 // Load translation files
 $langs->load("main");
@@ -132,169 +132,169 @@ function llxFooterVierge()
 if ($action == 'add')
 {
     // test if login already exists
     if (empty($conf->global->ADHERENT_LOGIN_NOT_REQUIRED))
     {
         if(! GETPOST('login'))
         {
             $error+=1;
             $errmsg .= $langs->trans("ErrorFieldRequired",$langs->transnoentitiesnoconv("Login"))."<br>\n";
         }
         $sql = "SELECT login FROM ".MAIN_DB_PREFIX."adherent WHERE login='".$db->escape(GETPOST('login'))."'";
         $result = $db->query($sql);
         if ($result)
         {
             $num = $db->num_rows($result);
         }
         if ($num !=0)
         {
             $error+=1;
             $langs->load("errors");
             $errmsg .= $langs->trans("ErrorLoginAlreadyExists")."<br>\n";
         }
         if (!isset($_POST["pass1"]) || !isset($_POST["pass2"]) || $_POST["pass1"] == '' || $_POST["pass2"] == '' || $_POST["pass1"]!=$_POST["pass2"])
         {
             $error+=1;
             $langs->load("errors");
             $errmsg .= $langs->trans("ErrorPasswordsMustMatch")."<br>\n";
         }
         if (! GETPOST("email"))
         {
             $error+=1;
             $errmsg .= $langs->trans("ErrorFieldRequired",$langs->transnoentitiesnoconv("EMail"))."<br>\n";
         }
     }
     if (GETPOST('type') <= 0)
     {
         $error+=1;
         $errmsg .= $langs->trans("ErrorFieldRequired",$langs->transnoentitiesnoconv("Type"))."<br>\n";
     }
     if (! in_array(GETPOST('morphy'),array('mor','phy')))
     {
         $error+=1;
         $errmsg .= $langs->trans("ErrorFieldRequired",$langs->transnoentitiesnoconv("MorPhy"))."<br>\n";
     }
     if (empty($_POST["nom"]))
     {
         $error+=1;
         $errmsg .= $langs->trans("ErrorFieldRequired",$langs->transnoentitiesnoconv("Lastname"))."<br>\n";
     }
     if (empty($_POST["prenom"]))
     {
         $error+=1;
         $errmsg .= $langs->trans("ErrorFieldRequired",$langs->transnoentitiesnoconv("Firstname"))."<br>\n";
     }
     if (GETPOST("email") && ! isValidEmail(GETPOST("email")))
     {
         $error+=1;
         $langs->load("errors");
         $errmsg .= $langs->trans("ErrorBadEMail",GETPOST("email"))."<br>\n";
     }
     $birthday=dol_mktime($_POST["birthhour"],$_POST["birthmin"],$_POST["birthsec"],$_POST["birthmonth"],$_POST["birthday"],$_POST["birthyear"]);
     if ($_POST["birthmonth"] && empty($birthday))
     {
         $error+=1;
         $langs->load("errors");
         $errmsg .= $langs->trans("ErrorBadDateFormat")."<br>\n";
     }
     if (! empty($conf->global->MEMBER_NEWFORM_DOLIBARRTURNOVER))
     {
         if (GETPOST("morphy") == 'mor' && GETPOST('budget') <= 0)
         {
             $error+=1;
             $errmsg .= $langs->trans("ErrorFieldRequired",$langs->transnoentitiesnoconv("TurnoverOrBudget"))."<br>\n";
         }
     }
 
     if (isset($public)) $public=1;
     else $public=0;
 
     if (! $error)
     {
         // email a peu pres correct et le login n'existe pas
         $adh = new Adherent($db);
         $adh->statut      = -1;
         $adh->public      = $_POST["public"];
         $adh->prenom      = $_POST["prenom"];
         $adh->nom         = $_POST["nom"];
         $adh->civilite_id = $_POST["civilite_id"];
         $adh->societe     = $_POST["societe"];
         $adh->address     = $_POST["address"];
         $adh->zip         = $_POST["zipcode"];
         $adh->town        = $_POST["town"];
         $adh->adresse     = $_POST["address"];    // TODO deprecated
         $adh->cp          = $_POST["zipcode"];    // TODO deprecated
         $adh->ville       = $_POST["town"];    // TODO deprecated
         $adh->email       = $_POST["email"];
         if (empty($conf->global->ADHERENT_LOGIN_NOT_REQUIRED))
         {
             $adh->login       = $_POST["login"];
             $adh->pass        = $_POST["pass1"];
         }
         $adh->photo       = $_POST["photo"];
         $adh->note        = $_POST["note"];
         $adh->country_id  = $_POST["country_id"];
         $adh->pays_id     = $_POST["country_id"];    // TODO deprecated
         $adh->state_id    = $_POST["state_id"];
         $adh->typeid      = $_POST["type"];
         $adh->note        = $_POST["comment"];
         $adh->morphy      = $_POST["morphy"];
         $adh->naiss       = $birthday;
 
         foreach($_POST as $key => $value){
             if (preg_match("/^options_/",$key)){
                 $adh->array_options[$key]=$_POST[$key];
             }
         }
 
         $result=$adh->create($user->id);
         if ($result > 0)
         {
             // Send email to say it has been created and will be validated soon...
             if (! empty($conf->global->ADHERENT_AUTOREGISTER_MAIL) && ! empty($conf->global->ADHERENT_AUTOREGISTER_MAIL_SUBJECT))
             {
                 $result=$adh->send_an_email($conf->global->ADHERENT_AUTOREGISTER_MAIL,$conf->global->ADHERENT_AUTOREGISTER_MAIL_SUBJECT,array(),array(),array(),"","",0,-1);
             }
 
-            if ($backtopage) $urlback=$backtopage;
+            if (! empty($backtopage)) $urlback=$backtopage;
             else if ($conf->global->MEMBER_URL_REDIRECT_SUBSCRIPTION)
             {
                 $urlback=$conf->global->MEMBER_URL_REDIRECT_SUBSCRIPTION;
                 // TODO Make replacement of __AMOUNT__, etc...
             }
             else $urlback=$_SERVER["PHP_SELF"]."?action=added";
 
             if (! empty($conf->global->MEMBER_NEWFORM_PAYONLINE))
             {
                 if ($conf->global->MEMBER_NEWFORM_PAYONLINE == 'paybox')
                 {
                     $urlback=DOL_MAIN_URL_ROOT.'/public/paybox/newpayment.php?from=membernewform&source=membersubscription&ref='.$adh->ref;
                     if (price2num(GETPOST('amount'))) $urlback.='&amount='.price2num(GETPOST('amount'));
                     if (GETPOST('email')) $urlback.='&email='.urlencode(GETPOST('email'));
                 }
                 else if ($conf->global->MEMBER_NEWFORM_PAYONLINE == 'paypal')
                 {
                     $urlback=DOL_MAIN_URL_ROOT.'/public/paypal/newpayment.php?from=membernewform&source=membersubscription&ref='.$adh->ref;
                     if (price2num(GETPOST('amount'))) $urlback.='&amount='.price2num(GETPOST('amount'));
                     if (GETPOST('email')) $urlback.='&email='.urlencode(GETPOST('email'));
                 }
                 else
                 {
                     dol_print_error('',"Autosubscribe form is setup to ask an online payment for a not managed online payment");
                     exit;
                 }
             }
 
             dol_syslog("member ".$adh->ref." was created, we redirect to ".$urlback);
             Header("Location: ".$urlback);
             exit;
         }
         else
         {
             $errmsg .= join('<br>',$adh->errors);
         }
     }
 }
 
 // Action called after a submited was send and member created succesfully
 // If MEMBER_URL_REDIRECT_SUBSCRIPTION is set to url we never go here because a redirect was done to this url.
 // backtopage parameter with an url was set on member submit page, we never go here because a redirect was done to this url.
@@ -545,7 +545,7 @@ print "</table>\n";
 // Save
 print '<br><center>';
 print '<input type="submit" value="'.$langs->trans("Save").'" id="submitsave" class="button">';
-if ($backtopage)
+if (! empty($backtopage))
 {
     print ' &nbsp; &nbsp; <input type="submit" value="'.$langs->trans("Cancel").'" id="submitcancel" class="button">';
 }
