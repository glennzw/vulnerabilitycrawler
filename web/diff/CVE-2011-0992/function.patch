commit 722f9890f09aadfc37ae479e7d946d5fc5ef7b91
Author: Sebastien Pouliot <sebastien@ximian.com>
Date:   Wed Apr 6 13:24:31 2011 -0400

    Fix access to freed members of a dead thread
    
    * threads.c: Fix access to freed members of a dead thread. Found
    and fixed by Rodrigo Kumpera <rkumpera@novell.com>
    Ref: CVE-2011-0992

diff --git a/mono/metadata/threads.c b/mono/metadata/threads.c
index 3fe4e93..a7a721d 100644
--- a/mono/metadata/threads.c
+++ b/mono/metadata/threads.c
@@ -1029,19 +1029,24 @@ HANDLE ves_icall_System_Threading_Thread_Thread_internal(MonoThread *this,
 void ves_icall_System_Threading_InternalThread_Thread_free_internal (MonoInternalThread *this, HANDLE thread)
 {
 	MONO_ARCH_SAVE_REGS;
 
 	THREAD_DEBUG (g_message ("%s: Closing thread %p, handle %p", __func__, this, thread));
 
 	if (thread)
 		CloseHandle (thread);
 
 	if (this->synch_cs) {
-		DeleteCriticalSection (this->synch_cs);
-		g_free (this->synch_cs);
+		CRITICAL_SECTION *synch_cs = this->synch_cs;
 		this->synch_cs = NULL;
+		DeleteCriticalSection (synch_cs);
+		g_free (synch_cs);
 	}
 
-	g_free (this->name);
+	if (this->name) {
+		void *name = this->name;
+		this->name = NULL;
+		g_free (name);
+	}
 }
 
 static void mono_thread_start (MonoThread *thread)
