commit 8ea6f7bc37d05a9ec25b5afbea011cf9de5f1e49
Author: Clay Fouts <cfouts@liblime.com>
Date:   Fri Nov 25 00:06:23 2011 -0800

    [#21464023] Security: arbitrary file inclusion
    
    Poor input cleansing can allow a well-constructed cookie
    to return the contents of arbitrary file system objects.

diff --git a/C4/Output.pm b/C4/Output.pm
index e72c5e1..155c5c4 100644
--- a/C4/Output.pm
+++ b/C4/Output.pm
@@ -133,60 +133,61 @@ sub gettemplate {
 sub themelanguage {
     my ( $htdocs, $tmpl, $interface, $query ) = @_;
     ($query) or warn "no query in themelanguage";
 
     # Set some defaults for language and theme
     # First, check the user's preferences
     my $lang;
     my $http_accept_language = $ENV{ HTTP_ACCEPT_LANGUAGE };
     $lang = accept_language( $http_accept_language, 
               getTranslatedLanguages($interface,'prog') )
       if $http_accept_language;
     # But, if there's a cookie set, obey it
     $lang = $query->cookie('KohaOpacLanguage') if $query->cookie('KohaOpacLanguage');
+    $lang =~ s/[^\p{IsAlnum}\-_]//g;
     # Fall back to English
     my @languages;
     if ($interface eq 'intranet') {
         @languages = split ",", C4::Context->preference("language");
     } else {
         @languages = split ",", C4::Context->preference("opaclanguages");
     }
     if ($lang){  
         @languages=($lang,@languages);
     } else {
         $lang = $languages[0];
     }      
     my $theme = 'prog';	# in the event of theme failure default to 'prog' -fbcit
     my $dbh = C4::Context->dbh;
     my @themes;
     if ( $interface eq "intranet" ) {
         @themes    = split " ", C4::Context->preference("template");
     }
     else {
       # we are in the opac here, what im trying to do is let the individual user
       # set the theme they want to use.
       # and perhaps the them as well.
         #my $lang = $query->cookie('KohaOpacLanguage');
         @themes = split " ", C4::Context->preference("opacthemes");
     }
 
  # searches through the themes and languages. First template it find it returns.
  # Priority is for getting the theme right.
     THEME:
     foreach my $th (@themes) {
         foreach my $la (@languages) {
             #for ( my $pass = 1 ; $pass <= 2 ; $pass += 1 ) {
                 # warn "$htdocs/$th/$la/modules/$interface-"."tmpl";
                 #$la =~ s/([-_])/ $1 eq '-'? '_': '-' /eg if $pass == 2;
 				if ( -e "$htdocs/$th/$la/modules/$tmpl") {
                 #".($interface eq 'intranet'?"modules":"")."/$tmpl" ) {
                     $theme = $th;
                     $lang  = $la;
                     last THEME;
                 }
                 last unless $la =~ /[-_]/;
             #}
         }
     }
     return ( $theme, $lang );
 }
 
