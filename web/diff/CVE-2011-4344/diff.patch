commit 410ed3001d51c689cf59085b7417466caa2ded7b
Author: Kohsuke Kawaguchi <kk@kohsuke.org>
Date:   Tue Nov 1 22:27:09 2011 -0700

    escape error messages which are supposed be plain text and not markup

diff --git a/src/java/winstone/ErrorServlet.java b/src/java/winstone/ErrorServlet.java
index 1854f8d..35c95ca 100644
--- a/src/java/winstone/ErrorServlet.java
+++ b/src/java/winstone/ErrorServlet.java
@@ -42,7 +42,7 @@ public class ErrorServlet extends HttpServlet {
          
         // If we are here there was no error servlet, so show the default error page
         String output = Launcher.RESOURCES.getString("WinstoneResponse.ErrorPage",
-                new String[] { sc + "", (msg == null ? "" : msg), sw.toString(),
+                new String[] { sc + "", URIUtil.htmlEscape(msg == null ? "" : msg), URIUtil.htmlEscape(sw.toString()),
                 Launcher.RESOURCES.getString("ServerVersion"),
                         "" + new Date() });
         response.setContentLength(output.getBytes(response.getCharacterEncoding()).length);
diff --git a/src/java/winstone/URIUtil.java b/src/java/winstone/URIUtil.java
index a2fba88..97d7fdc 100644
--- a/src/java/winstone/URIUtil.java
+++ b/src/java/winstone/URIUtil.java
@@ -50,4 +50,21 @@ public class URIUtil {
         return buf.toString();
     }
 
+    /**
+     * Performs necessary escaping to render arbitrary plain text as plain text without any markup.
+     */
+    public static String htmlEscape(String text) {
+        StringBuilder buf = new StringBuilder(text.length()+64);
+        for( int i=0; i<text.length(); i++ ) {
+            char ch = text.charAt(i);
+            if(ch=='<')
+                buf.append("&lt;");
+            else
+            if(ch=='&')
+                buf.append("&amp;");
+            else
+                buf.append(ch);
+        }
+        return buf.toString();
+    }
 }
diff --git a/src/java/winstone/WinstoneResponse.java b/src/java/winstone/WinstoneResponse.java
index 3746b40..d6b2c95 100644
--- a/src/java/winstone/WinstoneResponse.java
+++ b/src/java/winstone/WinstoneResponse.java
@@ -805,7 +805,7 @@ public class WinstoneResponse implements HttpServletResponse {
             this.statusCode = sc;
         }
         String output = Launcher.RESOURCES.getString("WinstoneResponse.ErrorPage",
-                new String[] { sc + "", (msg == null ? "" : msg), "",
+                new String[] { sc + "", URIUtil.htmlEscape(msg == null ? "" : msg), "",
                         Launcher.RESOURCES.getString("ServerVersion"),
                         "" + new Date() });
         setContentLength(output.getBytes(getCharacterEncoding()).length);
