commit 2f597ea9f1f363277fd4dfc109fa41bbc6225aca
Author: Matthias Clasen <mclasen@redhat.com>
Date:   Mon Nov 2 17:00:23 2009 -0500

    Fix adding monitors
    
    Make sure to show windows that are added.  And fix an off by one bug.

diff --git a/src/gs-manager.c b/src/gs-manager.c
index e8ffc0b..bb0ddf6 100644
--- a/src/gs-manager.c
+++ b/src/gs-manager.c
@@ -1428,65 +1428,73 @@ static void
 gs_manager_create_window_for_monitor (GSManager *manager,
                                       GdkScreen *screen,
                                       int        monitor)
 {
         GSWindow    *window;
         GdkRectangle rect;
 
         gdk_screen_get_monitor_geometry (screen, monitor, &rect);
 
         gs_debug ("Creating window for monitor %d [%d,%d] (%dx%d)",
                   monitor, rect.x, rect.y, rect.width, rect.height);
 
         window = gs_window_new (screen, monitor, manager->priv->lock_active);
 
         gs_window_set_user_switch_enabled (window, manager->priv->user_switch_enabled);
         gs_window_set_logout_enabled (window, manager->priv->logout_enabled);
         gs_window_set_logout_timeout (window, manager->priv->logout_timeout);
         gs_window_set_logout_command (window, manager->priv->logout_command);
         gs_window_set_keyboard_enabled (window, manager->priv->keyboard_enabled);
         gs_window_set_keyboard_command (window, manager->priv->keyboard_command);
         gs_window_set_status_message (window, manager->priv->status_message);
 
         connect_window_signals (manager, window);
 
         manager->priv->windows = g_slist_append (manager->priv->windows, window);
+
+        if (manager->priv->active && !manager->priv->fading) {
+                gtk_widget_show (window);
+        }
 }
 
 static void
 on_screen_monitors_changed (GdkScreen *screen,
                             GSManager *manager)
 {
         GSList *l;
         int     n_monitors;
         int     n_windows;
         int     i;
 
         n_monitors = gdk_screen_get_n_monitors (screen);
         n_windows = g_slist_length (manager->priv->windows);
 
         gs_debug ("Monitors changed for screen %d: num=%d",
                   gdk_screen_get_number (screen),
                   n_monitors);
 
         if (n_monitors > n_windows) {
                 /* add more windows */
                 for (i = n_windows; i < n_monitors; i++) {
-                        gs_manager_create_window_for_monitor (manager, screen, i - 1);
+                        gs_manager_create_window_for_monitor (manager, screen, i);
                 }
         } else {
                 /* remove the extra windows */
-                for (l = manager->priv->windows; l != NULL; l = l->next) {
+                l = manager->priv->windows;
+                while (l != NULL) {
                         GdkScreen *this_screen;
                         int        this_monitor;
+                        GSList    *next = l->next;
 
                         this_screen = gs_window_get_screen (GS_WINDOW (l->data));
                         this_monitor = gs_window_get_monitor (GS_WINDOW (l->data));
                         if (this_screen == screen && this_monitor >= n_monitors) {
                                 manager_maybe_stop_job_for_window (manager, GS_WINDOW (l->data));
+                                g_hash_table_remove (manager->priv->jobs, l->data);
                                 gs_window_destroy (GS_WINDOW (l->data));
                                 manager->priv->windows = g_slist_delete_link (manager->priv->windows, l);
                         }
+                        l = next;
                 }
         }
 }
 
