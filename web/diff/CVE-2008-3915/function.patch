commit 91b80969ba466ba4b915a4a1d03add8c297add3f
Author: J. Bruce Fields <bfields@citi.umich.edu>
Date:   Fri Aug 29 19:18:45 2008 -0400

    nfsd: fix buffer overrun decoding NFSv4 acl
    
    The array we kmalloc() here is not large enough.
    
    Thanks to Johann Dahm and David Richter for bug report and testing.
    
    Signed-off-by: J. Bruce Fields <bfields@citi.umich.edu>
    Cc: David Richter <richterd@citi.umich.edu>
    Tested-by: Johann Dahm <jdahm@umich.edu>

diff --git a/fs/nfsd/nfs4acl.c b/fs/nfsd/nfs4acl.c
index b6ed383..54b8b41 100644
--- a/fs/nfsd/nfs4acl.c
+++ b/fs/nfsd/nfs4acl.c
@@ -434,24 +434,24 @@ static int
 init_state(struct posix_acl_state *state, int cnt)
 {
 	int alloc;
 
 	memset(state, 0, sizeof(struct posix_acl_state));
 	state->empty = 1;
 	/*
 	 * In the worst case, each individual acl could be for a distinct
 	 * named user or group, but we don't no which, so we allocate
 	 * enough space for either:
 	 */
 	alloc = sizeof(struct posix_ace_state_array)
-		+ cnt*sizeof(struct posix_ace_state);
+		+ cnt*sizeof(struct posix_user_ace_state);
 	state->users = kzalloc(alloc, GFP_KERNEL);
 	if (!state->users)
 		return -ENOMEM;
 	state->groups = kzalloc(alloc, GFP_KERNEL);
 	if (!state->groups) {
 		kfree(state->users);
 		return -ENOMEM;
 	}
 	return 0;
 }
 
