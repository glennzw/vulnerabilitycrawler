commit dd50a50a2760f10bd2d09814e30af4b36052ca6d
Author: ashcs <ashcs@.(none)>
Date:   Sun Sep 18 10:10:01 2011 +0700

    Fix XSS vulnerabilities described on http://seclists.org/fulldisclosure/2011/Sep/158

diff --git a/include/functions.php b/include/functions.php
index 703d640..ca9bf20 100644
--- a/include/functions.php
+++ b/include/functions.php
@@ -1,14 +1,14 @@
 <?php
 /**
  * Loads common functions used throughout the site.
  *
- * @copyright (C) 2008-2009 PunBB, partially based on code (C) 2008-2009 FluxBB.org
+ * @copyright (C) 2008-2011 PunBB, partially based on code (C) 2008-2009 FluxBB.org
  * @license http://www.gnu.org/licenses/gpl.html GPL version 2 or higher
  * @package PunBB
  */
 
 //
 // Common helpers and forum's wrappers for PHP functions
 //
 
 // Encodes the contents of $str so that they are safe to output on an (X)HTML page
@@ -2602,98 +2602,98 @@ function send_subscriptions($post_info, $new_pid)
 function csrf_confirm_form()
 {
 	global $forum_db, $forum_url, $lang_common, $forum_config, $base_url, $forum_start, $tpl_main, $forum_user, $forum_page, $forum_updates;
 
 	// If we've disabled the CSRF check for this page, we have nothing to do here.
 	if (defined('FORUM_DISABLE_CSRF_CONFIRM'))
 		return;
 
 	// User pressed the cancel button
 	if (isset($_POST['confirm_cancel']))
 		redirect(forum_htmlencode($_POST['prev_url']), $lang_common['Cancel redirect']);
 
 	// A helper function for csrf_confirm_form. It takes a multi-dimensional array and returns it as a
 	// single-dimensional array suitable for use in hidden fields.
 	function _csrf_confirm_form($key, $values)
 	{
 		$fields = array();
 
 		if (is_array($values))
 		{
 			foreach ($values as $cur_key => $cur_values)
 				$fields = array_merge($fields, _csrf_confirm_form($key.'['.$cur_key.']', $cur_values));
 
 			return $fields;
 		}
 		else
 			$fields[$key] = $values;
 
 		return $fields;
 	}
 
 	$return = ($hook = get_hook('fn_csrf_confirm_form_start')) ? eval($hook) : null;
 	if ($return != null)
 		return;
 
 	// Setup breadcrumbs
 	$forum_page['crumbs'] = array(
 		array($forum_config['o_board_title'], forum_link($forum_url['index'])),
 		$lang_common['Confirm action']
 	);
 
 	$forum_page['form_action'] = get_current_url();
 
 	$forum_page['hidden_fields'] = array(
 		'csrf_token'	=> '<input type="hidden" name="csrf_token" value="'.generate_form_token($forum_page['form_action']).'" />',
 		'prev_url'		=> '<input type="hidden" name="prev_url" value="'.forum_htmlencode($forum_user['prev_url']).'" />'
 	);
 
 	foreach ($_POST as $submitted_key => $submitted_val)
 		if ($submitted_key != 'csrf_token' && $submitted_key != 'prev_url')
 		{
 			$hidden_fields = _csrf_confirm_form($submitted_key, $submitted_val);
 			foreach ($hidden_fields as $field_key => $field_val)
 				$forum_page['hidden_fields'][$field_key] = '<input type="hidden" name="'.forum_htmlencode($field_key).'" value="'.forum_htmlencode($field_val).'" />';
 		}
 
 	define('FORUM_PAGE', 'dialogue');
 	require FORUM_ROOT.'header.php';
 
 	// START SUBST - <!-- forum_main -->
 	ob_start();
 
 	($hook = get_hook('fn_csrf_confirm_form_pre_header_load')) ? eval($hook) : null;
 
 ?>
 <div id="brd-main" class="main">
 	<div class="main-head">
 		<h2 class="hn"><span><?php echo $lang_common['Confirm action head'] ?></span></h2>
 	</div>
 	<div class="main-content main-frm">
 		<div class="ct-box info-box">
 			<p><?php echo $lang_common['CSRF token mismatch'] ?></p>
 		</div>
-		<form class="frm-form" method="post" accept-charset="utf-8" action="<?php echo $forum_page['form_action'] ?>">
+		<form class="frm-form" method="post" accept-charset="utf-8" action="<?php echo forum_htmlencode($forum_page['form_action']) ?>">
 			<div class="hidden">
 				<?php echo implode("\n\t\t\t\t", $forum_page['hidden_fields'])."\n" ?>
 			</div>
 			<div class="frm-buttons">
 				<span class="submit"><input type="submit" value="<?php echo $lang_common['Confirm'] ?>" /></span>
 				<span class="cancel"><input type="submit" name="confirm_cancel" value="<?php echo $lang_common['Cancel'] ?>" /></span>
 			</div>
 		</form>
 	</div>
 </div>
 <?php
 
 	($hook = get_hook('fn_csrf_confirm_form_end')) ? eval($hook) : null;
 
 	$tpl_temp = forum_trim(ob_get_contents());
 	$tpl_main = str_replace('<!-- forum_main -->', $tpl_temp, $tpl_main);
 	ob_end_clean();
 	// END SUBST - <!-- forum_main -->
 
 	require FORUM_ROOT.'footer.php';
 }
 
 
 // Display a message
