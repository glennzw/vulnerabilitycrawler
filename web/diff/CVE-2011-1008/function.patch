commit 2338cd19ed7a7f4c1e94f639ab2789d6586d01f3
Author: sunnavy <sunnavy@bestpractical.com>
Date:   Thu May 13 20:28:35 2010 +0800

    security fix: clone the ticket to set CurrentUser

diff --git a/lib/RT/Scrips_Overlay.pm b/lib/RT/Scrips_Overlay.pm
index df24b3c..1d30702 100644
--- a/lib/RT/Scrips_Overlay.pm
+++ b/lib/RT/Scrips_Overlay.pm
@@ -276,35 +276,38 @@ Returns: nothing
 sub _SetupSourceObjects {
 
     my $self = shift;
     my %args = ( 
             TicketObj => undef,
             Ticket => undef,
             Transaction => undef,
             TransactionObj => undef,
             @_ );
 
-    if ( ( $self->{'TicketObj'} = $args{'TicketObj'} ) ) {
+
+    if ( $args{'TicketObj'} ) {
+        # clone the ticket here as we need to change CurrentUser
+        $self->{'TicketObj'} = bless { %{$args{'TicketObj'} } }, 'RT::Ticket';
         $self->{'TicketObj'}->CurrentUser( $self->CurrentUser );
     }
     else {
         $self->{'TicketObj'} = RT::Ticket->new( $self->CurrentUser );
         $self->{'TicketObj'}->Load( $args{'Ticket'} )
           || $RT::Logger->err("$self couldn't load ticket $args{'Ticket'}");
     }
 
     if ( ( $self->{'TransactionObj'} = $args{'TransactionObj'} ) ) {
         $self->{'TransactionObj'}->CurrentUser( $self->CurrentUser );
     }
     else {
         $self->{'TransactionObj'} = RT::Transaction->new( $self->CurrentUser );
         $self->{'TransactionObj'}->Load( $args{'Transaction'} )
           || $RT::Logger->err( "$self couldn't load transaction $args{'Transaction'}");
     }
 } 
 
 # }}}
 
 # {{{ sub _FindScrips;
 
 =head2 _FindScrips
 
