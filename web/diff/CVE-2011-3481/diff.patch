commit 6e776956a1a9dfa58eacdd0ddd52644009eac9e5
Author: Bron Gondwana <brong@opera.com>
Date:   Fri Aug 12 15:49:25 2011 +0200

    Bug #2772/3463 - fold references header

diff --git a/imap/index.c b/imap/index.c
index 6af5775..74afc21 100644
--- a/imap/index.c
+++ b/imap/index.c
@@ -175,6 +175,7 @@ static struct seqset *_index_vanished(struct index_state *state,
 				      struct vanished_params *params);
 static struct seqset *_parse_sequence(struct index_state *state,
 				      const char *sequence, int usinguid);
+static void massage_header(char *hdr);
 
 /* NOTE: Make sure these are listed in CAPABILITY_STRING */
 static const struct thread_algorithm thread_algs[] = {
@@ -3962,6 +3963,7 @@ void index_get_ids(MsgData *msgdata, char *envtokens[], const char *headers,
 	/* allocate some space for refs */
 	msgdata->ref = (char **) xmalloc(refsize * sizeof(char *));
 	/* find references */
+	massage_header(buf);
 	refstr = buf;
 	while ((ref = find_msgid(refstr, &refstr)) != NULL) {
 	    /* reallocate space for this msgid if necessary */
