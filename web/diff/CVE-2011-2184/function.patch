commit f7285b5d631fd6096b11c6af0058ed3a2b30ef4e
Author: Serge E. Hallyn <serge@hallyn.com>
Date:   Thu May 26 15:25:05 2011 -0500

    Set cred->user_ns in key_replace_session_keyring
    
    Since this cred was not created with copy_creds(), it needs to get
    initialized.  Otherwise use of syscall(__NR_keyctl, KEYCTL_SESSION_TO_PARENT);
    can lead to a NULL deref.  Thanks to Robert for finding this.
    
    But introduced by commit 47a150edc2a ("Cache user_ns in struct cred").
    
    Signed-off-by: Serge E. Hallyn <serge.hallyn@canonical.com>
    Reported-by: Robert Święcki <robert@swiecki.net>
    Cc: David Howells <dhowells@redhat.com>
    Cc: stable@kernel.org (2.6.39)
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

diff --git a/security/keys/process_keys.c b/security/keys/process_keys.c
index 6c0480d..a3063eb 100644
--- a/security/keys/process_keys.c
+++ b/security/keys/process_keys.c
@@ -824,43 +824,44 @@ error:
 void key_replace_session_keyring(void)
 {
 	const struct cred *old;
 	struct cred *new;
 
 	if (!current->replacement_session_keyring)
 		return;
 
 	write_lock_irq(&tasklist_lock);
 	new = current->replacement_session_keyring;
 	current->replacement_session_keyring = NULL;
 	write_unlock_irq(&tasklist_lock);
 
 	if (!new)
 		return;
 
 	old = current_cred();
 	new->  uid	= old->  uid;
 	new-> euid	= old-> euid;
 	new-> suid	= old-> suid;
 	new->fsuid	= old->fsuid;
 	new->  gid	= old->  gid;
 	new-> egid	= old-> egid;
 	new-> sgid	= old-> sgid;
 	new->fsgid	= old->fsgid;
 	new->user	= get_uid(old->user);
+	new->user_ns	= new->user->user_ns;
 	new->group_info	= get_group_info(old->group_info);
 
 	new->securebits	= old->securebits;
 	new->cap_inheritable	= old->cap_inheritable;
 	new->cap_permitted	= old->cap_permitted;
 	new->cap_effective	= old->cap_effective;
 	new->cap_bset		= old->cap_bset;
 
 	new->jit_keyring	= old->jit_keyring;
 	new->thread_keyring	= key_get(old->thread_keyring);
 	new->tgcred->tgid	= old->tgcred->tgid;
 	new->tgcred->process_keyring = key_get(old->tgcred->process_keyring);
 
 	security_transfer_creds(new, old);
 
 	commit_creds(new);
 }
