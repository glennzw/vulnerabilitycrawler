commit f7285b5d631fd6096b11c6af0058ed3a2b30ef4e
Author: Serge E. Hallyn <serge@hallyn.com>
Date:   Thu May 26 15:25:05 2011 -0500

    Set cred->user_ns in key_replace_session_keyring
    
    Since this cred was not created with copy_creds(), it needs to get
    initialized.  Otherwise use of syscall(__NR_keyctl, KEYCTL_SESSION_TO_PARENT);
    can lead to a NULL deref.  Thanks to Robert for finding this.
    
    But introduced by commit 47a150edc2a ("Cache user_ns in struct cred").
    
    Signed-off-by: Serge E. Hallyn <serge.hallyn@canonical.com>
    Reported-by: Robert Święcki <robert@swiecki.net>
    Cc: David Howells <dhowells@redhat.com>
    Cc: stable@kernel.org (2.6.39)
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>

diff --git a/security/keys/process_keys.c b/security/keys/process_keys.c
index 6c0480d..a3063eb 100644
--- a/security/keys/process_keys.c
+++ b/security/keys/process_keys.c
@@ -847,6 +847,7 @@ void key_replace_session_keyring(void)
 	new-> sgid	= old-> sgid;
 	new->fsgid	= old->fsgid;
 	new->user	= get_uid(old->user);
+	new->user_ns	= new->user->user_ns;
 	new->group_info	= get_group_info(old->group_info);
 
 	new->securebits	= old->securebits;
