commit d13dd72531599ab7e4c747db3b58a8c17753e08d
Author: Vincent Untz <vuntz@gnome.org>
Date:   Mon May 23 18:34:46 2011 +0200

    Register /bin/true as URI scheme handler for several schemes
    
    Starting with glib 2.28, we don't use gconf to find out which handler
    should be used for a URI scheme, and we need to provide a custom MIME
    configuration for the gdm user to ensure no default URI scheme handler
    is used.
    
    CVE-2011-1709

diff --git a/data/Makefile.am b/data/Makefile.am
index 4b13387..f252b64 100644
--- a/data/Makefile.am
+++ b/data/Makefile.am
@@ -83,21 +83,23 @@ dist_session_DATA = gdm.session
 EXTRA_DIST =			\
 	$(schemas_in_files)	\
 	$(schemas_DATA)		\
 	$(dbusconf_in_files)	\
 	$(localealias_DATA)	\
 	gdm.schemas.in.in	\
 	gdm.conf-custom.in 	\
 	Xsession.in 		\
 	gdm 			\
 	gdm-autologin 		\
 	Init.in 		\
 	PreSession.in 		\
 	PostSession.in 		\
 	PostLogin 		\
 	gconf.path		\
 	session-setup.entries	\
 	make-dconf-override-db.sh \
 	dconf-profile \
+	mime-dummy-handler.desktop	\
+	mimeapps.list			\
 	$(NULL)
 
 CLEANFILES = 				\
@@ -152,126 +154,134 @@ uninstall-hook:
 install-data-hook: gdm.conf-custom Xsession Init PostSession PreSession gconf.path dconf-override-db
 	if test '!' -d $(DESTDIR)$(gdmconfdir); then \
 		$(mkinstalldirs) $(DESTDIR)$(gdmconfdir); \
 		chmod 755 $(DESTDIR)$(gdmconfdir); \
 	fi
 	if test '!' -f $(DESTDIR)$(GDM_CUSTOM_CONF); then \
 		$(INSTALL_DATA) gdm.conf-custom $(DESTDIR)$(GDM_CUSTOM_CONF); \
 		chmod 644 $(DESTDIR)$(GDM_CUSTOM_CONF); \
 	fi
 
 	$(INSTALL_SCRIPT) Xsession $(DESTDIR)$(gdmconfdir)/Xsession
 
 	if test '!' -d $(DESTDIR)$(initdir); then \
 		$(mkinstalldirs) $(DESTDIR)$(initdir); \
 		chmod 755 $(DESTDIR)$(initdir); \
 	fi
 	-if test -f $(DESTDIR)$(initdir)/Default; then \
 		cp -f $(DESTDIR)$(initdir)/Default $(DESTDIR)$(initdir)/Default.orig; \
 	fi
 	$(INSTALL_SCRIPT) Init $(DESTDIR)$(initdir)/Default
 
 	if test '!' -d $(DESTDIR)$(postlogindir); then \
 		$(mkinstalldirs) $(DESTDIR)$(postlogindir); \
 		chmod 755 $(DESTDIR)$(postlogindir); \
 	fi
 	$(INSTALL_SCRIPT) $(srcdir)/PostLogin $(DESTDIR)$(postlogindir)/Default.sample
 
 	if test '!' -d $(DESTDIR)$(predir); then \
 		$(mkinstalldirs) $(DESTDIR)$(predir); \
 		chmod 755 $(DESTDIR)$(predir); \
 	fi
 	-if test -f $(DESTDIR)$(predir)/Default; then \
 		cp -f $(DESTDIR)$(predir)/Default $(DESTDIR)$(predir)/Default.orig; \
 	fi
 	$(INSTALL_SCRIPT) PreSession $(DESTDIR)$(predir)/Default
 
 	if test '!' -d $(DESTDIR)$(postdir); then \
 		$(mkinstalldirs) $(DESTDIR)$(postdir); \
 		chmod 755 $(DESTDIR)$(postdir); \
 	fi
 	-if test -f $(DESTDIR)$(postdir)/Default; then \
 		cp -f $(DESTDIR)$(postdir)/Default $(DESTDIR)$(postdir)/Default.orig; \
 	fi
 	$(INSTALL_SCRIPT) PostSession $(DESTDIR)$(postdir)/Default
 
 	if test '!' -d $(DESTDIR)$(logdir); then \
 		$(mkinstalldirs) $(DESTDIR)$(logdir); \
 		chmod 755 $(DESTDIR)$(logdir); \
 		chown root:root $(DESTDIR)$(logdir) || : ; \
 	fi
 
 	if test '!' -d $(DESTDIR)$(authdir); then \
 		$(mkinstalldirs) $(DESTDIR)$(authdir); \
 		chmod 1770 $(DESTDIR)$(authdir); \
 		chown root:gdm $(DESTDIR)$(authdir) || : ; \
 	fi
 
 	system=`uname`; \
 	if test -f /usr/include/security/pam_appl.h; then \
 	  if test '!' -d $(DESTDIR)$(PAM_PREFIX)/pam.d; then \
 		$(mkinstalldirs) $(DESTDIR)$(PAM_PREFIX)/pam.d; \
 		chmod 755 $(DESTDIR)$(PAM_PREFIX)/pam.d; \
 	   fi; \
 	   if test $$system = Linux && test '!' -f $(DESTDIR)$(PAM_PREFIX)/pam.d/gdm; then \
 		$(INSTALL_DATA) $(srcdir)/gdm $(DESTDIR)$(PAM_PREFIX)/pam.d/gdm; \
 	   fi; \
 	   if test $$system = Linux && test '!' -f $(DESTDIR)$(PAM_PREFIX)/pam.d/gdm-autologin; then \
 		$(INSTALL_DATA) $(srcdir)/gdm-autologin $(DESTDIR)$(PAM_PREFIX)/pam.d/gdm-autologin; \
 	   fi; \
 	   if test $$system = SunOS; then \
 		echo "Please add PAM authentication for gdm and gdm-autologin in $(PAM_PREFIX)/pam.conf!"; \
 	   fi; \
 	fi
 
 	if test '!' -d $(DESTDIR)$(xauthdir); then \
 		$(mkinstalldirs) $(DESTDIR)$(xauthdir); \
 		chmod 0711 $(DESTDIR)$(xauthdir); \
 		chown root:gdm $(DESTDIR)$(xauthdir) || : ; \
 	fi
 
 	if test '!' -d $(DESTDIR)$(screenshotdir); then \
 		$(mkinstalldirs) $(DESTDIR)$(screenshotdir); \
 		chmod 0755 $(DESTDIR)$(screenshotdir); \
 		chown gdm:gdm $(DESTDIR)$(screenshotdir) || : ; \
 	fi
 
 	if test '!' -d $(DESTDIR)$(workingdir); then \
 		$(mkinstalldirs) $(DESTDIR)$(workingdir); \
 		chmod 1770 $(DESTDIR)$(workingdir); \
 		chown root:gdm $(DESTDIR)$(workingdir) || : ; \
 	fi
 
 	if test '!' -d $(DESTDIR)$(workingdir)/.config/dconf; then \
 		$(mkinstalldirs) $(DESTDIR)$(workingdir)/.config/dconf; \
 		chmod 0755 $(DESTDIR)$(workingdir)/.config/dconf; \
 		chown gdm:gdm $(DESTDIR)$(workingdir)/.config/dconf || : ; \
 	fi
 
+	if test '!' -d $(DESTDIR)$(workingdir)/.local/share/applications; then \
+		$(mkinstalldirs) $(DESTDIR)$(workingdir)/.local/share/applications; \
+		chmod 0755 $(DESTDIR)$(workingdir)/.local/share/applications; \
+		chown gdm:gdm $(DESTDIR)$(workingdir)/.local/share/applications || : ; \
+	fi
+
 	if test '!' -d $(DESTDIR)$(sysconfdir)/dconf/profile; then \
 		$(mkinstalldirs) $(DESTDIR)$(sysconfdir)/dconf/profile; \
 		chmod 0755 $(DESTDIR)$(sysconfdir)/dconf/profile; \
 		chown root:root $(DESTDIR)$(sysconfdir)/dconf/profile || : ; \
 	fi
 
 	if test '!' -d $(DESTDIR)$(sysconfdir)/dconf/db; then \
 		$(mkinstalldirs) $(DESTDIR)$(sysconfdir)/dconf/db; \
 		chmod 0755 $(DESTDIR)$(sysconfdir)/dconf/db; \
 		chown root:root $(DESTDIR)$(sysconfdir)/dconf/db || : ; \
 	fi
 
 	if test '!' -d $(DESTDIR)$(cachedir); then \
 		$(mkinstalldirs) $(DESTDIR)$(cachedir); \
 		chmod 1755 $(DESTDIR)$(cachedir); \
 		chown root:gdm $(DESTDIR)$(cachedir) || : ; \
 	fi
 
 	$(INSTALL_DATA) $(srcdir)/gconf.path $(DESTDIR)$(workingdir)/.gconf.path
 	gconftool-2 --direct --config-source=xml:merged:$(DESTDIR)$(workingdir)/.gconf.mandatory --recursive-unset /
 	gconftool-2 --direct --config-source=xml:merged:$(DESTDIR)$(workingdir)/.gconf.mandatory --load $(srcdir)/session-setup.entries
 	chown -R root:gdm $(DESTDIR)$(workingdir)/.gconf.mandatory || :
 	chmod 1750 $(DESTDIR)$(workingdir)/.gconf.mandatory
 	chmod 1640 $(DESTDIR)$(workingdir)/.gconf.mandatory/*.xml
 
 	$(INSTALL_DATA) $(srcdir)/dconf-override-db $(DESTDIR)$(sysconfdir)/dconf/db/gdm
 	$(INSTALL_DATA) $(srcdir)/dconf-profile $(DESTDIR)$(sysconfdir)/dconf/profile/gdm
 
+	$(INSTALL_DATA) $(srcdir)/mime-dummy-handler.desktop $(DESTDIR)$(workingdir)/.local/share/applications/mime-dummy-handler.desktop
+	$(INSTALL_DATA) $(srcdir)/mimeapps.list $(DESTDIR)$(workingdir)/.local/share/applications/mimeapps.list
diff --git a/data/mime-dummy-handler.desktop b/data/mime-dummy-handler.desktop
new file mode 100644
index 0000000..c94779c
--- /dev/null
+++ b/data/mime-dummy-handler.desktop
@@ -0,0 +1,6 @@
+[Desktop Entry]
+Type=Application
+Name=Dummy URI Handler
+Exec=/bin/true %U
+Terminal=false
+StartupNotify=false
diff --git a/data/mimeapps.list b/data/mimeapps.list
new file mode 100644
index 0000000..db3a144
--- /dev/null
+++ b/data/mimeapps.list
@@ -0,0 +1,19 @@
+[Default Applications]
+x-scheme-handler/file=mime-dummy-handler.desktop
+x-scheme-handler/ftp=mime-dummy-handler.desktop
+x-scheme-handler/ghelp=mime-dummy-handler.desktop
+x-scheme-handler/help=mime-dummy-handler.desktop
+x-scheme-handler/http=mime-dummy-handler.desktop
+x-scheme-handler/https=mime-dummy-handler.desktop
+x-scheme-handler/info=mime-dummy-handler.desktop
+x-scheme-handler/irc=mime-dummy-handler.desktop
+x-scheme-handler/itms=mime-dummy-handler.desktop
+x-scheme-handler/mailto=mime-dummy-handler.desktop
+x-scheme-handler/man=mime-dummy-handler.desktop
+x-scheme-handler/mms=mime-dummy-handler.desktop
+x-scheme-handler/rtp=mime-dummy-handler.desktop
+x-scheme-handler/rtsp=mime-dummy-handler.desktop
+x-scheme-handler/sip=mime-dummy-handler.desktop
+x-scheme-handler/trash=mime-dummy-handler.desktop
+x-scheme-handler/webcal=mime-dummy-handler.desktop
+x-scheme-handler/xmpp=mime-dummy-handler.desktop
