commit 317f3db3a3c68775de3acf3b15f55b1e3c18f93b
Author: David Hicks <d@hx.id.au>
Date:   Fri Aug 19 00:43:04 2011 +1000

    Fix #13245: XSS issues with search.php parameters
    
    Net.Edit0r (Net.Edit0r@Att.net) from BlACK Hat Group
    [http://black-hg.org] posted a vulnerability report for an XSS issue in
    search.php for MantisBT 1.2.6.
    
    The full report is available at
    http://packetstormsecurity.org/files/104149
    
    filter_api.php is the culprit for this vulnerability as it passes user
    supplied search parameters back into output without first escaping the
    values.
    
    It should be noted that numerous other XSS vulnerabilities (all related)
    have been fixed with this patch. In other words, it is not just the
    project_id parameter to search.php that was affected - it was numerous
    other parameters/fields as well.
    
    The second SQL injection vulnerability identified by Net.Edit0r is
    invalid because the only time we ever make reference to "mbadmin" in the
    source code is:
    
    core.php:
    if ( file_exists( 'mantis_offline.php' ) && !isset( $_GET['mbadmin'] ) )
    
    This usage is safe because nothing is ever done with $_GET['mbadmin'].
    It may be the case that the user's customised version of
    mantis_offline.php was incorrectly dumping the value of $_GET['mbadmin']
    to the screen. The default/sample mantis_offline.php has been checked
    and does not print any dynamically created strings/user supplied values.

diff --git a/core/filter_api.php b/core/filter_api.php
index 96a0b8c..4224472 100644
--- a/core/filter_api.php
+++ b/core/filter_api.php
@@ -2078,1394 +2078,1394 @@ function filter_draw_selection_area( $p_page_number, $p_for_screen = true ) {
 function filter_draw_selection_area2( $p_page_number, $p_for_screen = true, $p_expanded = true ) {
 	$t_form_name_suffix = $p_expanded ? '_open' : '_closed';
 
 	$t_filter = current_user_get_bug_filter();
 	$t_filter = filter_ensure_valid_filter( $t_filter );
 	$t_project_id = helper_get_current_project();
 	$t_page_number = (int) $p_page_number;
 
 	$t_view_type = $t_filter['_view_type'];
 
 	$t_tdclass = 'small-caption';
 	$t_trclass = 'row-category2';
 	$t_action = 'view_all_set.php?f=3';
 
 	if( $p_for_screen == false ) {
 		$t_tdclass = 'print';
 		$t_trclass = '';
 		$t_action = 'view_all_set.php';
 	}
 	?>
 
 		<br />
 		<form method="post" name="filters<?php echo $t_form_name_suffix?>" id="filters_form<?php echo $t_form_name_suffix?>" action="<?php echo $t_action;?>">
 		<?php # CSRF protection not required here - form does not result in modifications ?>
 		<input type="hidden" name="type" value="1" />
 		<?php
 			if( $p_for_screen == false ) {
 		echo '<input type="hidden" name="print" value="1" />';
 		echo '<input type="hidden" name="offset" value="0" />';
 	}
 	?>
 		<input type="hidden" name="page_number" value="<?php echo $t_page_number?>" />
 		<input type="hidden" name="view_type" value="<?php echo $t_view_type?>" />
 		<table class="width100" cellspacing="1">
 
 		<?php
 		$t_filter_cols = config_get( 'filter_custom_fields_per_row' );
 	if( $p_expanded ) {
 		$t_custom_cols = $t_filter_cols;
 
 		$t_current_user_access_level = current_user_get_access_level();
 		$t_accessible_custom_fields_ids = array();
 		$t_accessible_custom_fields_names = array();
 		$t_accessible_custom_fields_values = array();
 		$t_num_custom_rows = 0;
 		$t_per_row = 0;
 
 		if( ON == config_get( 'filter_by_custom_fields' ) ) {
 			$t_custom_fields = custom_field_get_linked_ids( $t_project_id );
 
 			foreach( $t_custom_fields as $t_cfid ) {
 				$t_field_info = custom_field_cache_row( $t_cfid, true );
 				if( $t_field_info['access_level_r'] <= $t_current_user_access_level && $t_field_info['filter_by'] ) {
 					$t_accessible_custom_fields_ids[] = $t_cfid;
 					$t_accessible_custom_fields_names[] = $t_field_info['name'];
 					$t_accessible_custom_fields_types[] = $t_field_info['type'];
 					$t_accessible_custom_fields_values[] = custom_field_distinct_values( $t_field_info );
 				}
 			}
 
 			if( count( $t_accessible_custom_fields_ids ) > 0 ) {
 				$t_per_row = config_get( 'filter_custom_fields_per_row' );
 				$t_num_custom_rows = ceil( count( $t_accessible_custom_fields_ids ) / $t_per_row );
 			}
 		}
 
 		$t_filters_url = 'view_filters_page.php?for_screen=' . $p_for_screen;
 		if( 'advanced' == $t_view_type ) {
 			$t_filters_url = $t_filters_url . '&amp;view_type=advanced';
 		}
 		$t_filters_url = $t_filters_url . '&amp;target_field=';
 
 		$t_show_product_version =  version_should_show_product_version( $t_project_id );
 		$t_show_build = $t_show_product_version && ( config_get( 'enable_product_build' ) == ON );
 
 		# overload handler_id setting if user isn't supposed to see them (ref #6189)
 		if( !access_has_project_level( config_get( 'view_handler_threshold' ), $t_project_id ) ) {
 			$t_filter[FILTER_PROPERTY_HANDLER_ID] = array(
 				META_FILTER_ANY,
 			);
 		}
 		?>
 
 		<tr <?php echo "class=\"" . $t_trclass . "\"";?>>
 			<td class="small-caption" valign="top">
 				<a href="<?php echo $t_filters_url . FILTER_PROPERTY_REPORTER_ID . '[]';?>" id="reporter_id_filter"><?php echo lang_get( 'reporter' )?>:</a>
 			</td>
 			<td class="small-caption" valign="top">
 				<a href="<?php echo $t_filters_url . FILTER_PROPERTY_MONITOR_USER_ID . '[]';?>" id="user_monitor_filter"><?php echo lang_get( 'monitored_by' )?>:</a>
 			</td>
 			<td class="small-caption" valign="top">
 				<a href="<?php echo $t_filters_url . FILTER_PROPERTY_HANDLER_ID . '[]';?>" id="handler_id_filter"><?php echo lang_get( 'assigned_to' )?>:</a>
 			</td>
 			<td colspan="2" class="small-caption" valign="top">
 				<a href="<?php echo $t_filters_url . FILTER_PROPERTY_CATEGORY . '[]';?>" id="show_category_filter"><?php echo lang_get( 'category' )?>:</a>
 			</td>
 			<td class="small-caption" valign="top">
 				<a href="<?php echo $t_filters_url . FILTER_PROPERTY_SEVERITY_ID . '[]';?>" id="show_severity_filter"><?php echo lang_get( 'severity' )?>:</a>
 			</td>
 			<td class="small-caption" valign="top">
 				<a href="<?php echo $t_filters_url . FILTER_PROPERTY_RESOLUTION_ID . '[]';?>" id="show_resolution_filter"><?php echo lang_get( 'resolution' )?>:</a>
 			</td>
 			<td class="small-caption" valign="top">
 				<?php if( ON == config_get( 'enable_profiles' ) ) { ?>
 					<a href="<?php echo $t_filters_url . 'show_profile[]';?>" id="show_profile_filter"><?php echo lang_get( 'profile' )?>:</a>
 				<?php } ?>
 			</td>
 			<?php if( $t_filter_cols > 8 ) {
 			echo '<td class="small-caption" valign="top" colspan="' . ( $t_filter_cols - 8 ) . '">&#160;</td>';
 		}?>
 		</tr>
 
 		<tr class="row-1">
 			<td class="small-caption" valign="top" id="reporter_id_filter_target">
 							<?php
 								$t_output = '';
 		$t_any_found = false;
 		if( count( $t_filter[FILTER_PROPERTY_REPORTER_ID] ) == 0 ) {
 			echo lang_get( 'any' );
 		} else {
 			$t_first_flag = true;
 			foreach( $t_filter[FILTER_PROPERTY_REPORTER_ID] as $t_current ) {
 				$t_this_name = '';
-				echo '<input type="hidden" name="', FILTER_PROPERTY_REPORTER_ID, '[]" value="', $t_current, '" />';
+				echo '<input type="hidden" name="', FILTER_PROPERTY_REPORTER_ID, '[]" value="', string_attribute( $t_current ), '" />';
 				if( filter_field_is_any( $t_current ) ) {
 					$t_any_found = true;
 				}
 				else if( filter_field_is_myself( $t_current ) ) {
 					if( access_has_project_level( config_get( 'report_bug_threshold' ) ) ) {
 						$t_this_name = '[' . lang_get( 'myself' ) . ']';
 					} else {
 						$t_any_found = true;
 					}
 				} else if( filter_field_is_none( $t_current ) ) {
 					$t_this_name = lang_get( 'none' );
 				} else {
 					$t_this_name = user_get_name( $t_current );
 				}
 				if( $t_first_flag != true ) {
 					$t_output = $t_output . '<br />';
 				} else {
 					$t_first_flag = false;
 				}
-				$t_output = $t_output . $t_this_name;
+				$t_output = $t_output . string_display_line( $t_this_name );
 			}
 			if( true == $t_any_found ) {
 				echo lang_get( 'any' );
 			} else {
-				echo string_display( $t_output );
+				echo $t_output;
 			}
 		}
 		?>
 			</td>
 			<td class="small-caption" valign="top" id="user_monitor_filter_target">
 							<?php
 								$t_output = '';
 		$t_any_found = false;
 		if( count( $t_filter[FILTER_PROPERTY_MONITOR_USER_ID] ) == 0 ) {
 			echo lang_get( 'any' );
 		} else {
 			$t_first_flag = true;
 			foreach( $t_filter[FILTER_PROPERTY_MONITOR_USER_ID] as $t_current ) {
-				echo '<input type="hidden" name="', FILTER_PROPERTY_MONITOR_USER_ID, '[]" value="', $t_current, '" />';
+				echo '<input type="hidden" name="', FILTER_PROPERTY_MONITOR_USER_ID, '[]" value="', string_attribute( $t_current ), '" />';
 				$t_this_name = '';
 				if( filter_field_is_any( $t_current ) ) {
 					$t_any_found = true;
 				}
 				else if( filter_field_is_myself( $t_current ) ) {
 					if( access_has_project_level( config_get( 'monitor_bug_threshold' ) ) ) {
 						$t_this_name = '[' . lang_get( 'myself' ) . ']';
 					} else {
 						$t_any_found = true;
 					}
 				} else {
 					$t_this_name = user_get_name( $t_current );
 				}
 				if( $t_first_flag != true ) {
 					$t_output = $t_output . '<br />';
 				} else {
 					$t_first_flag = false;
 				}
-				$t_output = $t_output . $t_this_name;
+				$t_output = $t_output . string_display_line( $t_this_name );
 			}
 			if( true == $t_any_found ) {
 				echo lang_get( 'any' );
 			} else {
 				echo string_display( $t_output );
 			}
 		}
 		?>
 			</td>
 			<td class="small-caption" valign="top" id="handler_id_filter_target">
 							<?php
 								$t_output = '';
 		$t_any_found = false;
 		if( count( $t_filter[FILTER_PROPERTY_HANDLER_ID] ) == 0 ) {
 			echo lang_get( 'any' );
 		} else {
 			$t_first_flag = true;
 			foreach( $t_filter[FILTER_PROPERTY_HANDLER_ID] as $t_current ) {
-				echo '<input type="hidden" name="', FILTER_PROPERTY_HANDLER_ID, '[]" value="', $t_current, '" />';
+				echo '<input type="hidden" name="', FILTER_PROPERTY_HANDLER_ID, '[]" value="', string_attribute( $t_current ), '" />';
 				$t_this_name = '';
 				if( filter_field_is_none( $t_current ) ) {
 					$t_this_name = lang_get( 'none' );
 				} else if( filter_field_is_any( $t_current ) ) {
 					$t_any_found = true;
 				} else if( filter_field_is_myself( $t_current ) ) {
 					if( access_has_project_level( config_get( 'handle_bug_threshold' ) ) ) {
 						$t_this_name = '[' . lang_get( 'myself' ) . ']';
 					} else {
 						$t_any_found = true;
 					}
 				} else {
 					$t_this_name = user_get_name( $t_current );
 				}
 				if( $t_first_flag != true ) {
 					$t_output = $t_output . '<br />';
 				} else {
 					$t_first_flag = false;
 				}
-				$t_output = $t_output . $t_this_name;
+				$t_output = $t_output . string_display_line( $t_this_name );
 			}
 			if( true == $t_any_found ) {
 				echo lang_get( 'any' );
 			} else {
 				echo string_display( $t_output );
 			}
 		}
 		?>
 			</td>
 			<td colspan="2" class="small-caption" valign="top" id="show_category_filter_target">
 							<?php
 								$t_output = '';
 		$t_any_found = false;
 		if( count( $t_filter[FILTER_PROPERTY_CATEGORY] ) == 0 ) {
 			echo lang_get( 'any' );
 		} else {
 			$t_first_flag = true;
 			foreach( $t_filter[FILTER_PROPERTY_CATEGORY] as $t_current ) {
-				echo '<input type="hidden" name="', FILTER_PROPERTY_CATEGORY, '[]" value="', $t_current, '" />';
+				echo '<input type="hidden" name="', FILTER_PROPERTY_CATEGORY, '[]" value="', string_attribute( $t_current ), '" />';
 				$t_this_string = '';
 				if( filter_field_is_any( $t_current ) ) {
 					$t_any_found = true;
 				} else {
-					$t_this_string = string_display( $t_current );
+					$t_this_string = $t_current;
 				}
 				if( $t_first_flag != true ) {
 					$t_output = $t_output . '<br />';
 				} else {
 					$t_first_flag = false;
 				}
-				$t_output = $t_output . $t_this_string;
+				$t_output = $t_output . string_display_line( $t_this_string );
 			}
 			if( true == $t_any_found ) {
 				echo lang_get( 'any' );
 			} else {
 				echo $t_output;
 			}
 		}
 		?>
 			</td>
 			<td class="small-caption" valign="top" id="show_severity_filter_target">
 							<?php
 								$t_output = '';
 		$t_any_found = false;
 		if( count( $t_filter[FILTER_PROPERTY_SEVERITY_ID] ) == 0 ) {
 			echo lang_get( 'any' );
 		} else {
 			$t_first_flag = true;
 			foreach( $t_filter[FILTER_PROPERTY_SEVERITY_ID] as $t_current ) {
-				echo '<input type="hidden" name="', FILTER_PROPERTY_SEVERITY_ID, '[]" value="', $t_current, '" />';
+				echo '<input type="hidden" name="', FILTER_PROPERTY_SEVERITY_ID, '[]" value="', string_attribute( $t_current ), '" />';
 				$t_this_string = '';
 				if( filter_field_is_any( $t_current ) ) {
 					$t_any_found = true;
 				} else {
 					$t_this_string = get_enum_element( 'severity', $t_current );
 				}
 				if( $t_first_flag != true ) {
 					$t_output = $t_output . '<br />';
 				} else {
 					$t_first_flag = false;
 				}
-				$t_output = $t_output . $t_this_string;
+				$t_output = $t_output . string_display_line( $t_this_string );
 			}
 			if( true == $t_any_found ) {
 				echo lang_get( 'any' );
 			} else {
 				echo $t_output;
 			}
 		}
 		?>
 			</td>
 			<td class="small-caption" valign="top" id="show_resolution_filter_target">
 							<?php
 								$t_output = '';
 		$t_any_found = false;
 		if( count( $t_filter[FILTER_PROPERTY_RESOLUTION_ID] ) == 0 ) {
 			echo lang_get( 'any' );
 		} else {
 			$t_first_flag = true;
 			foreach( $t_filter[FILTER_PROPERTY_RESOLUTION_ID] as $t_current ) {
 				?>
-										<input type="hidden" name="show_resolution[]" value="<?php echo $t_current;?>" />
+										<input type="hidden" name="show_resolution[]" value="<?php echo string_attribute( $t_current );?>" />
 										<?php
 										$t_this_string = '';
 				if( filter_field_is_any( $t_current ) ) {
 					$t_any_found = true;
 				} else {
 					$t_this_string = get_enum_element( 'resolution', $t_current );
 				}
 				if( $t_first_flag != true ) {
 					$t_output = $t_output . '<br />';
 				} else {
 					$t_first_flag = false;
 				}
-				$t_output = $t_output . $t_this_string;
+				$t_output = $t_output . string_display_line( $t_this_string );
 			}
 			if( true == $t_any_found ) {
 				echo lang_get( 'any' );
 			} else {
 				echo $t_output;
 			}
 		}
 		?>
 			</td>
 			<?php if( ON == config_get( 'enable_profiles' ) ) { ?>
 			<td class="small-caption" valign="top" id="show_profile_filter_target">
 							<?php
 								$t_output = '';
 		$t_any_found = false;
 		if( count( $t_filter['show_profile'] ) == 0 ) {
 			echo lang_get( 'any' );
 		} else {
 			$t_first_flag = true;
 			foreach( $t_filter['show_profile'] as $t_current ) {
 				?>
-										<input type="hidden" name="show_profile[]" value="<?php echo $t_current;?>" />
+										<input type="hidden" name="show_profile[]" value="<?php echo string_attribute( $t_current );?>" />
 										<?php
 										$t_this_string = '';
 				if( filter_field_is_any( $t_current ) ) {
 					$t_any_found = true;
 				} else {
 					$t_profile = profile_get_row_direct( $t_current );
 
 					$t_this_string = "${t_profile['platform']} ${t_profile['os']} ${t_profile['os_build']}";
 				}
 				if( $t_first_flag != true ) {
 					$t_output = $t_output . '<br />';
 				} else {
 					$t_first_flag = false;
 				}
-				$t_output = $t_output . $t_this_string;
+				$t_output = $t_output . string_display_line( $t_this_string );
 			}
 			if( true == $t_any_found ) {
 				echo lang_get( 'any' );
 			} else {
 				echo $t_output;
 			}
 		}
 		?>
 			</td>
 			<?php } else { ?>
 				<td></td>
 			<?php }
 				  if( $t_filter_cols > 8 ) {
 			echo '<td class="small-caption" valign="top" colspan="' . ( $t_filter_cols - 8 ) . '">&#160;</td>';
 		}?>
 			</tr>
 
 		<tr <?php echo "class=\"" . $t_trclass . "\"";?>>
 			<td class="small-caption" valign="top">
 				<a href="<?php echo $t_filters_url . FILTER_PROPERTY_STATUS_ID . '[]';?>" id="show_status_filter"><?php echo lang_get( 'status' )?>:</a>
 			</td>
 			<td class="small-caption" valign="top">
 				<?php if( 'simple' == $t_view_type ) {?>
 					<a href="<?php echo $t_filters_url . FILTER_PROPERTY_HIDE_STATUS_ID . '[]';?>" id="hide_status_filter"><?php echo lang_get( 'hide_status' )?>:</a>
 				<?php
 		}?>
 			</td>
 			<td class="small-caption" valign="top">
 			<?php if ( $t_show_build ) { ?>
 				<a href="<?php echo $t_filters_url . FILTER_PROPERTY_PRODUCT_BUILD . '[]';?>" id="show_build_filter"><?php echo lang_get( 'product_build' )?>:</a>
 			<?php } ?>
 			</td>
 			<?php if( $t_show_product_version ) {?>
 			<td colspan="2" class="small-caption" valign="top">
 				<a href="<?php echo $t_filters_url . FILTER_PROPERTY_PRODUCT_VERSION . '[]';?>" id="show_version_filter"><?php echo lang_get( 'product_version' )?>:</a>
 			</td>
 			<td colspan="1" class="small-caption" valign="top">
 				<a href="<?php echo $t_filters_url . FILTER_PROPERTY_FIXED_IN_VERSION . '[]';?>" id="show_fixed_in_version_filter"><?php echo lang_get( 'fixed_in_version' )?>:</a>
 			</td>
 			<td colspan="1" class="small-caption" valign="top">
 				<a href="<?php echo $t_filters_url . FILTER_PROPERTY_TARGET_VERSION . '[]';?>" id="show_target_version_filter"><?php echo lang_get( 'target_version' )?>:</a>
 			</td>
 			<?php
 		} else {?>
 			<td colspan="2" class="small-caption" valign="top">
 				&#160;
 			</td>
 			<td colspan="1" class="small-caption" valign="top">
 				&#160;
 			</td>
 			<td colspan="1" class="small-caption" valign="top">
 				&nbsp;
 			</td>
 			<?php
 		}?>
 			<td colspan="1" class="small-caption" valign="top">
 				<a href="<?php echo $t_filters_url . FILTER_PROPERTY_PRIORITY_ID . '[]';?>" id="show_priority_filter"><?php echo lang_get( 'priority' )?>:</a>
 			</td>
 			<?php if( $t_filter_cols > 8 ) {
 			echo '<td class="small-caption" valign="top" colspan="' . ( $t_filter_cols - 7 ) . '">&#160;</td>';
 		}?>
 		</tr>
 
 		<tr class="row-1">
 			<td class="small-caption" valign="top" id="show_status_filter_target">
 							<?php
 								$t_output = '';
 		$t_any_found = false;
 		if( count( $t_filter[FILTER_PROPERTY_STATUS_ID] ) == 0 ) {
 			echo lang_get( 'any' );
 		} else {
 			$t_first_flag = true;
 			foreach( $t_filter[FILTER_PROPERTY_STATUS_ID] as $t_current ) {
-				echo '<input type="hidden" name="', FILTER_PROPERTY_STATUS_ID, '[]" value="', $t_current, '" />';
+				echo '<input type="hidden" name="', FILTER_PROPERTY_STATUS_ID, '[]" value="', string_attribute( $t_current ), '" />';
 				$t_this_string = '';
 				if( filter_field_is_any( $t_current ) ) {
 					$t_any_found = true;
 				} else {
 					$t_this_string = get_enum_element( 'status', $t_current );
 				}
 				if( $t_first_flag != true ) {
 					$t_output = $t_output . '<br />';
 				} else {
 					$t_first_flag = false;
 				}
-				$t_output = $t_output . $t_this_string;
+				$t_output = $t_output . string_display_line( $t_this_string );
 			}
 			if( true == $t_any_found ) {
 				echo lang_get( 'any' );
 			} else {
 				echo $t_output;
 			}
 		}
 		?>
 			</td>
 			<td class="small-caption" valign="top" id="hide_status_filter_target">
 							<?php
 								if( 'simple' == $t_view_type ) {
 			$t_output = '';
 			$t_none_found = false;
 			if( count( $t_filter[FILTER_PROPERTY_HIDE_STATUS_ID] ) == 0 ) {
 				echo lang_get( 'none' );
 			} else {
 				$t_first_flag = true;
 				foreach( $t_filter[FILTER_PROPERTY_HIDE_STATUS_ID] as $t_current ) {
-					echo '<input type="hidden" name="', FILTER_PROPERTY_HIDE_STATUS_ID, '[]" value="', $t_current, '" />';
+					echo '<input type="hidden" name="', FILTER_PROPERTY_HIDE_STATUS_ID, '[]" value="', string_attribute( $t_current ), '" />';
 					$t_this_string = '';
 					if( filter_field_is_none( $t_current ) ) {
 						$t_none_found = true;
 					} else {
 						$t_this_string = get_enum_element( 'status', $t_current );
 					}
 					if( $t_first_flag != true ) {
 						$t_output = $t_output . '<br />';
 					} else {
 						$t_first_flag = false;
 					}
-					$t_output = $t_output . $t_this_string;
+					$t_output = $t_output . string_display_line( $t_this_string );
 				}
 				$t_hide_status_post = '';
 				if( count( $t_filter[FILTER_PROPERTY_HIDE_STATUS_ID] ) == 1 ) {
 					$t_hide_status_post = ' (' . lang_get( 'and_above' ) . ')';
 				}
 				if( true == $t_none_found ) {
 					echo lang_get( 'none' );
 				} else {
-					echo $t_output . $t_hide_status_post;
+					echo $t_output . string_display_line( $t_hide_status_post );
 				}
 			}
 		}
 		?>
 			</td>
 			<?php if ( $t_show_build ) { ?>
 			<td class="small-caption" valign="top" id="show_build_filter_target">
 							<?php
 								$t_output = '';
 		$t_any_found = false;
 		if( count( $t_filter[FILTER_PROPERTY_PRODUCT_BUILD] ) == 0 ) {
 			echo lang_get( 'any' );
 		} else {
 			$t_first_flag = true;
 			foreach( $t_filter[FILTER_PROPERTY_PRODUCT_BUILD] as $t_current ) {
 				$t_current = stripslashes( $t_current );
-				echo '<input type="hidden" name="', FILTER_PROPERTY_PRODUCT_BUILD, '[]" value="', string_display( $t_current ), '" />';
+				echo '<input type="hidden" name="', FILTER_PROPERTY_PRODUCT_BUILD, '[]" value="', string_attribute( $t_current ), '" />';
 				$t_this_string = '';
 				if( filter_field_is_any( $t_current ) ) {
 					$t_any_found = true;
 				} else if( filter_field_is_none( $t_current ) ) {
 					$t_this_string = lang_get( 'none' );
 				} else {
-					$t_this_string = string_display( $t_current );
+					$t_this_string = $t_current;
 				}
 				if( $t_first_flag != true ) {
 					$t_output = $t_output . '<br />';
 				} else {
 					$t_first_flag = false;
 				}
-				$t_output = $t_output . $t_this_string;
+				$t_output = $t_output . string_display_line( $t_this_string );
 			}
 			if( true == $t_any_found ) {
 				echo lang_get( 'any' );
 			} else {
 				echo $t_output;
 			}
 		}
 		?>
 			</td>
 			<?php } else { ?>
 			<td class="small-caption" valign="top"></td>
 			<?php }
 				if( $t_show_product_version ) {
 			?>
 			<td colspan="2" class="small-caption" valign="top" id="show_version_filter_target">
 							<?php
 								$t_output = '';
 			$t_any_found = false;
 			if( count( $t_filter[FILTER_PROPERTY_PRODUCT_VERSION] ) == 0 ) {
 				echo lang_get( 'any' );
 			} else {
 				$t_first_flag = true;
 				foreach( $t_filter[FILTER_PROPERTY_PRODUCT_VERSION] as $t_current ) {
 					$t_current = stripslashes( $t_current );
-					echo '<input type="hidden" name="', FILTER_PROPERTY_PRODUCT_VERSION, '[]" value="', string_display( $t_current ), '" />';
+					echo '<input type="hidden" name="', FILTER_PROPERTY_PRODUCT_VERSION, '[]" value="', string_attribute( $t_current ), '" />';
 					$t_this_string = '';
 					if( filter_field_is_any( $t_current ) ) {
 						$t_any_found = true;
 					}
 					else if( filter_field_is_none( $t_current ) ) {
 						$t_this_string = lang_get( 'none' );
 					} else {
-						$t_this_string = string_display( $t_current );
+						$t_this_string = $t_current;
 					}
 					if( $t_first_flag != true ) {
 						$t_output = $t_output . '<br />';
 					} else {
 						$t_first_flag = false;
 					}
-					$t_output = $t_output . $t_this_string;
+					$t_output = $t_output . string_display_line( $t_this_string );
 				}
 				if( true == $t_any_found ) {
 					echo lang_get( 'any' );
 				} else {
 					echo $t_output;
 				}
 			}
 			?>
 			</td>
 			<td colspan="1" class="small-caption" valign="top" id="show_fixed_in_version_filter_target">
 							<?php
 								$t_output = '';
 			$t_any_found = false;
 			if( count( $t_filter[FILTER_PROPERTY_FIXED_IN_VERSION] ) == 0 ) {
 				echo lang_get( 'any' );
 			} else {
 				$t_first_flag = true;
 				foreach( $t_filter[FILTER_PROPERTY_FIXED_IN_VERSION] as $t_current ) {
 					$t_current = stripslashes( $t_current );
-					echo '<input type="hidden" name="', FILTER_PROPERTY_FIXED_IN_VERSION, '[]" value="', string_display( $t_current ), '" />';
+					echo '<input type="hidden" name="', FILTER_PROPERTY_FIXED_IN_VERSION, '[]" value="', string_attribute( $t_current ), '" />';
 					$t_this_string = '';
 					if( filter_field_is_any( $t_current ) ) {
 						$t_any_found = true;
 					} else if( filter_field_is_none( $t_current ) ) {
 						$t_this_string = lang_get( 'none' );
 					} else {
-						$t_this_string = string_display( $t_current );
+						$t_this_string = $t_current;
 					}
 					if( $t_first_flag != true ) {
 						$t_output = $t_output . '<br />';
 					} else {
 						$t_first_flag = false;
 					}
-					$t_output = $t_output . $t_this_string;
+					$t_output = $t_output . string_display_line( $t_this_string );
 				}
 				if( true == $t_any_found ) {
 					echo lang_get( 'any' );
 				} else {
 					echo $t_output;
 				}
 			}
 			?>
 			</td>
 				<td colspan="1" class="small-caption" valign="top" id="show_target_version_filter_target">
 								<?php
 									$t_output = '';
 			$t_any_found = false;
 			if( count( $t_filter[FILTER_PROPERTY_TARGET_VERSION] ) == 0 ) {
 				echo lang_get( 'any' );
 			} else {
 				$t_first_flag = true;
 				foreach( $t_filter[FILTER_PROPERTY_TARGET_VERSION] as $t_current ) {
 					$t_current = stripslashes( $t_current );
-					echo '<input type="hidden" name="', FILTER_PROPERTY_TARGET_VERSION, '[]" value="', string_display( $t_current ), '" />';
+					echo '<input type="hidden" name="', FILTER_PROPERTY_TARGET_VERSION, '[]" value="', string_attribute( $t_current ), '" />';
 					$t_this_string = '';
 					if( filter_field_is_any( $t_current ) ) {
 						$t_any_found = true;
 					} else if( filter_field_is_none( $t_current ) ) {
 						$t_this_string = lang_get( 'none' );
 					} else {
-						$t_this_string = string_display( $t_current );
+						$t_this_string = $t_current;
 					}
 					if( $t_first_flag != true ) {
 						$t_output = $t_output . '<br />';
 					} else {
 						$t_first_flag = false;
 					}
-					$t_output = $t_output . $t_this_string;
+					$t_output = $t_output . string_display_line( $t_this_string );
 				}
 				if( true == $t_any_found ) {
 					echo lang_get( 'any' );
 				} else {
 					echo $t_output;
 				}
 			}
 			?>
 				</td>
 			<?php
 		} else {?>
 			<td colspan="2" class="small-caption" valign="top">
 				&#160;
 			</td>
 			<td colspan="1" class="small-caption" valign="top">
 				&#160;
 			</td>
 			<td colspan="1" class="small-caption" valign="top">
 				&nbsp;
 			</td>
 			<?php
 		}?>
 			<td colspan="1" class="small-caption" valign="top" id="show_priority_filter_target">
               <?php
 							  $t_output = '';
 		$t_any_found = false;
 		if( count( $t_filter[FILTER_PROPERTY_PRIORITY_ID] ) == 0 ) {
 			echo lang_get( 'any' );
 		} else {
 			$t_first_flag = true;
 			foreach( $t_filter[FILTER_PROPERTY_PRIORITY_ID] as $t_current ) {
-				echo '<input type="hidden" name="', FILTER_PROPERTY_PRIORITY_ID, '[]" value="', $t_current, '" />';
+				echo '<input type="hidden" name="', FILTER_PROPERTY_PRIORITY_ID, '[]" value="', string_attribute( $t_current ), '" />';
 				$t_this_string = '';
 				if( filter_field_is_any( $t_current ) ) {
 					$t_any_found = true;
 				} else {
 					$t_this_string = get_enum_element( 'priority', $t_current );
 				}
 				if( $t_first_flag != true ) {
 					$t_output = $t_output . '<br />';
 				} else {
 					$t_first_flag = false;
 				}
-				$t_output = $t_output . $t_this_string;
+				$t_output = $t_output . string_display_line( $t_this_string );
 			}
 			if( true == $t_any_found ) {
 				echo lang_get( 'any' );
 			} else {
 				echo $t_output;
 			}
 		}
 		?>
 	    	</td>
 			<?php if( $t_filter_cols > 8 ) {
 			echo '<td class="small-caption" valign="top" colspan="' . ( $t_filter_cols - 7 ) . '">&#160;</td>';
 		}?>
 
 		</tr>
 
 		<tr <?php echo "class=\"" . $t_trclass . "\"";?>>
 			<td class="small-caption" valign="top">
 				<a href="<?php echo $t_filters_url . FILTER_PROPERTY_ISSUES_PER_PAGE;?>" id="per_page_filter"><?php echo lang_get( 'show' )?>:</a>
 			</td>
 			<td class="small-caption" valign="top">
 				<a href="<?php echo $t_filters_url . FILTER_PROPERTY_VIEW_STATE_ID;?>" id="view_state_filter"><?php echo lang_get( 'view_status' )?>:</a>
 			</td>
 			<td class="small-caption" valign="top">
 				<a href="<?php echo $t_filters_url . FILTER_PROPERTY_SHOW_STICKY_ISSUES;?>" id="sticky_issues_filter"><?php echo lang_get( 'sticky' )?>:</a>
 			</td>
 			<td class="small-caption" valign="top" colspan="2">
 				<a href="<?php echo $t_filters_url . FILTER_PROPERTY_HIGHLIGHT_CHANGED;?>" id="highlight_changed_filter"><?php echo lang_get( 'changed' )?>:</a>
 			</td>
 			<td class="small-caption" valign="top" >
 				<a href="<?php echo $t_filters_url . FILTER_PROPERTY_FILTER_BY_DATE;?>" id="do_filter_by_date_filter"><?php echo lang_get( 'use_date_filters' )?>:</a>
 			</td>
 			<td class="small-caption" valign="top" colspan="2">
 				<a href="<?php echo $t_filters_url . FILTER_PROPERTY_RELATIONSHIP_TYPE;?>" id="relationship_type_filter"><?php echo lang_get( 'bug_relationships' )?>:</a>
 			</td>
 			<?php if( $t_filter_cols > 8 ) {
 			echo '<td class="small-caption" valign="top" colspan="' . ( $t_filter_cols - 8 ) . '">&#160;</td>';
 		}?>
 		</tr>
 		<tr class="row-1">
 			<td class="small-caption" valign="top" id="per_page_filter_target">
 				<?php
-					echo( $t_filter[FILTER_PROPERTY_ISSUES_PER_PAGE] == 0 ) ? lang_get( 'all' ) : $t_filter[FILTER_PROPERTY_ISSUES_PER_PAGE];
-		echo '<input type="hidden" name="', FILTER_PROPERTY_ISSUES_PER_PAGE, '" value="', $t_filter[FILTER_PROPERTY_ISSUES_PER_PAGE], '" />';
+					echo( $t_filter[FILTER_PROPERTY_ISSUES_PER_PAGE] == 0 ) ? lang_get( 'all' ) : string_display_line( $t_filter[FILTER_PROPERTY_ISSUES_PER_PAGE] );
+		echo '<input type="hidden" name="', FILTER_PROPERTY_ISSUES_PER_PAGE, '" value="', string_attribute( $t_filter[FILTER_PROPERTY_ISSUES_PER_PAGE] ), '" />';
 		?>
 			</td>
 			<td class="small-caption" valign="top" id="view_state_filter_target">
 				<?php
 				if( VS_PUBLIC === $t_filter[FILTER_PROPERTY_VIEW_STATE_ID] ) {
 			echo lang_get( 'public' );
 		} else if( VS_PRIVATE === $t_filter[FILTER_PROPERTY_VIEW_STATE_ID] ) {
 			echo lang_get( 'private' );
 		} else {
 			echo lang_get( 'any' );
 			$t_filter[FILTER_PROPERTY_VIEW_STATE_ID] = META_FILTER_ANY;
 		}
-		echo '<input type="hidden" name="', FILTER_PROPERTY_VIEW_STATE_ID, '" value="', $t_filter[FILTER_PROPERTY_VIEW_STATE_ID], '" />';
+		echo '<input type="hidden" name="', FILTER_PROPERTY_VIEW_STATE_ID, '" value="', string_attribute( $t_filter[FILTER_PROPERTY_VIEW_STATE_ID] ), '" />';
 		?>
 			</td>
 			<td class="small-caption" valign="top" id="sticky_issues_filter_target">
 				<?php
 					$t_sticky_filter_state = gpc_string_to_bool( $t_filter[FILTER_PROPERTY_SHOW_STICKY_ISSUES] );
 		print( $t_sticky_filter_state ? lang_get( 'yes' ) : lang_get( 'no' ) );
 		?>
 				<input type="hidden" name="sticky_issues" value="<?php echo $t_sticky_filter_state ? 'on' : 'off';?>" />
 			</td>
 			<td class="small-caption" valign="top" colspan="2" id="highlight_changed_filter_target">
 				<?php
 					echo $t_filter[FILTER_PROPERTY_HIGHLIGHT_CHANGED];
-		echo '<input type="hidden" name="', FILTER_PROPERTY_HIGHLIGHT_CHANGED, '" value="', $t_filter[FILTER_PROPERTY_HIGHLIGHT_CHANGED], '" />';
+		echo '<input type="hidden" name="', FILTER_PROPERTY_HIGHLIGHT_CHANGED, '" value="', string_attribute( $t_filter[FILTER_PROPERTY_HIGHLIGHT_CHANGED] ), '" />';
 		?>
 			</td>
 			<td class="small-caption" valign="top"  id="do_filter_by_date_filter_target">
 							<?php
 							if(( ON == config_get( 'dhtml_filters' ) ) && ( ON == config_get( 'use_javascript' ) ) ) {
 			?>
 		<script type="text/javascript" language="JavaScript">
 		<!--
 			function SwitchDateFields() {
 		    	// All fields need to be enabled to go back to the script
 				document.filters_open.start_month.disabled = ! document.filters_open.do_filter_by_date.checked;
 				document.filters_open.start_day.disabled = ! document.filters_open.do_filter_by_date.checked;
 				document.filters_open.start_year.disabled = ! document.filters_open.do_filter_by_date.checked;
 				document.filters_open.end_month.disabled = ! document.filters_open.do_filter_by_date.checked;
 				document.filters_open.end_day.disabled = ! document.filters_open.do_filter_by_date.checked;
 				document.filters_open.end_year.disabled = ! document.filters_open.do_filter_by_date.checked;
 
 		   		return true;
 			}
 		// -->
 		</script>
 							<?php
 		}
 
 		# end if dhtml_filters
 		if( 'on' == $t_filter[FILTER_PROPERTY_FILTER_BY_DATE] ) {
-			echo '<input type="hidden" name="', FILTER_PROPERTY_FILTER_BY_DATE, '" value="', $t_filter[FILTER_PROPERTY_FILTER_BY_DATE], '" />';
-			echo '<input type="hidden" name="', FILTER_PROPERTY_START_MONTH, '" value="', $t_filter[FILTER_PROPERTY_START_MONTH], '" />';
-			echo '<input type="hidden" name="', FILTER_PROPERTY_START_DAY, '" value="', $t_filter[FILTER_PROPERTY_START_DAY], '" />';
-			echo '<input type="hidden" name="', FILTER_PROPERTY_START_YEAR, '" value="', $t_filter[FILTER_PROPERTY_START_YEAR], '" />';
-			echo '<input type="hidden" name="', FILTER_PROPERTY_END_MONTH, '" value="', $t_filter[FILTER_PROPERTY_END_MONTH], '" />';
-			echo '<input type="hidden" name="', FILTER_PROPERTY_END_DAY, '" value="', $t_filter[FILTER_PROPERTY_END_DAY], '" />';
-			echo '<input type="hidden" name="', FILTER_PROPERTY_END_YEAR, '" value="', $t_filter[FILTER_PROPERTY_END_YEAR], '" />';
+			echo '<input type="hidden" name="', FILTER_PROPERTY_FILTER_BY_DATE, '" value="', string_attribute( $t_filter[FILTER_PROPERTY_FILTER_BY_DATE] ), '" />';
+			echo '<input type="hidden" name="', FILTER_PROPERTY_START_MONTH, '" value="', string_attribute( $t_filter[FILTER_PROPERTY_START_MONTH] ), '" />';
+			echo '<input type="hidden" name="', FILTER_PROPERTY_START_DAY, '" value="', string_attribute( $t_filter[FILTER_PROPERTY_START_DAY] ), '" />';
+			echo '<input type="hidden" name="', FILTER_PROPERTY_START_YEAR, '" value="', string_attribute( $t_filter[FILTER_PROPERTY_START_YEAR] ), '" />';
+			echo '<input type="hidden" name="', FILTER_PROPERTY_END_MONTH, '" value="', string_attribute( $t_filter[FILTER_PROPERTY_END_MONTH] ), '" />';
+			echo '<input type="hidden" name="', FILTER_PROPERTY_END_DAY, '" value="', string_attribute( $t_filter[FILTER_PROPERTY_END_DAY] ), '" />';
+			echo '<input type="hidden" name="', FILTER_PROPERTY_END_YEAR, '" value="', string_attribute( $t_filter[FILTER_PROPERTY_END_YEAR] ), '" />';
 
 			$t_chars = preg_split( '//', config_get( 'short_date_format' ), -1, PREG_SPLIT_NO_EMPTY );
 			$t_time = mktime( 0, 0, 0, $t_filter[FILTER_PROPERTY_START_MONTH], $t_filter[FILTER_PROPERTY_START_DAY], $t_filter[FILTER_PROPERTY_START_YEAR] );
 			foreach( $t_chars as $t_char ) {
 				if( strcasecmp( $t_char, "M" ) == 0 ) {
 					echo ' ';
 					echo date( 'F', $t_time );
 				}
 				if( strcasecmp( $t_char, "D" ) == 0 ) {
 					echo ' ';
 					echo date( 'd', $t_time );
 				}
 				if( strcasecmp( $t_char, "Y" ) == 0 ) {
 					echo ' ';
 					echo date( 'Y', $t_time );
 				}
 			}
 
 			echo ' - ';
 
 			$t_time = mktime( 0, 0, 0, $t_filter[FILTER_PROPERTY_END_MONTH], $t_filter[FILTER_PROPERTY_END_DAY], $t_filter[FILTER_PROPERTY_END_YEAR] );
 			foreach( $t_chars as $t_char ) {
 				if( strcasecmp( $t_char, "M" ) == 0 ) {
 					echo ' ';
 					echo date( 'F', $t_time );
 				}
 				if( strcasecmp( $t_char, "D" ) == 0 ) {
 					echo ' ';
 					echo date( 'd', $t_time );
 				}
 				if( strcasecmp( $t_char, "Y" ) == 0 ) {
 					echo ' ';
 					echo date( 'Y', $t_time );
 				}
 			}
 		} else {
 			echo lang_get( 'no' );
 		}
 		?>
 			</td>
 
 			<td class="small-caption" valign="top" colspan="2" id="relationship_type_filter_target">
 							<?php
-								echo '<input type="hidden" name="', FILTER_PROPERTY_RELATIONSHIP_TYPE, '" value="', $t_filter[FILTER_PROPERTY_RELATIONSHIP_TYPE], '" />';
-		echo '<input type="hidden" name="', FILTER_PROPERTY_RELATIONSHIP_BUG, '" value="', $t_filter[FILTER_PROPERTY_RELATIONSHIP_BUG], '" />';
+								echo '<input type="hidden" name="', FILTER_PROPERTY_RELATIONSHIP_TYPE, '" value="', string_attribute( $t_filter[FILTER_PROPERTY_RELATIONSHIP_TYPE]), '" />';
+		echo '<input type="hidden" name="', FILTER_PROPERTY_RELATIONSHIP_BUG, '" value="', string_attribute( $t_filter[FILTER_PROPERTY_RELATIONSHIP_BUG] ), '" />';
 		$c_rel_type = $t_filter[FILTER_PROPERTY_RELATIONSHIP_TYPE];
 		$c_rel_bug = $t_filter[FILTER_PROPERTY_RELATIONSHIP_BUG];
 		if( -1 == $c_rel_type || 0 == $c_rel_bug ) {
 			echo lang_get( 'any' );
 		} else {
 			echo relationship_get_description_for_history( $c_rel_type ) . ' ' . $c_rel_bug;
 		}
 
 		?>
 			</td>
 			<?php if( $t_filter_cols > 8 ) {
 			echo '<td class="small-caption" valign="top" colspan="' . ( $t_filter_cols - 8 ) . '">&#160;</td>';
 		}?>
 		</tr>
 		<tr <?php echo "class=\"" . $t_trclass . "\"";?>>
 			<td class="small-caption" valign="top">
 				<?php if( ON == config_get( 'enable_profiles' ) ) { ?>
 					<a href="<?php echo $t_filters_url . FILTER_PROPERTY_PLATFORM;?>" id="platform_filter"><?php echo lang_get( 'platform' )?>:</a>
 				<?php } ?>
 			</td>
 			<td class="small-caption" valign="top">
 				<?php if( ON == config_get( 'enable_profiles' ) ) { ?>
 					<a href="<?php echo $t_filters_url . FILTER_PROPERTY_OS;?>" id="os_filter"><?php echo lang_get( 'os' )?>:</a>
 				<?php } ?>
 			</td>
 			<td class="small-caption" valign="top">
 				<?php if( ON == config_get( 'enable_profiles' ) ) { ?>
 					<a href="<?php echo $t_filters_url . FILTER_PROPERTY_OS_BUILD;?>" id="os_build_filter"><?php echo lang_get( 'os_version' )?>:</a>
 				<?php } ?>
 			</td>
 			<td class="small-caption" valign="top" colspan="5">
 				<?php if ( access_has_global_level( config_get( 'tag_view_threshold' ) ) ) { ?>
 				<a href="<?php echo $t_filters_url . FILTER_PROPERTY_TAG_STRING;?>" id="tag_string_filter"><?php echo lang_get( 'tags' )?>:</a>
 				<?php } ?>
 			</td>
 			<?php if( $t_filter_cols > 8 ) {
 			echo '<td class="small-caption" valign="top" colspan="' . ( $t_filter_cols - 8 ) . '">&#160;</td>';
 		}?>
 		</tr>
 		<tr class="row-1">
 			<?php if( ON == config_get( 'enable_profiles' ) ) { ?>
 			<td class="small-caption" valign="top" id="platform_filter_target">
 				<?php
 					print_multivalue_field( FILTER_PROPERTY_PLATFORM, $t_filter[FILTER_PROPERTY_PLATFORM] );
 		?>
 			</td>
 			<td class="small-caption" valign="top" id="os_filter_target">
 				<?php
 					print_multivalue_field( FILTER_PROPERTY_OS, $t_filter[FILTER_PROPERTY_OS] );
 		?>
 			</td>
 			<td class="small-caption" valign="top" id="os_build_filter_target">
 				<?php
 					print_multivalue_field( FILTER_PROPERTY_OS_BUILD, $t_filter[FILTER_PROPERTY_OS_BUILD] );
 		?>
 			</td>
 			<?php } else {?>
 				<td colspan="3">&#160;</td>
 			<?php } ?>
 
 			<td class="small-caption" valign="top" id="tag_string_filter_target" colspan="5">
 				<?php
 					$t_tag_string = $t_filter[FILTER_PROPERTY_TAG_STRING];
 		if( $t_filter[FILTER_PROPERTY_TAG_SELECT] != 0 && tag_exists( $t_filter[FILTER_PROPERTY_TAG_SELECT] ) ) {
 			$t_tag_string .= ( is_blank( $t_tag_string ) ? '' : config_get( 'tag_separator' ) );
 			$t_tag_string .= tag_get_field( $t_filter[FILTER_PROPERTY_TAG_SELECT], 'name' );
 		}
 		echo string_html_entities( $t_tag_string );
 		echo '<input type="hidden" name="', FILTER_PROPERTY_TAG_STRING, '" value="', string_attribute( $t_tag_string ), '" />';
 		?>
 			</td>
 		</tr>
 		<?php
 
 		# get plugin filters
 		$t_plugin_filters = filter_get_plugin_filters();
 		$t_column = 0;
 		$t_fields = '';
 		$t_values = '';
 
 		# output a filter form element for each plugin filter
 		foreach( $t_plugin_filters as $t_field_name => $t_filter_object ) {
-			$t_fields .= '<td class="small-caption" valign="top"> <a href="' . $t_filters_url . $t_field_name .
-				'" id="' . $t_field_name . '_filter">' . string_display_line( $t_filter_object->title ) . '</a> </td>';
+			$t_fields .= '<td class="small-caption" valign="top"> <a href="' . $t_filters_url . string_attribute( $t_field_name ) .
+				'" id="' . string_attribute( $t_field_name ) . '_filter">' . string_display_line( $t_filter_object->title ) . '</a> </td>';
 
-			$t_values .= '<td class="small-caption" valign="top" id="' . $t_field_name . '_filter_target"> ';
+			$t_values .= '<td class="small-caption" valign="top" id="' . string_attribute( $t_field_name ) . '_filter_target"> ';
 
 			if ( !isset( $t_filter[ $t_field_name ] ) ) {
 				$t_values .= lang_get( 'any' );
 			} else {
 				switch( $t_filter_object->type ) {
 					case FILTER_TYPE_STRING:
 					case FILTER_TYPE_INT:
 						if ( filter_field_is_any( $t_filter[ $t_field_name ] ) ) {
 							$t_values .= lang_get( 'any' );
 						} else {
-							$t_values .= string_display( $t_filter[ $t_field_name ] );
+							$t_values .= string_display_line( $t_filter[ $t_field_name ] );
 						}
 						$t_values .= '<input type="hidden" name="' . string_attribute( $t_field_name ) . '" value="' . string_attribute( $t_filter[ $t_field_name ] ) . '"/>';
 						break;
 
 					case FILTER_TYPE_BOOLEAN:
-						$t_values .= string_display( $t_filter_object->display( (bool)$t_filter[ $t_field_name ] ) );
+						$t_values .= string_display_line( $t_filter_object->display( (bool)$t_filter[ $t_field_name ] ) );
 						$t_values .= '<input type="hidden" name="' . string_attribute( $t_field_name ) . '" value="' . (bool)$t_filter[ $t_field_name ] . '"/>';
 						break;
 
 					case FILTER_TYPE_MULTI_STRING:
 					case FILTER_TYPE_MULTI_INT:
 						$t_first = true;
 						$t_output = '';
 
 						if ( !is_array( $t_filter[ $t_field_name ] ) ) {
 							$t_filter[ $t_field_name ] = array( $t_filter[ $t_field_name ] );
 						}
 
 						foreach( $t_filter[ $t_field_name ] as $t_current ) {
 							if ( filter_field_is_any( $t_current ) ) {
 								$t_output .= lang_get( 'any' );
 							} else {
-								$t_output .= ( $t_first ? '' : '<br />' ) . string_display( $t_filter_object->display( $t_current ) );
+								$t_output .= ( $t_first ? '' : '<br />' ) . string_display_line( $t_filter_object->display( $t_current ) );
 								$t_first = false;
 							}
 							$t_values .= '<input type="hidden" name="' . string_attribute( $t_field_name ) . '[]" value="' . string_attribute( $t_current ) . '"/>';
 						}
 
 						$t_values .= $t_output;
 						break;
 				}
 			}
 
 			$t_values .= '</td>';
 
 			$t_column++;
 
 			# wrap at the appropriate column
 			if ( $t_column >= $t_filter_cols ) {
 				echo '<tr class="', $t_trclass, '">', $t_fields, '</tr>';
 				echo '<tr class="row-1">', $t_values, '</tr>';
 
 				$t_fields = '';
 				$t_values = '';
 				$t_column = 0;
 			}
 		}
 
 		# output any remaining plugin filters
 		if ( $t_column > 0 ) {
 			if ( $t_column < $t_filter_cols ) {
 				$t_fields .= '<td class="small-caption" colspan="' . ( $t_filter_cols - $t_column ) . '">&#160;</td>';
 				$t_values .= '<td class="small-caption" colspan="' . ( $t_filter_cols - $t_column ) . '">&#160;</td>';
 			}
 
 			echo '<tr class="', $t_trclass, '">', $t_fields, '</tr>';
 			echo '<tr class="row-1">', $t_values, '</tr>';
 		}
 
 		if( ON == config_get( 'filter_by_custom_fields' ) ) {
 
 			# -- Custom Field Searching --
 
 			if( count( $t_accessible_custom_fields_ids ) > 0 ) {
 				$t_per_row = config_get( 'filter_custom_fields_per_row' );
 				$t_num_fields = count( $t_accessible_custom_fields_ids );
 				$t_row_idx = 0;
 				$t_col_idx = 0;
 
 				$t_fields = '';
 				$t_values = '';
 
 				for( $i = 0;$i < $t_num_fields;$i++ ) {
 					if( $t_col_idx == 0 ) {
 						$t_fields = '<tr class="' . $t_trclass . '">';
 						$t_values = '<tr class="row-1">';
 					}
 
 					if( isset( $t_accessible_custom_fields_names[$i] ) ) {
 						$t_fields .= '<td class="small-caption" valign="top"> ';
 						$t_fields .= '<a href="' . $t_filters_url . 'custom_field_' . $t_accessible_custom_fields_ids[$i] . '[]" id="custom_field_' . $t_accessible_custom_fields_ids[$i] . '_filter">';
-						$t_fields .= string_display( lang_get_defaulted( $t_accessible_custom_fields_names[$i] ) );
+						$t_fields .= string_display_line( lang_get_defaulted( $t_accessible_custom_fields_names[$i] ) );
 						$t_fields .= '</a> </td> ';
 					}
 					$t_output = '';
 					$t_any_found = false;
 
 					$t_values .= '<td class="small-caption" valign="top" id="custom_field_' . $t_accessible_custom_fields_ids[$i] . '_filter_target"> ';
 					if( !isset( $t_filter['custom_fields'][$t_accessible_custom_fields_ids[$i]] ) ) {
 						$t_values .= lang_get( 'any' );
 					} else {
 						if( $t_accessible_custom_fields_types[$i] == CUSTOM_FIELD_TYPE_DATE ) {
 
 							/** @todo moved embedded javascript here from print_filter_custom_field_date
 							 *  it appears not to load properly on Firefox and other browsers if loaded through the httpxmlreq
 							 */
 							$t_field_id = $t_accessible_custom_fields_ids[$i];
 							$t_js_toggle_func = "toggle_custom_date_field_" . $t_field_id . "_controls";
 							if(( ON == config_get( 'dhtml_filters' ) ) && ( ON == config_get( 'use_javascript' ) ) ) {
 								?>
 	<script type="text/javascript" language="JavaScript">
 	<!--
 	function <?php echo $t_js_toggle_func . "_start";?>(disable) {
 			document.filters_open.custom_field_<?php echo $t_field_id;?>_start_year.disabled = disable ;
 			document.filters_open.custom_field_<?php echo $t_field_id;?>_start_month.disabled = disable ;
 			document.filters_open.custom_field_<?php echo $t_field_id;?>_start_day.disabled = disable ;
 	} ;
 
 	function <?php echo $t_js_toggle_func . "_end";?>(disable) {
 			document.filters_open.custom_field_<?php echo $t_field_id;?>_end_year.disabled = disable ;
 			document.filters_open.custom_field_<?php echo $t_field_id;?>_end_month.disabled = disable ;
 			document.filters_open.custom_field_<?php echo $t_field_id;?>_end_day.disabled = disable ;
 	} ;
 
 	function <?php echo $t_js_toggle_func;?>() {
 		switch (document.filters_open.custom_field_<?php echo $t_field_id;?>_control.selectedIndex) {
 		case <?php echo CUSTOM_FIELD_DATE_ANY;?>:
 		case <?php echo CUSTOM_FIELD_DATE_NONE;?>:
 			<?php echo $t_js_toggle_func . "_start";?>(true) ;
 			<?php echo $t_js_toggle_func . "_end";?>(true) ;
 			break ;
 		case <?php echo CUSTOM_FIELD_DATE_BETWEEN;?>:
 			<?php echo $t_js_toggle_func . "_start";?>(false) ;
 			<?php echo $t_js_toggle_func . "_end";?>(false) ;
 			break ;
 		default:
 			<?php echo $t_js_toggle_func . "_start";?>(false) ;
 			<?php echo $t_js_toggle_func . "_end";?>(true) ;
 			break ;
 		}
 	}
 	// -->
 	</script>
 <?php
 							}
 
 							# end if dhtml_filters
 							$t_short_date_format = config_get( 'short_date_format' );
 							if( !isset( $t_filter['custom_fields'][$t_accessible_custom_fields_ids[$i]][1] ) ) {
 								$t_filter['custom_fields'][$t_accessible_custom_fields_ids[$i]][1] = 0;
 							}
 							$t_start = date( $t_short_date_format, $t_filter['custom_fields'][$t_accessible_custom_fields_ids[$i]][1] );
 
 							if( !isset( $t_filter['custom_fields'][$t_accessible_custom_fields_ids[$i]][2] ) ) {
 								$t_filter['custom_fields'][$t_accessible_custom_fields_ids[$i]][2] = 0;
 							}
 							$t_end = date( $t_short_date_format, $t_filter['custom_fields'][$t_accessible_custom_fields_ids[$i]][2] );
 							switch( $t_filter['custom_fields'][$t_accessible_custom_fields_ids[$i]][0] ) {
 								case CUSTOM_FIELD_DATE_ANY:
 									$t_values .= lang_get( 'any' );
 									break;
 								case CUSTOM_FIELD_DATE_NONE:
 									$t_values .= lang_get( 'none' );
 									break;
 								case CUSTOM_FIELD_DATE_BETWEEN:
 									$t_values .= lang_get( 'between_date' ) . '<br />';
 									$t_values .= $t_start . '<br />' . $t_end;
 									break;
 								case CUSTOM_FIELD_DATE_ONORBEFORE:
 									$t_values .= lang_get( 'on_or_before_date' ) . '<br />';
 									$t_values .= $t_end;
 									break;
 								case CUSTOM_FIELD_DATE_BEFORE:
 									$t_values .= lang_get( 'before_date' ) . '<br />';
 									$t_values .= $t_end;
 									break;
 								case CUSTOM_FIELD_DATE_ON:
 									$t_values .= lang_get( 'on_date' ) . '<br />';
 									$t_values .= $t_start;
 									break;
 								case CUSTOM_FIELD_DATE_AFTER:
 									$t_values .= lang_get( 'after_date' ) . '<br />';
 									$t_values .= $t_start;
 									break;
 								case CUSTOM_FIELD_DATE_ONORAFTER:
 									$t_values .= lang_get( 'on_or_after_date' ) . '<br />';
 									$t_values .= $t_start;
 									break;
 							}
 						} else {
 							$t_first_flag = true;
 							foreach( $t_filter['custom_fields'][$t_accessible_custom_fields_ids[$i]] as $t_current ) {
 								$t_current = stripslashes( $t_current );
 								$t_this_string = '';
 								if( filter_field_is_any( $t_current ) ) {
 									$t_any_found = true;
 								} else if( filter_field_is_none( $t_current ) ) {
 									$t_this_string = lang_get( 'none' );
 								} else {
-									$t_this_string = string_display( $t_current );
+									$t_this_string = $t_current;
 								}
 
 								if( $t_first_flag != true ) {
 									$t_output = $t_output . '<br />';
 								} else {
 									$t_first_flag = false;
 								}
 
-								$t_output = $t_output . $t_this_string;
-								$t_values .= '<input type="hidden" name="custom_field_' . $t_accessible_custom_fields_ids[$i] . '[]" value="' . string_display( $t_current ) . '" />';
+								$t_output = $t_output . string_display_line( $t_this_string );
+								$t_values .= '<input type="hidden" name="custom_field_' . $t_accessible_custom_fields_ids[$i] . '[]" value="' . string_attribute( $t_current ) . '" />';
 							}
 						}
 
 						if( true == $t_any_found ) {
 							$t_values .= lang_get( 'any' );
 						} else {
 							$t_values .= $t_output;
 						}
 					}
 					$t_values .= ' </td>';
 
 					$t_col_idx++;
 
 					if( $t_col_idx == $t_per_row ) {
 						if( $t_filter_cols > $t_per_row ) {
 							$t_fields .= '<td colspan="' . ( $t_filter_cols - $t_per_row ) . '">&#160;</td> ';
 							$t_values .= '<td colspan="' . ( $t_filter_cols - $t_per_row ) . '">&#160;</td> ';
 						}
 
 						$t_fields .= '</tr>' . "\n";
 						$t_values .= '</tr>' . "\n";
 
 						echo $t_fields;
 						echo $t_values;
 
 						$t_col_idx = 0;
 						$t_row_idx++;
 					}
 				}
 
 				if( $t_col_idx > 0 ) {
 					if( $t_col_idx < $t_per_row ) {
 						$t_fields .= '<td colspan="' . ( $t_per_row - $t_col_idx ) . '">&#160;</td> ';
 						$t_values .= '<td colspan="' . ( $t_per_row - $t_col_idx ) . '">&#160;</td> ';
 					}
 
 					if( $t_filter_cols > $t_per_row ) {
 						$t_fields .= '<td colspan="' . ( $t_filter_cols - $t_per_row ) . '">&#160;</td> ';
 						$t_values .= '<td colspan="' . ( $t_filter_cols - $t_per_row ) . '">&#160;</td> ';
 					}
 
 					$t_fields .= '</tr>' . "\n";
 					$t_values .= '</tr>' . "\n";
 
 					echo $t_fields;
 					echo $t_values;
 				}
 			}
 		}
 		?>
 		<tr class="row-1">
 			<td class="small-caption category2" valign="top">
                 <a href="<?php echo $t_filters_url . FILTER_PROPERTY_NOTE_USER_ID;?>" id="note_user_id_filter"><?php echo lang_get( 'note_user_id' )?>:</a>
             </td>
             <td class="small-caption" valign="top" id="note_user_id_filter_target">
                 <?php
                     $t_output = '';
 		$t_any_found = false;
 		if( count( $t_filter[FILTER_PROPERTY_NOTE_USER_ID] ) == 0 ) {
 			echo lang_get( 'any' );
 		} else {
 			$t_first_flag = true;
 			foreach( $t_filter[FILTER_PROPERTY_NOTE_USER_ID] as $t_current ) {
-				echo '<input type="hidden" name="', FILTER_PROPERTY_NOTE_USER_ID, '[]" value="', $t_current, '" />';
+				echo '<input type="hidden" name="', FILTER_PROPERTY_NOTE_USER_ID, '[]" value="', string_attribute( $t_current ), '" />';
 				$t_this_name = '';
 				if( filter_field_is_none( $t_current ) ) {
 					$t_this_name = lang_get( 'none' );
 				} else if( filter_field_is_any( $t_current ) ) {
 					$t_any_found = true;
 				} else if( filter_field_is_myself( $t_current ) ) {
 					if( access_has_project_level( config_get( 'handle_bug_threshold' ) ) ) {
 						$t_this_name = '[' . lang_get( 'myself' ) . ']';
 					} else {
 						$t_any_found = true;
 					}
 				} else {
 					$t_this_name = user_get_name( $t_current );
 				}
 				if( $t_first_flag != true ) {
 					$t_output = $t_output . '<br />';
 				} else {
 					$t_first_flag = false;
 				}
-				$t_output = $t_output . $t_this_name;
+				$t_output = $t_output . string_display_line( $t_this_name );
 			}
 			if( true == $t_any_found ) {
 				echo lang_get( 'any' );
 			} else {
-				echo string_display( $t_output );
+				$t_output;
 			}
 		}
 		?>
             </td>
 			<td class="small-caption" valign="top">
 				<a href="<?php echo $t_filters_url . 'show_sort';?>" id="show_sort_filter"><?php echo lang_get( 'sort' )?>:</a>
 			</td>
 			<td class="small-caption" valign="top" id="show_sort_filter_target">
 				<?php
 					$t_sort_fields = explode( ',', $t_filter[FILTER_PROPERTY_SORT_FIELD_NAME] );
 		$t_dir_fields = explode( ',', $t_filter[FILTER_PROPERTY_SORT_DIRECTION] );
 
 		for( $i = 0;$i < 2;$i++ ) {
 			if( isset( $t_sort_fields[$i] ) ) {
 				if( 0 < $i ) {
 					echo ', ';
 				}
 				$t_sort = $t_sort_fields[$i];
 				if( strpos( $t_sort, 'custom_' ) === 0 ) {
 					$t_field_name = string_display( lang_get_defaulted( utf8_substr( $t_sort, utf8_strlen( 'custom_' ) ) ) );
 				} else {
 					$t_field_name = string_get_field_name( $t_sort );
 				}
 
 				echo $t_field_name . ' ' . lang_get( 'bugnote_order_' . utf8_strtolower( $t_dir_fields[$i] ) );
-				echo '<input type="hidden" name="', FILTER_PROPERTY_SORT_FIELD_NAME, '_', $i, '" value="', $t_sort_fields[$i], '" />';
-				echo '<input type="hidden" name="', FILTER_PROPERTY_SORT_DIRECTION, '_', $i, '" value="', $t_dir_fields[$i], '" />';
+				echo '<input type="hidden" name="', FILTER_PROPERTY_SORT_FIELD_NAME, '_', $i, '" value="', string_attribute( $t_sort_fields[$i] ), '" />';
+				echo '<input type="hidden" name="', FILTER_PROPERTY_SORT_DIRECTION, '_', $i, '" value="', string_attribute( $t_dir_fields[$i] ), '" />';
 			}
 		}
 		?>
 			</td>
 			<?php
 				if( 'advanced' == $t_view_type ) {
 			?>
 					<td class="small-caption" valign="top" colspan="2">
 						<a href="<?php echo $t_filters_url . FILTER_PROPERTY_PROJECT_ID;?>" id="project_id_filter"><?php echo lang_get( 'email_project' )?>:</a>
 					</td>
 					<td class="small-caption" valign="top"  id="project_id_filter_target">
 						<?php
 							$t_output = '';
 			if( !is_array( $t_filter[FILTER_PROPERTY_PROJECT_ID] ) ) {
 				$t_filter[FILTER_PROPERTY_PROJECT_ID] = Array(
 					$t_filter[FILTER_PROPERTY_PROJECT_ID],
 				);
 			}
 			if( count( $t_filter[FILTER_PROPERTY_PROJECT_ID] ) == 0 ) {
 				echo lang_get( 'current' );
 			} else {
 				$t_first_flag = true;
 				foreach( $t_filter[FILTER_PROPERTY_PROJECT_ID] as $t_current ) {
-					echo '<input type="hidden" name="', FILTER_PROPERTY_PROJECT_ID, '[]" value="', $t_current, '" />';
+					echo '<input type="hidden" name="', FILTER_PROPERTY_PROJECT_ID, '[]" value="', string_attribute( $t_current ), '" />';
 					$t_this_name = '';
 					if( META_FILTER_CURRENT == $t_current ) {
 						$t_this_name = lang_get( 'current' );
 					} else {
 						$t_this_name = project_get_name( $t_current, false );
 					}
 					if( $t_first_flag != true ) {
 						$t_output = $t_output . '<br />';
 					} else {
 						$t_first_flag = false;
 					}
 					$t_output = $t_output . string_display_line( $t_this_name );
 				}
 				echo $t_output;
 			}
 			?>
 					</td>
 					<?php
 					if( $t_filter_cols > 6 ) {
 				echo '<td class="small-caption" valign="top" colspan="' . ( $t_filter_cols - 5 ) . '">&#160;</td>';
 			}
 		} else {
 			if( $t_filter_cols > 3 ) {
 				echo '<td class="small-caption" valign="top" colspan="' . ( $t_filter_cols - 2 ) . '">&#160;</td>';
 			}
 		}
 		?>
 		</tr>
 		<?php
 	}
 
 	// expanded
 	?>
 		<tr>
 			<td colspan="2">
 				<?php
 					collapse_icon( 'filter' );
 	echo lang_get( 'search' ) . '&#160;';
-	echo '<input type="text" size="16" name="', FILTER_PROPERTY_FREE_TEXT, '" value="', string_html_specialchars( $t_filter[FILTER_PROPERTY_FREE_TEXT] ), '" />';
+	echo '<input type="text" size="16" name="', FILTER_PROPERTY_FREE_TEXT, '" value="', string_attribute( $t_filter[FILTER_PROPERTY_FREE_TEXT] ), '" />';
 	?>
 
 				<input type="submit" name="filter" class="button-small" value="<?php echo lang_get( 'filter_button' )?>" />
 			</td>
 			</form>
 			<td class="center" colspan="<?php echo( $t_filter_cols - 6 )?>"> <!-- use this label for padding -->
 				<?php
 					if( ON == config_get( 'dhtml_filters' ) ) {
 		$f_switch_view_link = 'view_all_set.php?type=6&view_type=';
 	} else {
 		$f_switch_view_link = 'view_filters_page.php?view_type=';
 	}
 
 	$t_view_filters = config_get( 'view_filters' );
 	if(( SIMPLE_ONLY != $t_view_filters ) && ( ADVANCED_ONLY != $t_view_filters ) ) {
 		if( 'advanced' == $t_view_type ) {
 			print_bracket_link( $f_switch_view_link . 'simple', lang_get( 'simple_filters' ) );
 		} else {
 			print_bracket_link( $f_switch_view_link . 'advanced', lang_get( 'advanced_filters' ) );
 		}
 	}
 
 	if( access_has_project_level( config_get( 'create_permalink_threshold' ) ) ) {
 		print_bracket_link( 'permalink_page.php?url=' . urlencode( filter_get_url( $t_filter ) ), lang_get( 'create_filter_link' ),
 
 		/* new window = */
 		true );
 	}
 	?>
 			</td>
 			<td class="right" colspan="4">
 			<?php
 			$t_stored_queries_arr = array();
 	$t_stored_queries_arr = filter_db_get_available_queries();
 
 	if( count( $t_stored_queries_arr ) > 0 ) {
 		?>
 					<form method="get" name="list_queries<?php echo $t_form_name_suffix;?>" action="view_all_set.php">
 					<?php # CSRF protection not required here - form does not result in modifications ?>
 					<input type="hidden" name="type" value="3" />
 					<?php
 					if( ON == config_get( 'use_javascript' ) ) {
 			echo "<select name=\"source_query_id\" onchange=\"document.forms.list_queries$t_form_name_suffix.submit();\">";
 		} else {
 			echo '<select name="source_query_id">';
 		}
 		?>
 					<option value="-1"><?php echo '[' . lang_get( 'reset_query' ) . ']'?></option>
 					<option value="-1"></option>
 					<?php
 					foreach( $t_stored_queries_arr as $t_query_id => $t_query_name ) {
-			echo '<option value="' . $t_query_id . '">' . $t_query_name . '</option>';
+			echo '<option value="' . string_attribute( $t_query_id ) . '">' . string_display_line( $t_query_name ) . '</option>';
 		}
 		?>
 					</select>
 					<input type="submit" name="switch_to_query_button" class="button-small" value="<?php echo lang_get( 'use_query' )?>" />
 					</form>
 					<form method="post" name="open_queries" action="query_view_page.php">
 					<?php # CSRF protection not required here - form does not result in modifications ?>
 					<input type="submit" name="switch_to_query_button" class="button-small" value="<?php echo lang_get( 'open_queries' )?>" />
 					</form>
 				<?php
 	} else {
 		?>
 					<form method="get" name="reset_query" action="view_all_set.php">
 					<?php # CSRF protection not required here - form does not result in modifications ?>
 					<input type="hidden" name="type" value="3" />
 					<input type="hidden" name="source_query_id" value="-1" />
 					<input type="submit" name="reset_query_button" class="button-small" value="<?php echo lang_get( 'reset_query' )?>" />
 					</form>
 				<?php
 	}
 
 	if( access_has_project_level( config_get( 'stored_query_create_threshold' ) ) ) {
 		?>
 					<form method="post" name="save_query" action="query_store_page.php">
 					<?php # CSRF protection not required here - form does not result in modifications ?>
 					<input type="submit" name="save_query_button" class="button-small" value="<?php echo lang_get( 'save_query' )?>" />
 					</form>
 			<?php
 	}
 	?>
 			</td>
 		</tr>
 		</table>
 <?php
 }
 
 /**
  	 * @internal The following functions each print out filter field inputs.
  *      They are derived from view_filters_page.php
  *      The functions follow a strict naming convention:
  *
  * 		print_filter_[filter_name]
  *
  *      Where [filter_name] is the same as the "name" of the form element for
  *      that filter. This naming convention is depended upon by the controller
  *      at the end of the script.
  *
  * @todo print functions should be abstracted.  Many of these functions
  *      are virtually identical except for the property name.
  *      Perhaps this code could be made simpler by refactoring into a
  *      class so as to avoid all those calls to global(which are pretty ugly)
  *      These functions could also be shared by view_filters_page.php
  */
 
 /**
  *  Print the reporter field
  */
@@ -4265,51 +4265,51 @@ function print_filter_project_id() {
 function print_multivalue_field( $p_field_name, $p_field_value ) {
 	$t_output = '';
 	$t_any_found = false;
 
 	if( count( $p_field_value ) == 0 ) {
 		echo lang_get( 'any' );
 	} else {
 		$t_first_flag = true;
 
 		$t_field_value = is_array( $p_field_value ) ? $p_field_value : array( $p_field_value );
 
 		foreach( $t_field_value as $t_current ) {
 			$t_current = stripslashes( $t_current );
 			?>
-				<input type="hidden" name="<?php echo $p_field_name?>[]" value="<?php echo string_display( $t_current );?>" />
+				<input type="hidden" name="<?php echo string_attribute( $p_field_name )?>[]" value="<?php echo string_attribute( $t_current );?>" />
 				<?php
 				$t_this_string = '';
 
 			if((( $t_current == META_FILTER_ANY ) && ( is_numeric( $t_current ) ) ) || ( is_blank( $t_current ) ) ) {
 				$t_any_found = true;
 			} else {
 				$t_this_string = string_display( $t_current );
 			}
 
 			if( $t_first_flag != true ) {
 				$t_output .= '<br />';
 			} else {
 				$t_first_flag = false;
 			}
 
 			$t_output .= $t_this_string;
 		}
 
 		if( true == $t_any_found ) {
 			echo lang_get( 'any' );
 		} else {
 			echo $t_output;
 		}
 	}
 }
 
 # ==========================================================================
 # CACHING
 # ==========================================================================
 /**
  * @internal SECURITY NOTE: cache globals are initialized here to prevent them
  *      being spoofed if register_globals is turned on.
  * 	We cache filter requests to reduce the number of SQL queries
  * @global mixed $g_cache_filter
  * @global mixed $g_cache_filter_db_filters
  */
