   Flush the command buffer after switching to TLS.
   Fixes a flaw similar to CVE-2011-0411.
 * -Frank.
 */

int sfgets(void)
{
    struct pollfd pfd;
    int pollret;
    ssize_t readnb;
    signed char seen_r = 0;
    static size_t scanned;
    static size_t readnbd;
    
    if (scanned > (size_t) 0U) {       /* support pipelining */
        readnbd -= scanned;        
            addreply_noformat(234, "AUTH TLS OK.");
            doreply();
            if (tls_cnx == NULL) {
                (void) tls_init_new_session();
            }
            goto wayout;
