commit 9e0bbf0c5faa198379d945474f7d55da5031cacf
Author: Jan Pokorny <jpokorny@redhat.com>
Date:   Thu Oct 21 19:42:17 2010 +0200

    Fix rhbz #626504: fake ticket cookie auth. bypass

diff --git a/luci.spec b/luci.spec
index 7d31454..8ac60f1 100644
--- a/luci.spec
+++ b/luci.spec
@@ -41,23 +41,26 @@ cd lucipam && python setup.py install --root %{buildroot};  cd ..
 rm -rf %{buildroot}
 
 %files
 %defattr(-,root,root,-)
 %doc README.txt COPYING
 %{python_sitelib}/%{name}-%{version}-py%{pyver}.egg-info/
 %{python_sitelib}/%{name}/
 %{python_sitelib_arch}/LuciPAM-1.0-py%{pyver}.egg-info
 %{python_sitelib_arch}/lucipam.so
 
 %config(noreplace)      /etc/pam.d/luci
 %config(noreplace)      %{_localstatedir}/lib/luci/etc/luci.ini
 %attr(0600,luci,luci)   %{_localstatedir}/lib/luci/etc/luci.ini
 %config(noreplace)      %{_localstatedir}/lib/luci/etc/cacert.config
 %attr(0600,luci,luci)   %{_localstatedir}/lib/luci/etc/cacert.config
 %attr(0750,luci,luci)   %{_localstatedir}/lib/luci
 %config(noreplace)      %{_sysconfdir}/rc.d/init.d/luci
 %attr(750, luci, luci)  %dir /var/log/luci
 
+# We alter this file in %post - it is not user serviceable.
+%verify(not md5 mtime size) %{_localstatedir}/lib/luci/etc/who.ini
+
 %pre
 /usr/sbin/groupadd -g 141 luci 2> /dev/null
 /usr/sbin/useradd -u 141 -g 141 -d /var/lib/luci -s /sbin/nologin -r \
         -c "luci user" luci 2> /dev/null
@@ -65,6 +68,9 @@ exit 0
 
 %post
 /sbin/chkconfig --add luci
+secret="$(dd if=/dev/urandom bs=8 count=1 2>/dev/null | od -t x8 -A n | sed 's/^[ ]*//')"
+sedcmd=":a /^\[plugin:auth_tkt\]\$/! {p;d;ba}; {:b \$! {N;bb}; {s/\([ \t]*secret[ \t]*=[ \t]*\)[^\n]*/\1$secret/1;p;d}}"
+sed -ni "$sedcmd" %{_localstatedir}/lib/luci/etc/who.ini
 exit 0
 
 %preun
